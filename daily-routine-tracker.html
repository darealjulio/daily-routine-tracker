<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#030712">
<title>Daily Routine Tracker</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRGFpbHkgUm91dGluZSIsInNob3J0X25hbWUiOiJSb3V0aW5lIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMzA3MTIiLCJ0aGVtZV9jb2xvciI6IiMwMzA3MTIifQ==">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg0:#030712;--bg1:#0a1128;--bg2:#0d1b2a;--bg3:#122240;--bg4:#1b2e4a;--b9:#1e3a5f;--b7:#1d4ed8;--b6:#2563eb;--b5:#3b82f6;--b4:#60a5fa;--b3:#93c5fd;--cyan:#22d3ee;--em:#10b981;--rose:#f43f5e;--amber:#f59e0b;--t1:#f0f4ff;--t2:#94a3b8;--t3:#475569;--bd:rgba(59,130,246,.12);--bda:rgba(59,130,246,.4);--glow:rgba(59,130,246,.15);--glowS:rgba(59,130,246,.35);--r1:8px;--r2:14px;--r3:20px;--r4:28px;--sh:0 4px 24px rgba(0,0,0,.4),0 0 0 1px var(--bd);--ff:'Outfit',sans-serif;--fm:'JetBrains Mono',monospace;--accent:var(--b5);--accentD:var(--b6);--accentL:var(--b4)}
[data-theme="light"]{--bg0:#f8fafc;--bg1:#f1f5f9;--bg2:#e2e8f0;--bg3:#cbd5e1;--bg4:#94a3b8;--b9:#64748b;--t1:#0f172a;--t2:#475569;--t3:#94a3b8;--bd:rgba(59,130,246,.15);--bda:rgba(59,130,246,.3);--glow:rgba(59,130,246,.1);--glowS:rgba(59,130,246,.2);--sh:0 4px 24px rgba(0,0,0,.08),0 0 0 1px var(--bd)}
[data-theme="light"] body::before,[data-theme="light"] body::after{display:none}
[data-theme="light"] .check.on::after{color:#fff}
[data-accent="green"]{--accent:#10b981;--accentD:#059669;--accentL:#34d399}
[data-accent="purple"]{--accent:#8b5cf6;--accentD:#7c3aed;--accentL:#a78bfa}
[data-accent="rose"]{--accent:#f43f5e;--accentD:#e11d48;--accentL:#fb7185}
[data-accent="amber"]{--accent:#f59e0b;--accentD:#d97706;--accentL:#fbbf24}
[data-accent="cyan"]{--accent:#22d3ee;--accentD:#06b6d4;--accentL:#67e8f9}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--ff);background:var(--bg0);min-height:100vh;color:var(--t1);overflow-x:hidden;transition:background .3s,color .3s}
body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse 600px 400px at 20% 20%,rgba(29,78,216,.08) 0%,transparent 70%),radial-gradient(ellipse 500px 500px at 80% 80%,rgba(34,211,238,.04) 0%,transparent 70%);z-index:0;pointer-events:none}
body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(59,130,246,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(59,130,246,.03) 1px,transparent 1px);background-size:60px 60px;z-index:0;pointer-events:none}
.app{position:relative;z-index:1;max-width:640px;margin:0 auto;padding:20px 16px 100px}
.nav-tabs{display:flex;gap:4px;background:var(--bg2);padding:5px;border-radius:var(--r3);border:1px solid var(--bd);margin-bottom:28px;position:sticky;top:10px;z-index:100;backdrop-filter:blur(20px)}
.nav-tab{flex:1;display:flex;align-items:center;justify-content:center;gap:5px;padding:11px 6px;border:none;background:transparent;color:var(--t3);border-radius:var(--r2);cursor:pointer;transition:all .3s;font-family:var(--ff);font-size:.82em;font-weight:600}
.nav-tab:hover{color:var(--accentL);background:var(--glow)}
.nav-tab.active{background:linear-gradient(135deg,var(--accentD),var(--accent));color:#fff;box-shadow:0 4px 16px rgba(37,99,235,.35)}
.header{text-align:center;margin-bottom:32px;padding:10px 0}
.header h1{font-size:2.2em;font-weight:800;letter-spacing:-.03em;background:linear-gradient(135deg,var(--b3),var(--accent),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
.date-time{font-family:var(--fm);font-size:.85em;color:var(--t2);letter-spacing:.04em}
.card{background:var(--bg2);border-radius:var(--r4);padding:32px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:20px;position:relative;overflow:hidden;transition:background .3s,border .3s}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.5}
.card-sm{padding:24px}
.ring-container{position:relative;width:180px;height:180px;margin:0 auto 24px}
.ring-bg{fill:none;stroke:var(--bg4);stroke-width:14}
.ring-progress{fill:none;stroke:url(#blueGrad);stroke-width:14;stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1);filter:drop-shadow(0 0 8px rgba(59,130,246,.4))}
.ring-label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.ring-pct{font-size:2.8em;font-weight:800;letter-spacing:-.04em;line-height:1}
.ring-sub{font-size:.75em;color:var(--t2);font-weight:500;margin-top:4px}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.stat-box{text-align:center;padding:16px 8px;background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);transition:background .3s}
.stat-val{font-size:1.8em;font-weight:700;color:var(--accentL);font-family:var(--fm)}
.stat-lbl{font-size:.75em;color:var(--t2);font-weight:500;margin-top:4px;text-transform:uppercase;letter-spacing:.08em}
.empty-state{text-align:center;padding:60px 20px;background:var(--bg2);border-radius:var(--r4);border:1px dashed var(--bda);margin-bottom:24px}
.empty-state-icon{font-size:3.5em;margin-bottom:16px;opacity:.6}
.empty-state h3{font-size:1.3em;font-weight:700;margin-bottom:8px}
.empty-state p{color:var(--t2);font-size:.95em;max-width:300px;margin:0 auto;line-height:1.5}
.period-section{background:var(--bg2);border-radius:var(--r4);border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:16px;overflow:hidden;transition:background .3s}
.period-header{display:flex;align-items:center;padding:18px 22px;cursor:pointer;user-select:none;transition:background .2s}
.period-header:hover{background:var(--glow)}
.period-emoji{font-size:1.4em;margin-right:12px}.period-name{flex:1;font-size:1.05em;font-weight:700}
.period-badge{font-family:var(--fm);font-size:.8em;font-weight:600;background:var(--bg4);color:var(--accentL);padding:4px 12px;border-radius:20px;border:1px solid var(--bd);margin-right:12px}
.chevron{color:var(--t3);transition:transform .3s;font-size:.8em}.chevron.open{transform:rotate(180deg)}
.task-list{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.4,0,.2,1)}.task-list.open{max-height:2000px}
.task-list-inner{padding:0 14px 14px}
.task-item{display:flex;align-items:center;padding:14px 16px;margin-bottom:6px;background:var(--bg1);border-radius:var(--r2);cursor:pointer;transition:all .25s;border:1px solid transparent;position:relative}
.task-item:hover{background:var(--bg4);border-color:var(--bd);transform:translateX(4px)}
.task-item.done{opacity:.45}.task-item.done .tname-text{text-decoration:line-through}
.task-item.dragging{opacity:.5;border:2px dashed var(--accent);transform:scale(.97)}
.task-item .drag-handle{cursor:grab;padding:4px 6px;margin-right:6px;color:var(--t3);font-size:.9em;opacity:.4;transition:opacity .2s}
.task-item:hover .drag-handle{opacity:1}
.temoji{font-size:1.6em;margin-right:14px;flex-shrink:0}.tinfo{flex:1;min-width:0}
.tname{font-weight:600;font-size:.95em;margin-bottom:3px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.tmeta{font-family:var(--fm);font-size:.78em;color:var(--t3)}
.tnotes{font-size:.78em;color:var(--t3);margin-top:2px;font-style:italic;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tag{display:inline-block;font-size:.65em;font-weight:700;padding:2px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.06em}
.tag-ai{background:rgba(34,211,238,.15);color:var(--cyan)}.tag-date{background:rgba(59,130,246,.15);color:var(--b4)}.tag-sched{background:rgba(16,185,129,.15);color:var(--em)}
.tactions{display:flex;align-items:center;gap:2px;margin-left:8px}
.tbtn{background:none;border:none;color:var(--t3);cursor:pointer;padding:6px 8px;border-radius:6px;font-size:.85em;transition:all .2s}
.tbtn:hover{color:var(--accentL);background:var(--glow)}.tbtn.del:hover{color:var(--rose);background:rgba(244,63,94,.1)}
.check{width:26px;height:26px;border:2px solid var(--b9);border-radius:50%;flex-shrink:0;margin-left:6px;display:flex;align-items:center;justify-content:center;transition:all .3s}
.check.on{background:linear-gradient(135deg,var(--accentD),var(--accent));border-color:var(--accent);box-shadow:0 0 12px rgba(59,130,246,.4)}
.check.on::after{content:'‚úì';color:#fff;font-weight:700;font-size:.85em}
.ai-section{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:16px;position:relative;overflow:hidden;transition:background .3s}
.ai-section::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);opacity:.4}
.ai-label{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.ai-label span:first-child{font-size:1.3em}
.ai-label-text{font-weight:700;font-size:1.05em;background:linear-gradient(135deg,var(--accentL),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.ai-examples{font-size:.78em;color:var(--t3);margin-bottom:14px;line-height:1.7;padding:10px 14px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)}
.ai-examples strong{color:var(--t2)}
.ai-row{display:flex;gap:8px}
.ai-input{flex:1;padding:14px 18px;border:1px solid var(--bd);background:var(--bg1);color:var(--t1);border-radius:var(--r2);font-family:var(--ff);font-size:.92em;transition:all .3s}
.ai-input::placeholder{color:var(--t3)}.ai-input:focus{outline:none;border-color:var(--accent);background:var(--bg2)}
.ibtn{width:50px;height:50px;border:1px solid var(--bd);background:var(--bg1);color:var(--accentL);border-radius:var(--r2);font-size:1.15em;cursor:pointer;transition:all .3s;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.ibtn:hover{background:var(--glow);border-color:var(--accent)}
.ibtn.listening{background:var(--rose);border-color:var(--rose);color:#fff;animation:pmic 1.5s infinite}
@keyframes pmic{0%,100%{box-shadow:0 0 0 0 rgba(244,63,94,.4)}50%{box-shadow:0 0 0 10px rgba(244,63,94,0)}}
.sbtn{padding:0 22px;height:50px;border:none;background:linear-gradient(135deg,var(--accentD),var(--accent));color:#fff;border-radius:var(--r2);font-family:var(--ff);font-weight:700;font-size:.9em;cursor:pointer;transition:all .3s;flex-shrink:0}
.sbtn:hover{box-shadow:0 4px 16px rgba(37,99,235,.4);transform:translateY(-1px)}
.ai-resp{margin-top:14px;padding:14px 18px;background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);font-size:.9em;color:var(--t2);display:none;animation:sUp .3s ease;line-height:1.5}
.ai-resp.show{display:block}.ai-resp.thinking{display:flex;align-items:center;gap:8px;color:var(--accentL);font-weight:600}
@keyframes sUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.tl-section{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:16px;transition:background .3s}
.tl-head{display:flex;justify-content:space-between;align-items:center}
.tl-title{font-weight:700;font-size:1.05em;background:linear-gradient(135deg,var(--accentL),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.togbtn{padding:8px 18px;background:var(--bg1);border:1px solid var(--bd);color:var(--accentL);border-radius:var(--r1);font-family:var(--ff);font-weight:600;font-size:.82em;cursor:pointer;transition:all .3s}
.togbtn:hover{background:var(--glow);border-color:var(--accent)}
.tl-wrap{margin-top:20px;display:none}.tl-wrap.open{display:block}
.timeline{position:relative;padding:10px 0}
.timeline::before{content:'';position:absolute;left:42px;top:0;bottom:0;width:2px;background:linear-gradient(180deg,var(--accent),var(--b9),transparent)}
.tl-item{display:flex;align-items:flex-start;margin-bottom:16px;position:relative;animation:fSlide .4s ease both}
@keyframes fSlide{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
.tl-time{width:70px;text-align:right;padding-right:16px;font-family:var(--fm);font-size:.78em;font-weight:600;color:var(--accentL);padding-top:2px;flex-shrink:0}
.tl-dot{width:12px;height:12px;border:2px solid var(--accent);background:var(--bg0);border-radius:50%;position:absolute;left:37px;top:6px;z-index:1}
.tl-dot.dn{background:var(--accent);box-shadow:0 0 10px rgba(59,130,246,.5)}
.tl-card{flex:1;background:var(--bg1);padding:14px 18px;border-radius:var(--r2);margin-left:24px;border:1px solid var(--bd);transition:background .3s}
.tl-card.dn{opacity:.4}.tl-card.ai{border-left:3px solid var(--cyan)}
.tl-cn{font-weight:600;font-size:.95em;display:flex;align-items:center;gap:8px}
.tl-cm{font-size:.8em;color:var(--t3);margin-top:4px}
.empty-tl{text-align:center;padding:30px;color:var(--t3);font-style:italic}
.act-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
.act-btn{padding:16px;border-radius:var(--r2);font-family:var(--ff);font-weight:700;font-size:.92em;cursor:pointer;transition:all .3s;border:1px solid var(--bd)}
.btn-rst{background:var(--bg2);color:var(--t2)}.btn-rst:hover{background:var(--bg4);color:var(--t1)}
.btn-add{background:linear-gradient(135deg,var(--accentD),var(--accent));color:#fff;border:none;box-shadow:0 4px 16px rgba(37,99,235,.3)}
.btn-add:hover{box-shadow:0 6px 24px rgba(37,99,235,.45);transform:translateY(-2px)}
.quote{text-align:center;padding:22px 28px;background:var(--bg2);border-radius:var(--r3);border:1px solid var(--bd);color:var(--t2);font-style:italic;font-size:.95em;line-height:1.6;margin-bottom:20px;transition:background .3s}
/* Modal */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal-bg.show{display:flex}
.modal-box{background:var(--bg2);border:1px solid var(--bda);border-radius:var(--r4);padding:32px;width:100%;max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,.6);position:relative;overflow:hidden;max-height:90vh;overflow-y:auto}
.modal-box::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
.mtitle{font-size:1.4em;font-weight:800;margin-bottom:24px;background:linear-gradient(135deg,var(--b3),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.field{margin-bottom:20px}
.flabel{display:block;font-weight:600;font-size:.85em;color:var(--t2);margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em}
.finput,.fselect{width:100%;padding:13px 16px;background:var(--bg1);border:1px solid var(--bd);color:var(--t1);border-radius:var(--r1);font-family:var(--ff);font-size:.95em;transition:all .3s}
.finput:focus,.fselect:focus{outline:none;border-color:var(--accent);background:var(--bg2)}
.fselect option{background:var(--bg2);color:var(--t1)}
.egrid{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}
.eopt{font-size:1.7em;text-align:center;padding:8px;border-radius:var(--r1);cursor:pointer;transition:all .2s;border:2px solid transparent}
.eopt:hover{background:var(--glow);transform:scale(1.15)}
.eopt.sel{background:var(--glowS);border-color:var(--accent);transform:scale(1.15)}
.mactions{display:flex;gap:10px;margin-top:28px}
.mbtn{flex:1;padding:14px;border-radius:var(--r1);font-family:var(--ff);font-weight:700;font-size:.95em;cursor:pointer;transition:all .3s}
.mbtn-cancel{background:var(--bg1);border:1px solid var(--bd);color:var(--t2)}.mbtn-cancel:hover{background:var(--bg4);color:var(--t1)}
.mbtn-save{background:linear-gradient(135deg,var(--accentD),var(--accent));border:none;color:#fff}.mbtn-save:hover{box-shadow:0 6px 24px rgba(37,99,235,.5)}
.mbtn-del{background:rgba(244,63,94,.15);border:1px solid rgba(244,63,94,.3);color:var(--rose);flex:0 0 auto;padding:14px 20px}.mbtn-del:hover{background:rgba(244,63,94,.25)}
.day-picker{display:flex;gap:6px;flex-wrap:wrap}
.dp-day{width:42px;height:42px;display:flex;align-items:center;justify-content:center;border-radius:var(--r1);border:2px solid var(--bd);background:var(--bg1);color:var(--t2);font-family:var(--fm);font-size:.78em;font-weight:700;cursor:pointer;transition:all .2s;user-select:none}
.dp-day:hover{border-color:var(--accent);color:var(--accentL)}
.dp-day.on{background:var(--glowS);border-color:var(--accent);color:var(--t1)}
/* Calendar */
.cal-hdr{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;background:var(--bg2);border-radius:var(--r4);border:1px solid var(--bd);margin-bottom:16px;transition:background .3s}
.cal-title{font-size:1.3em;font-weight:800;background:linear-gradient(135deg,var(--b3),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.cal-nav{width:40px;height:40px;background:var(--bg1);border:1px solid var(--bd);color:var(--accentL);border-radius:var(--r1);font-size:1.3em;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center}
.cal-nav:hover{background:var(--glow);border-color:var(--accent)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:20px;background:var(--bg2);border-radius:var(--r4);border:1px solid var(--bd);margin-bottom:16px;transition:background .3s}
.cal-dh{text-align:center;font-family:var(--fm);font-weight:600;font-size:.75em;color:var(--t3);padding:8px;text-transform:uppercase}
.cal-d{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:var(--r1);cursor:pointer;transition:all .25s;border:1px solid transparent;position:relative;background:var(--bg1)}
.cal-d:hover{background:var(--bg4);border-color:var(--bd)}
.cal-d.oth{opacity:.2;cursor:default;background:transparent}.cal-d.oth:hover{background:transparent;border-color:transparent}
.cal-d.tod{border-color:var(--accent);background:var(--glow)}
.cal-d.ht::after{content:'';position:absolute;bottom:4px;width:5px;height:5px;background:var(--accent);border-radius:50%}
.cal-d.ad::after{background:var(--em)}
.cal-dn{font-weight:600;font-size:.95em}
.cal-legend{display:flex;gap:20px;justify-content:center;padding:14px;background:var(--bg2);border-radius:var(--r2);border:1px solid var(--bd);margin-bottom:16px;transition:background .3s}
.leg-item{display:flex;align-items:center;gap:8px;color:var(--t2);font-size:.82em}.leg-dot{width:10px;height:10px;border-radius:50%}
.day-panel{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);margin-top:16px;animation:sUp .3s ease;display:none;transition:background .3s}
.day-panel.show{display:block}
.dp-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.dp-title{font-weight:700;font-size:1.15em;background:linear-gradient(135deg,var(--accentL),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.dp-close{width:32px;height:32px;background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.2);color:var(--rose);border-radius:50%;font-size:1em;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center}
.dp-close:hover{background:rgba(244,63,94,.2);transform:rotate(90deg)}
/* Stats */
.sec-title{font-weight:800;font-size:1.15em;margin-bottom:20px;background:linear-gradient(135deg,var(--b3),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hm-cell{aspect-ratio:1;border-radius:4px;cursor:default;position:relative;transition:transform .15s}
.hm-cell:hover{transform:scale(1.4);z-index:2}
.hm-cell[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg4);color:var(--t1);padding:4px 10px;border-radius:6px;font-size:.7em;white-space:nowrap;z-index:10;border:1px solid var(--bd);font-family:var(--fm);pointer-events:none}
.hm-legend{display:flex;align-items:center;gap:8px;justify-content:flex-end;margin-top:12px;font-size:.72em;color:var(--t3)}
.hm-lcells{display:flex;gap:3px}.hm-lc{width:14px;height:14px;border-radius:3px}
.an-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.an-box{background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);padding:18px;text-align:center;transition:background .3s}
.an-val{font-size:1.6em;font-weight:800;font-family:var(--fm);margin-bottom:4px}
.an-val.blue{color:var(--accentL)}.an-val.cyan{color:var(--cyan)}.an-val.green{color:var(--em)}.an-val.amber{color:var(--amber)}
.an-lbl{font-size:.75em;color:var(--t2);text-transform:uppercase;letter-spacing:.06em;font-weight:600}
.bar-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.bar-label{width:36px;font-family:var(--fm);font-size:.75em;color:var(--t2);font-weight:600;text-align:right;flex-shrink:0}
.bar-track{flex:1;height:28px;background:var(--bg1);border-radius:6px;overflow:hidden;border:1px solid var(--bd)}
.bar-fill{height:100%;border-radius:6px;transition:width .8s cubic-bezier(.4,0,.2,1);background:linear-gradient(90deg,var(--accentD),var(--accent));min-width:0}
.bar-pct{font-family:var(--fm);font-size:.72em;font-weight:700;color:var(--t2);width:38px;text-align:left;flex-shrink:0}
.bw-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
.bw-card{padding:16px;background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);text-align:center;transition:background .3s}
.bw-emoji{font-size:2em;margin-bottom:6px}.bw-day{font-weight:700;font-size:1em;margin-bottom:2px}.bw-sub{font-size:.75em;color:var(--t3)}
.trend-row{display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);margin-bottom:10px;transition:background .3s}
.trend-icon{font-size:2em}.trend-text{flex:1}.trend-title{font-weight:700;font-size:.95em;margin-bottom:2px}.trend-sub{font-size:.82em;color:var(--t2)}
.no-data{text-align:center;padding:40px;color:var(--t3);font-style:italic}
/* Settings */
.settings-section{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:16px;transition:background .3s}
.sett-title{font-weight:700;font-size:.95em;color:var(--t2);margin-bottom:16px;text-transform:uppercase;letter-spacing:.06em;font-size:.82em}
.sett-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--bd)}
.sett-row:last-child{border-bottom:none}
.sett-label{font-weight:600;font-size:.92em}
.sett-desc{font-size:.78em;color:var(--t3);margin-top:2px}
.toggle-sw{position:relative;width:52px;height:28px;background:var(--bg4);border-radius:14px;cursor:pointer;transition:background .3s;flex-shrink:0;border:none}
.toggle-sw.on{background:var(--accent)}
.toggle-sw::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:50%;transition:transform .3s;box-shadow:0 2px 6px rgba(0,0,0,.3)}
.toggle-sw.on::after{transform:translateX(24px)}
.accent-picker{display:flex;gap:8px;flex-wrap:wrap}
.acc-dot{width:32px;height:32px;border-radius:50%;cursor:pointer;transition:all .2s;border:3px solid transparent}
.acc-dot:hover{transform:scale(1.2)}
.acc-dot.sel{border-color:var(--t1);box-shadow:0 0 16px rgba(59,130,246,.4)}
/* Templates */
.tpl-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.tpl-card{background:var(--bg1);border:1px solid var(--bd);border-radius:var(--r2);padding:16px;cursor:pointer;transition:all .25s;text-align:center}
.tpl-card:hover{background:var(--bg4);border-color:var(--accent);transform:translateY(-2px)}
.tpl-icon{font-size:2em;margin-bottom:8px}
.tpl-name{font-weight:700;font-size:.9em;margin-bottom:4px}
.tpl-count{font-size:.75em;color:var(--t3)}
.tpl-actions{display:flex;gap:6px;margin-top:10px;justify-content:center}
.tpl-btn{padding:6px 14px;border:1px solid var(--bd);background:var(--bg2);color:var(--t2);border-radius:6px;font-family:var(--ff);font-size:.75em;font-weight:600;cursor:pointer;transition:all .2s}
.tpl-btn:hover{border-color:var(--accent);color:var(--accentL)}
.tpl-btn.danger:hover{border-color:var(--rose);color:var(--rose)}
/* Calorie Tracker */
.cal-tracker{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:16px;position:relative;overflow:hidden;transition:background .3s}
.cal-tracker::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--em),transparent);opacity:.5}
.ct-header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.ct-header-icon{font-size:1.3em}
.ct-header-text{font-weight:700;font-size:1.05em;background:linear-gradient(135deg,var(--em),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.ct-summary{display:flex;align-items:baseline;gap:8px;margin-bottom:6px}
.ct-current{font-family:var(--fm);font-size:2.2em;font-weight:800;color:var(--t1)}
.ct-of{font-size:.85em;color:var(--t3)}
.ct-target-val{font-family:var(--fm);font-weight:700;color:var(--t2)}
.ct-bar-wrap{position:relative;height:32px;background:var(--bg1);border-radius:8px;border:1px solid var(--bd);margin-bottom:8px;overflow:visible}
.ct-bar-fill{height:100%;border-radius:8px;transition:width .6s cubic-bezier(.4,0,.2,1);position:relative;z-index:1}
.ct-bar-fill.green{background:linear-gradient(90deg,#059669,#10b981)}
.ct-bar-fill.amber{background:linear-gradient(90deg,#d97706,#f59e0b)}
.ct-bar-fill.red{background:linear-gradient(90deg,#dc2626,#ef4444)}
.ct-marker{position:absolute;top:-4px;bottom:-4px;width:3px;border-radius:2px;z-index:2;transition:left .3s}
.ct-marker::after{content:attr(data-label);position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-family:var(--fm);font-size:.6em;font-weight:700;white-space:nowrap;padding:2px 6px;border-radius:4px}
.ct-marker.ideal{background:var(--em)}.ct-marker.ideal::after{color:var(--em);background:rgba(16,185,129,.15)}
.ct-marker.max{background:var(--rose)}.ct-marker.max::after{color:var(--rose);background:rgba(244,63,94,.15)}
.ct-remaining{font-family:var(--fm);font-size:.82em;color:var(--t3);margin-bottom:16px}
.ct-remaining strong{color:var(--t2)}
.ct-meals{margin-bottom:16px}
.ct-meal{display:flex;align-items:center;padding:10px 14px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd);margin-bottom:6px;animation:sUp .25s ease;transition:background .2s}
.ct-meal:hover{background:var(--bg4)}
.ct-meal-icon{font-size:1.2em;margin-right:10px;flex-shrink:0}
.ct-meal-info{flex:1;min-width:0}
.ct-meal-name{font-weight:600;font-size:.88em}
.ct-meal-time{font-family:var(--fm);font-size:.72em;color:var(--t3)}
.ct-meal-cal{font-family:var(--fm);font-weight:700;font-size:.9em;color:var(--em);margin:0 8px}
.ct-meal-del{background:none;border:none;color:var(--t3);cursor:pointer;padding:4px 6px;border-radius:4px;font-size:.8em;transition:all .2s}
.ct-meal-del:hover{color:var(--rose);background:rgba(244,63,94,.1)}
.ct-add-row{display:flex;gap:8px}
.ct-add-input{flex:1;padding:12px 16px;background:var(--bg1);border:1px solid var(--bd);color:var(--t1);border-radius:var(--r1);font-family:var(--ff);font-size:.9em;transition:all .3s}
.ct-add-input:focus{outline:none;border-color:var(--em);background:var(--bg2)}
.ct-add-input::placeholder{color:var(--t3)}
.ct-add-cal{width:100px;padding:12px;background:var(--bg1);border:1px solid var(--bd);color:var(--t1);border-radius:var(--r1);font-family:var(--fm);font-size:.9em;text-align:center;transition:all .3s;flex-shrink:0}
.ct-add-cal:focus{outline:none;border-color:var(--em)}
.ct-add-btn{padding:12px 20px;background:linear-gradient(135deg,#059669,#10b981);border:none;color:#fff;border-radius:var(--r1);font-family:var(--ff);font-weight:700;font-size:.9em;cursor:pointer;transition:all .3s;flex-shrink:0}
.ct-add-btn:hover{box-shadow:0 4px 16px rgba(16,185,129,.4);transform:translateY(-1px)}
.ct-macros{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--bd)}
.ct-macro{text-align:center;padding:8px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)}
.ct-macro-val{font-family:var(--fm);font-weight:700;font-size:1em;margin-bottom:2px}
.ct-macro-lbl{font-size:.65em;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;font-weight:600}
.ct-quick-btns{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.ct-quick{padding:6px 14px;background:var(--bg1);border:1px solid var(--bd);color:var(--t2);border-radius:20px;font-family:var(--ff);font-size:.75em;font-weight:600;cursor:pointer;transition:all .2s}
.ct-quick:hover{border-color:var(--em);color:var(--em);background:rgba(16,185,129,.1)}
.notif-badge{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:6px}
/* Calorie Tracker */
.ct-card{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:20px;position:relative;overflow:hidden;transition:background .3s}
.ct-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--em),transparent);opacity:.5}
.ct-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.ct-title{font-weight:700;font-size:1.05em;display:flex;align-items:center;gap:8px}
.ct-title-text{background:linear-gradient(135deg,var(--em),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.ct-cals{font-family:var(--fm);font-size:1.6em;font-weight:800;text-align:center;margin-bottom:4px}
.ct-cals-sub{font-size:.78em;color:var(--t3);text-align:center;margin-bottom:16px;font-family:var(--fm)}
.ct-bar-wrap{position:relative;height:32px;background:var(--bg1);border-radius:16px;border:1px solid var(--bd);overflow:visible;margin-bottom:20px}
.ct-bar-fill{height:100%;border-radius:16px;transition:width .6s cubic-bezier(.4,0,.2,1);position:relative;z-index:1}
.ct-bar-fill.under{background:linear-gradient(90deg,var(--em),#34d399)}
.ct-bar-fill.ideal{background:linear-gradient(90deg,#34d399,var(--amber))}
.ct-bar-fill.over{background:linear-gradient(90deg,var(--amber),var(--rose))}
.ct-marker{position:absolute;top:-6px;bottom:-6px;width:3px;border-radius:2px;z-index:2;transition:left .3s}
.ct-marker-label{position:absolute;top:-22px;left:50%;transform:translateX(-50%);font-family:var(--fm);font-size:.6em;font-weight:700;white-space:nowrap;padding:2px 6px;border-radius:4px}
.ct-marker.ideal{background:var(--em)}
.ct-marker.ideal .ct-marker-label{color:var(--em);background:rgba(16,185,129,.15)}
.ct-marker.max{background:var(--rose)}
.ct-marker.max .ct-marker-label{color:var(--rose);background:rgba(244,63,94,.15)}
.ct-add-row{display:flex;gap:8px;margin-bottom:12px}
.ct-add-input{flex:1;padding:12px 16px;border:1px solid var(--bd);background:var(--bg1);color:var(--t1);border-radius:var(--r1);font-family:var(--fm);font-size:.95em;transition:all .3s}
.ct-add-input::placeholder{color:var(--t3)}
.ct-add-input:focus{outline:none;border-color:var(--em);background:var(--bg2)}
.ct-add-name{flex:1.5}
.ct-add-cal{flex:0.8;max-width:100px}
.ct-add-btn{padding:12px 20px;border:none;background:linear-gradient(135deg,#059669,var(--em));color:#fff;border-radius:var(--r1);font-family:var(--ff);font-weight:700;font-size:.85em;cursor:pointer;transition:all .3s;flex-shrink:0}
.ct-add-btn:hover{box-shadow:0 4px 16px rgba(16,185,129,.4);transform:translateY(-1px)}
.ct-meals{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.4,0,.2,1)}
.ct-meals.open{max-height:500px}
.ct-meal{display:flex;align-items:center;padding:10px 14px;margin-bottom:4px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd);transition:all .2s}
.ct-meal:hover{background:var(--bg4)}
.ct-meal-name{flex:1;font-weight:600;font-size:.88em}
.ct-meal-cal{font-family:var(--fm);font-size:.85em;font-weight:700;color:var(--em);margin-right:12px}
.ct-meal-time{font-family:var(--fm);font-size:.72em;color:var(--t3);margin-right:10px}
.ct-meal-del{background:none;border:none;color:var(--t3);cursor:pointer;font-size:.8em;padding:4px 8px;border-radius:4px;transition:all .2s}
.ct-meal-del:hover{color:var(--rose);background:rgba(244,63,94,.1)}
.ct-toggle-meals{background:none;border:none;color:var(--t3);font-family:var(--ff);font-size:.8em;cursor:pointer;padding:6px 0;font-weight:600;transition:color .2s}
.ct-toggle-meals:hover{color:var(--accentL)}
.ct-quick-btns{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.ct-quick{padding:6px 12px;border:1px solid var(--bd);background:var(--bg1);color:var(--t2);border-radius:20px;font-family:var(--ff);font-size:.75em;font-weight:600;cursor:pointer;transition:all .2s}
.ct-quick:hover{border-color:var(--em);color:var(--em);background:rgba(16,185,129,.1)}
.ct-macros{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
.ct-macro{text-align:center;padding:10px 6px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)}
.ct-macro-val{font-family:var(--fm);font-weight:700;font-size:1.1em;margin-bottom:2px}
.ct-macro-lbl{font-size:.68em;color:var(--t3);text-transform:uppercase;font-weight:600;letter-spacing:.06em}
/* ‚ïê‚ïê‚ïê NEW: Confetti ‚ïê‚ïê‚ïê */
#confettiCanvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999}
/* ‚ïê‚ïê‚ïê NEW: Check animations ‚ïê‚ïê‚ïê */
@keyframes checkPop{0%{transform:scale(1)}30%{transform:scale(1.5)}50%{transform:scale(.85)}70%{transform:scale(1.15)}100%{transform:scale(1)}}
@keyframes checkGlow{0%{box-shadow:0 0 0 0 rgba(59,130,246,.7)}100%{box-shadow:0 0 24px 12px rgba(59,130,246,0)}}
@keyframes taskFlash{0%{background:var(--bg1)}40%{background:rgba(16,185,129,.18)}100%{background:var(--bg1)}}
@keyframes taskUncomplete{0%{background:var(--bg1)}40%{background:rgba(244,63,94,.1)}100%{background:var(--bg1)}}
.check.popping{animation:checkPop .5s cubic-bezier(.68,-.55,.27,1.55)}
.task-item.flash-done{animation:taskFlash .9s ease}
.task-item.flash-done .check{animation:checkPop .5s cubic-bezier(.68,-.55,.27,1.55),checkGlow .9s ease}
.task-item.flash-undone{animation:taskUncomplete .6s ease}
/* ‚ïê‚ïê‚ïê NEW: Profiles ‚ïê‚ïê‚ïê */
.profile-bar{display:flex;gap:6px;overflow-x:auto;padding:4px 0;margin-bottom:20px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.profile-bar::-webkit-scrollbar{display:none}
.prof-chip{display:flex;align-items:center;gap:5px;padding:7px 14px;border-radius:20px;border:2px solid var(--bd);background:var(--bg1);color:var(--t2);font-family:var(--ff);font-size:.78em;font-weight:600;cursor:pointer;transition:all .25s;white-space:nowrap;flex-shrink:0}
.prof-chip:hover{border-color:var(--accent);color:var(--accentL)}
.prof-chip.active{background:linear-gradient(135deg,var(--accentD),var(--accent));color:#fff;border-color:transparent;box-shadow:0 3px 12px rgba(37,99,235,.3)}
.prof-add{padding:7px 12px;border-radius:20px;border:2px dashed var(--bd);background:transparent;color:var(--t3);font-family:var(--ff);font-size:.78em;cursor:pointer;transition:all .25s;white-space:nowrap;flex-shrink:0}
.prof-add:hover{border-color:var(--accent);color:var(--accentL)}
/* ‚ïê‚ïê‚ïê NEW: Summary ‚ïê‚ïê‚ïê */
.sum-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sum-box{padding:14px;background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);text-align:center}
.sum-val{font-family:var(--fm);font-weight:700;font-size:1.3em;margin-bottom:2px}
.sum-lbl{font-size:.7em;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;font-weight:600}
.sum-insight{padding:14px;background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);margin-top:10px;font-size:.88em;line-height:1.6;color:var(--t2)}
.sum-insight strong{color:var(--t1)}
/* ‚ïê‚ïê‚ïê NEW: Goals ‚ïê‚ïê‚ïê */
.goal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.goal-card{padding:16px;background:var(--bg1);border:2px solid var(--bd);border-radius:var(--r2);cursor:pointer;transition:all .25s;text-align:center}
.goal-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
.goal-card.sel{border-color:var(--accent);background:var(--glowS)}
.goal-icon{font-size:2em;margin-bottom:8px}
.goal-name{font-weight:700;font-size:.85em;margin-bottom:4px}
.goal-desc{font-size:.7em;color:var(--t3);line-height:1.4}
.goal-suggest{margin-top:16px;padding:16px;background:rgba(34,211,238,.06);border:1px solid rgba(34,211,238,.15);border-radius:var(--r2)}
.goal-suggest-title{font-weight:700;font-size:.9em;color:var(--cyan);margin-bottom:10px}
.goal-suggest-item{font-size:.82em;color:var(--t2);padding:8px 12px;margin-bottom:4px;background:var(--bg1);border-radius:6px;cursor:pointer;transition:all .2s;border:1px solid var(--bd)}
.goal-suggest-item:hover{border-color:var(--accent);color:var(--accentL)}
/* ‚ïê‚ïê‚ïê NEW: Calendar Events (ICS) ‚ïê‚ïê‚ïê */
.cal-ev{display:flex;align-items:center;padding:10px 14px;margin-bottom:4px;background:rgba(139,92,246,.08);border-radius:var(--r1);border-left:3px solid #8b5cf6}
.cal-ev-time{font-family:var(--fm);font-size:.72em;color:#a78bfa;margin-right:12px;flex-shrink:0;min-width:60px}
.cal-ev-name{font-weight:600;font-size:.85em;color:#c4b5fd;flex:1}
/* ‚ïê‚ïê‚ïê NEW: Voice Journal ‚ïê‚ïê‚ïê */
.vj-section{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:16px;position:relative;overflow:hidden;transition:background .3s}
.vj-section::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--amber),transparent);opacity:.4}
.vj-title{font-weight:700;font-size:1.05em;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.vj-title-text{background:linear-gradient(135deg,var(--amber),var(--rose));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.vj-rec-btn{width:64px;height:64px;border-radius:50%;border:3px solid var(--rose);background:rgba(244,63,94,.08);color:var(--rose);font-size:1.8em;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
.vj-rec-btn:hover{background:rgba(244,63,94,.15);transform:scale(1.05)}
.vj-rec-btn.on{background:var(--rose);color:#fff;animation:pmic 1.5s infinite}
.vj-status{text-align:center;font-size:.82em;color:var(--t3);margin-bottom:12px}
.vj-transcript{padding:14px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd);font-size:.88em;color:var(--t2);min-height:50px;margin-bottom:12px;line-height:1.6;white-space:pre-wrap}
.vj-summary{padding:14px;background:rgba(245,158,11,.06);border-radius:var(--r1);border:1px solid rgba(245,158,11,.15);font-size:.85em;color:var(--t2);line-height:1.6;margin-bottom:12px}
.vj-summary strong{color:var(--amber)}
.vj-actions{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
.vj-entries-title{font-size:.85em;font-weight:700;color:var(--t3);margin-bottom:10px;padding-top:12px;border-top:1px solid var(--bd)}
.vj-entry{padding:14px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd);margin-bottom:8px}
.vj-entry-date{font-family:var(--fm);font-size:.7em;color:var(--t3);margin-bottom:6px}
.vj-entry-text{font-size:.82em;color:var(--t2);line-height:1.5}
.vj-entry-del{float:right;background:none;border:none;color:var(--t3);cursor:pointer;font-size:.75em;padding:2px 6px;border-radius:4px;transition:all .2s}
.vj-entry-del:hover{color:var(--rose);background:rgba(244,63,94,.1)}
/* ‚ïê‚ïê‚ïê NEW: AI Optimizer ‚ïê‚ïê‚ïê */
.opt-card{padding:14px 16px;background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);margin-bottom:8px}
.opt-title{font-weight:700;font-size:.9em;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.opt-desc{font-size:.78em;color:var(--t3);line-height:1.5}
.opt-action{display:inline-block;margin-top:8px;padding:5px 12px;background:linear-gradient(135deg,var(--accentD),var(--accent));color:#fff;border:none;border-radius:6px;font-family:var(--ff);font-size:.75em;font-weight:700;cursor:pointer;transition:all .2s}
.opt-action:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(37,99,235,.4)}
@media(max-width:480px){.header h1{font-size:1.7em}.egrid{grid-template-columns:repeat(6,1fr)}.stats-row{gap:8px}.stat-val{font-size:1.4em}.ai-row{flex-wrap:wrap}.ai-input{min-width:100%}.nav-tab{font-size:.72em;padding:10px 3px;gap:2px}.tpl-grid{grid-template-columns:1fr}.ct-add-row{flex-wrap:wrap}.ct-add-input{min-width:0}.goal-grid{grid-template-columns:1fr}.sum-grid{grid-template-columns:1fr}}

/* Search/Filter Bar */
.search-bar-wrap{padding:6px 0 2px}
.search-bar-inner{display:flex;gap:8px;align-items:center;background:var(--bg2);border:1.5px solid var(--bg3);border-radius:12px;padding:0 12px;transition:border-color .2s;margin-bottom:6px}
.search-bar-inner:focus-within{border-color:var(--accent)}
.search-bar-icon{color:var(--t2);font-size:14px}
.search-bar-inner input{flex:1;background:transparent;border:none;color:var(--t1);padding:9px 6px;font-size:14px;outline:none}
.search-bar-inner input::placeholder{color:var(--t2)}
.search-clear{background:none;border:none;color:var(--t2);cursor:pointer;font-size:15px;padding:2px 4px;line-height:1}
.filter-pills{display:flex;gap:5px;flex-wrap:wrap;padding:2px 0 6px}
.filter-pill{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;background:var(--bg2);border:1.5px solid var(--bg3);color:var(--t2);cursor:pointer;transition:all .15s;white-space:nowrap}
.filter-pill.active{background:var(--accent);border-color:var(--accent);color:#fff}
/* Pomodoro */
.pomo-fab{position:fixed;bottom:76px;right:16px;z-index:998;background:var(--accent);color:#fff;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 16px rgba(0,0,0,.35);cursor:pointer;border:none;transition:transform .2s}
.pomo-fab:hover{transform:scale(1.1)}
@keyframes pomoPulse{0%,100%{box-shadow:0 4px 16px rgba(239,68,68,.4)}50%{box-shadow:0 6px 28px rgba(239,68,68,.8)}}
.pomo-fab.pomo-active{background:#ef4444;animation:pomoPulse 2s infinite}
.pomo-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.pomo-modal{background:var(--bg1);border-radius:24px;padding:28px 24px 20px;width:min(340px,94vw);text-align:center;border:1px solid var(--bg4);position:relative}
.pomo-close-btn{position:absolute;top:14px;right:14px;background:var(--bg3);border:none;color:var(--t2);width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center}
.pomo-title{font-size:17px;font-weight:700;color:var(--accent);margin-bottom:4px}
.pomo-for{font-size:12px;color:var(--t2);margin-bottom:18px;min-height:16px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pomo-ring{position:relative;margin:0 auto 16px;width:150px;height:150px}
.pomo-ring svg{width:150px;height:150px;transform:rotate(-90deg)}
.pomo-ring-bg{fill:none;stroke:var(--bg3);stroke-width:10}
.pomo-ring-fg{fill:none;stroke:var(--accent);stroke-width:10;stroke-linecap:round;transition:stroke-dashoffset .9s linear}
.pomo-ring-time{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.pomo-timer-display{font-size:38px;font-weight:800;color:var(--t1);font-variant-numeric:tabular-nums;line-height:1}
.pomo-phase-label{font-size:10px;color:var(--t2);text-transform:uppercase;letter-spacing:1.5px;margin-top:4px}
.pomo-ctrls{display:flex;gap:10px;justify-content:center;margin-bottom:14px}
.pomo-ctrls button{padding:9px 22px;border-radius:10px;border:none;cursor:pointer;font-weight:700;font-size:14px;transition:all .2s}
.pomo-btn-go{background:var(--accent);color:#fff}
.pomo-btn-reset{background:var(--bg3);color:var(--t1)}
.pomo-sessions-row{display:flex;gap:5px;justify-content:center;margin-bottom:12px}
.pomo-session-dot{width:10px;height:10px;border-radius:50%;background:var(--bg3)}
.pomo-session-dot.filled{background:var(--accent)}
.pomo-config{font-size:12px;color:var(--t2);display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.pomo-config label{display:flex;align-items:center;gap:4px}
.pomo-config input[type=number]{width:38px;padding:2px 4px;background:var(--bg2);border:1px solid var(--bg4);border-radius:6px;color:var(--t1);text-align:center;font-size:12px}
.task-pomo-btn{width:26px;height:26px;border-radius:7px;background:transparent;border:none;color:var(--t2);cursor:pointer;font-size:13px;display:inline-flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.task-pomo-btn:hover{background:var(--bg3);color:var(--accent)}
.task-pomo-btn.pomo-running{color:#ef4444}</style>
</head>
<body>
<canvas id="confettiCanvas"></canvas>
<div class="app">
<div class="nav-tabs">
<button class="nav-tab active" onclick="switchView('today')" id="tabToday"><span>üìã</span><span>Today</span></button>
<button class="nav-tab" onclick="switchView('stats')" id="tabStats"><span>üìä</span><span>Stats</span></button>
<button class="nav-tab" onclick="switchView('calendar')" id="tabCal"><span>üóìÔ∏è</span><span>Calendar</span></button>
<button class="nav-tab" onclick="switchView('settings')" id="tabSet"><span>‚öôÔ∏è</span><span>Settings</span></button>
</div>
<div class="header"><h1>Daily Routine</h1><div class="date-time" id="dateTime"></div></div>
<!-- Profile Bar -->
<div class="profile-bar" id="profileBar"></div>
<!-- TODAY -->
<div id="todayView">
<div class="card">
<div class="ring-container"><svg width="180" height="180"><defs><linearGradient id="blueGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:var(--accent)"/><stop offset="100%" style="stop-color:var(--cyan)"/></linearGradient></defs><circle class="ring-bg" cx="90" cy="90" r="80"/><circle class="ring-progress" cx="90" cy="90" r="80" id="progressRing"/></svg><div class="ring-label"><div class="ring-pct" id="pctText">0%</div><div class="ring-sub">completed</div></div></div>
<div class="stats-row"><div class="stat-box"><div class="stat-val" id="doneN">0</div><div class="stat-lbl">Done</div></div><div class="stat-box"><div class="stat-val" id="leftN">0</div><div class="stat-lbl">Left</div></div><div class="stat-box"><div class="stat-val" id="streakN">0</div><div class="stat-lbl">Streak</div></div></div>
</div>
<!-- Calorie Tracker Card -->
<div class="ct-card" id="ctCard">
<div class="ct-header"><div class="ct-title"><span>üî•</span><span class="ct-title-text">Calorie Tracker</span></div><button class="togbtn" onclick="toggleCtSettings()" style="font-size:.72em;padding:6px 12px">‚öôÔ∏è</button></div>
<div class="ct-cals"><span id="ctCurrent">0</span> <span style="font-size:.5em;color:var(--t3)">kcal</span></div>
<div class="ct-cals-sub">Target: <span id="ctTargetLabel">2,100</span> ¬∑ Max: <span id="ctMaxLabel">2,300</span></div>
<div class="ct-bar-wrap"><div class="ct-bar-fill under" id="ctBarFill" style="width:0%"></div><div class="ct-marker ideal" id="ctIdealMark" style="left:0%"><div class="ct-marker-label">Target</div></div><div class="ct-marker max" id="ctMaxMark" style="left:100%"><div class="ct-marker-label">Max</div></div></div>
<div class="ct-quick-btns" id="ctQuickBtns"></div>
<div class="ct-add-row"><input type="text" class="ct-add-input ct-add-name" id="ctMealName" placeholder="Meal name..."><input type="number" class="ct-add-input ct-add-cal" id="ctMealCal" placeholder="kcal"><button class="ct-add-btn" onclick="addMeal()">+ Add</button></div>
<button class="ct-toggle-meals" onclick="toggleMealList()"><span id="ctMealTogText">Show meals (0)</span></button>
<div class="ct-meals" id="ctMealList"></div>
<div class="ct-macros"><div class="ct-macro"><div class="ct-macro-val" id="ctRemain" style="color:var(--em)">‚Äî</div><div class="ct-macro-lbl">Remaining</div></div><div class="ct-macro"><div class="ct-macro-val" id="ctMealCount" style="color:var(--accentL)">0</div><div class="ct-macro-lbl">Meals</div></div><div class="ct-macro"><div class="ct-macro-val" id="ctAvgMeal" style="color:var(--cyan)">‚Äî</div><div class="ct-macro-lbl">Avg/meal</div></div></div>
</div>
<!-- Calendar Events -->
<div class="tl-section" id="calEvSection" style="display:none"><div class="tl-head"><span class="tl-title">üìÖ Calendar Events</span><button class="togbtn" onclick="toggleCalEv()"><span id="calEvTog">Hide</span></button></div><div id="calEvWrap" style="margin-top:12px"></div></div>

<div class="search-bar-wrap" id="searchWrap">
<div class="search-bar-inner">
<span class="search-bar-icon">&#128269;</span>
<input type="text" id="taskSearch" placeholder="Search tasks..." oninput="filterTasks()" />
<button class="search-clear" id="searchClear" onclick="clearSearch()" style="display:none">&#10005;</button>
</div>
<div class="filter-pills" id="filterPills">
<span class="filter-pill active" onclick="setFilter('all',this)">All</span>
<span class="filter-pill" onclick="setFilter('pending',this)">Pending</span>
<span class="filter-pill" onclick="setFilter('done',this)">Done</span>
<span class="filter-pill" onclick="setFilter('ai',this)">AI</span>
<span class="filter-pill" onclick="setFilter('morning',this)">&#9728; Morning</span>
<span class="filter-pill" onclick="setFilter('afternoon',this)">&#127773; Afternoon</span>
<span class="filter-pill" onclick="setFilter('evening',this)">&#9733; Evening</span>
</div>
</div>
<div class="empty-state" id="emptyState" style="display:none"><div class="empty-state-icon">‚ú®</div><h3>No tasks yet</h3><p>Add your first task or load a template.</p></div>
<div class="period-section" id="mornSec" style="display:none"><div class="period-header" onclick="togPeriod('morn')"><span class="period-emoji">üåÖ</span><span class="period-name">Morning</span><span class="period-badge" id="mornBadge">0/0</span><span class="chevron open" id="mornChev">‚ñº</span></div><div class="task-list open" id="mornList"><div class="task-list-inner" id="mornInner"></div></div></div>
<div class="period-section" id="aftSec" style="display:none"><div class="period-header" onclick="togPeriod('aft')"><span class="period-emoji">‚òÄÔ∏è</span><span class="period-name">Afternoon</span><span class="period-badge" id="aftBadge">0/0</span><span class="chevron open" id="aftChev">‚ñº</span></div><div class="task-list open" id="aftList"><div class="task-list-inner" id="aftInner"></div></div></div>
<div class="period-section" id="eveSec" style="display:none"><div class="period-header" onclick="togPeriod('eve')"><span class="period-emoji">üåô</span><span class="period-name">Evening</span><span class="period-badge" id="eveBadge">0/0</span><span class="chevron open" id="eveChev">‚ñº</span></div><div class="task-list open" id="eveList"><div class="task-list-inner" id="eveInner"></div></div></div>
<div class="ai-section"><div class="ai-label"><span>ü§ñ</span><span class="ai-label-text">AI Assistant</span></div><div class="ai-examples"><strong>Try:</strong> "Take pill at 2pm and 10pm" ¬∑ "Gym weekdays at 6pm" ¬∑ "Yoga every Mon Wed Fri" ¬∑ "Dinner Friday 7pm"</div><div class="ai-row"><input type="text" class="ai-input" id="aiInput" placeholder="Describe your task(s)..."><button class="ibtn" id="voiceBtn" onclick="togVoice()"><span id="vIcon">üé§</span></button><button class="sbtn" onclick="processAI()">Send</button></div><div class="ai-resp" id="aiResp"></div></div>
<!-- Voice Journal -->
<div class="vj-section"><div class="vj-title"><span>üìì</span><span class="vj-title-text">End-of-Day Journal</span></div>
<div class="vj-status" id="vjStatus">Tap to record your reflection</div>
<button class="vj-rec-btn" id="vjRecBtn" onclick="toggleJournalRec()">üé§</button>
<div class="vj-transcript" id="vjTranscript" style="display:none"></div>
<div class="vj-summary" id="vjSummary" style="display:none"></div>
<div class="vj-actions" id="vjActions" style="display:none">
<button class="mbtn mbtn-save" style="flex:0;padding:10px 20px;font-size:.82em" onclick="saveJournalEntry()">üíæ Save</button>
<button class="mbtn mbtn-cancel" style="flex:0;padding:10px 20px;font-size:.82em" onclick="clearJournal()">Clear</button>
</div>
<div id="vjEntries"></div>
</div>
<div class="tl-section"><div class="tl-head"><span class="tl-title">üìÖ Daily Timeline</span><button class="togbtn" onclick="togTL()"><span id="tlTog">Show</span></button></div><div class="tl-wrap" id="tlWrap"><div class="timeline" id="timeline"></div></div></div>
<div class="act-btns"><button class="act-btn btn-rst" onclick="resetDay()">‚Üª Reset Day</button><button class="act-btn btn-add" onclick="openModal()">+ Add Task</button></div>
<div class="quote" id="quote"></div>
</div>
<!-- STATS -->
<div id="statsView" style="display:none">
<div class="card card-sm" style="position:relative"><div class="sec-title">üìã Daily Summary</div><div id="summaryArea"></div></div>
<div class="card card-sm"><div class="sec-title">üß† AI Routine Optimizer</div><div id="optimizerArea"></div></div>
<div class="card card-sm"><div class="sec-title">üî• Streak Heatmap ‚Äî Last 12 Weeks</div><div id="heatmapArea"></div><div class="hm-legend"><span>Less</span><div class="hm-lcells"><div class="hm-lc" style="background:var(--bg4)"></div><div class="hm-lc" style="background:rgba(59,130,246,.2)"></div><div class="hm-lc" style="background:rgba(59,130,246,.45)"></div><div class="hm-lc" style="background:rgba(59,130,246,.7)"></div><div class="hm-lc" style="background:var(--accent)"></div></div><span>More</span></div></div>
<div class="card card-sm"><div class="sec-title">üìà Weekly Analytics</div><div class="an-grid"><div class="an-box"><div class="an-val blue" id="anAvg">‚Äî</div><div class="an-lbl">Avg Completion</div></div><div class="an-box"><div class="an-val cyan" id="anStreak">0</div><div class="an-lbl">Current Streak</div></div><div class="an-box"><div class="an-val green" id="anBest">0</div><div class="an-lbl">Best Streak</div></div><div class="an-box"><div class="an-val amber" id="anTotal">0</div><div class="an-lbl">Days Tracked</div></div></div></div>
<div class="card card-sm"><div class="sec-title">üìä Completion by Day of Week</div><div id="barArea"></div><div class="bw-grid" id="bwArea"></div></div>
<div class="card card-sm"><div class="sec-title">üìâ Trends</div><div id="trendArea"></div></div>
<div class="card card-sm"><div class="sec-title">üî• Calorie Trends ‚Äî Last 7 Days</div><div id="calTrendArea"></div></div>
</div>
<!-- CALENDAR -->
<div id="calView" style="display:none">
<div class="cal-hdr"><button class="cal-nav" onclick="prevMo()">‚Äπ</button><h2 class="cal-title" id="calTitle"></h2><button class="cal-nav" onclick="nextMo()">‚Ä∫</button></div>
<div class="cal-grid" id="calGrid"></div>
<div class="cal-legend"><div class="leg-item"><span class="leg-dot" style="background:var(--accent)"></span>Has Tasks</div><div class="leg-item"><span class="leg-dot" style="background:var(--em)"></span>All Done</div><div class="leg-item"><span class="leg-dot" style="background:var(--glowS);border:1px solid var(--accent)"></span>Today</div></div>
<div class="day-panel" id="dayPanel"><div class="dp-hdr"><span class="dp-title" id="panelTitle"></span><button class="dp-close" onclick="closePanel()">‚úï</button></div><div id="panelTasks"></div></div>
</div>
<!-- SETTINGS -->
<div id="settView" style="display:none">
<div class="settings-section"><div class="sec-title">üé® Appearance</div><div class="sett-row"><div><div class="sett-label">Dark Mode</div><div class="sett-desc">Toggle dark/light theme</div></div><button class="toggle-sw on" id="darkToggle" onclick="toggleTheme()"></button></div><div class="sett-row"><div><div class="sett-label">Accent Color</div><div class="sett-desc">Choose your accent color</div></div><div class="accent-picker" id="accentPicker"></div></div></div>
<div class="settings-section"><div class="sec-title">üîî Notifications</div><div class="sett-row"><div><div class="sett-label">Task Reminders</div><div class="sett-desc">Get notified before each task</div></div><button class="toggle-sw" id="notifToggle" onclick="toggleNotif()"></button></div><div class="sett-row"><div><div class="sett-label">Reminder Lead Time</div><div class="sett-desc">How many minutes before</div></div><select class="fselect" id="notifLead" onchange="saveSettings()" style="width:100px"><option value="5">5 min</option><option value="10" selected>10 min</option><option value="15">15 min</option><option value="30">30 min</option></select></div></div>
<div class="settings-section"><div class="sec-title">üî• Calorie Tracker</div><div class="sett-row"><div><div class="sett-label">Target Calories</div><div class="sett-desc">Ideal daily intake goal</div></div><input type="number" class="finput" id="settCalTarget" value="2100" style="width:100px;text-align:center" onchange="updateCalSettings()"></div><div class="sett-row"><div><div class="sett-label">Max Calories</div><div class="sett-desc">Hard upper limit</div></div><input type="number" class="finput" id="settCalMax" value="2300" style="width:100px;text-align:center" onchange="updateCalSettings()"></div><div class="sett-row"><div><div class="sett-label">Quick Add Presets</div><div class="sett-desc">Common meals (name:calories, comma-separated)</div></div></div><textarea class="finput" id="settCalPresets" rows="3" style="font-family:var(--fm);font-size:.82em;margin-top:8px" onchange="updateCalSettings()" placeholder="Coffee:50, Protein Shake:300, Chicken Rice:650"></textarea></div>
<div class="settings-section"><div class="sec-title">üéØ Goals & Suggestions</div><div class="sett-row"><div><div class="sett-label">My Goal</div><div class="sett-desc">Get routine suggestions based on your goal</div></div></div><div class="goal-grid" id="goalGrid"></div><div id="goalSuggestions"></div></div>
<div class="settings-section"><div class="sec-title">üìÖ Calendar Sync</div><div class="sett-row"><div><div class="sett-label">Import Calendar (.ics)</div><div class="sett-desc">See calendar events alongside your routine</div></div></div><div class="act-btns" style="margin-top:12px"><button class="act-btn btn-rst" onclick="document.getElementById('icsFile').click()">üì• Import .ics</button><button class="act-btn btn-rst" onclick="clearCalEvents()">üóëÔ∏è Clear Events</button></div><input type="file" id="icsFile" accept=".ics" style="display:none" onchange="importICS(event)"><div style="font-size:.72em;color:var(--t3);margin-top:8px;line-height:1.5">Export from Google Calendar, Apple Calendar, or Outlook as .ics, then import here.</div></div>
<div class="settings-section"><div class="sec-title">üë§ Routine Profiles</div><div class="tpl-grid" id="profileGrid"></div><div class="act-btns"><button class="act-btn btn-add" onclick="saveAsProfile()" style="font-size:.85em">+ Save Current as Profile</button></div></div>
<div class="settings-section"><div class="sec-title">üì¶ Task Templates</div><div class="tpl-grid" id="tplGrid"></div><div class="act-btns"><button class="act-btn btn-add" onclick="saveAsTemplate()" style="font-size:.85em">üíæ Save Current as Template</button></div></div>
<div class="settings-section"><div class="sec-title">üóÑÔ∏è Data</div><div class="act-btns"><button class="act-btn btn-rst" onclick="exportData()">üì§ Export Data</button><button class="act-btn btn-rst" onclick="document.getElementById('importFile').click()">üì• Import Data</button></div><input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)"></div>
</div>
</div>
<!-- Modal -->
<div class="modal-bg" id="modal"><div class="modal-box">
<div class="mtitle" id="mTitle">Add Task</div>
<div class="field"><label class="flabel">Task Name</label><input type="text" class="finput" id="fName" placeholder="e.g. Morning workout"></div>
<div class="field"><label class="flabel">Icon</label><div class="egrid" id="eGrid"></div></div>
<div class="field"><label class="flabel">Period</label><select class="fselect" id="fPeriod"><option value="morning">üåÖ Morning</option><option value="afternoon">‚òÄÔ∏è Afternoon</option><option value="evening">üåô Evening</option></select></div>
<div class="field"><label class="flabel">Time</label><input type="time" class="finput" id="fTime" value="09:00"></div>
<div class="field"><label class="flabel">Duration (minutes)</label><input type="number" class="finput" id="fDur" value="30" min="5" max="300"></div>
<div class="field"><label class="flabel">Notes (optional)</label><textarea class="finput" id="fNotes" rows="2" placeholder="e.g. 5mg dosage, bring water..." style="resize:vertical;font-family:var(--ff)"></textarea></div>
<div class="field"><label class="flabel">Schedule</label><select class="fselect" id="fSched" onchange="onSchedChange()"><option value="daily">üîÅ Every day</option><option value="weekdays">üìÖ Weekdays (Mon‚ÄìFri)</option><option value="weekends">üå¥ Weekends (Sat‚ÄìSun)</option><option value="custom">üéØ Custom days</option><option value="once">üìå One-time date</option></select></div>
<div class="field" id="fCustomDaysWrap" style="display:none"><label class="flabel">Pick Days</label><div class="day-picker" id="dayPicker"></div></div>
<div class="field" id="fDateWrap" style="display:none"><label class="flabel">Date</label><input type="date" class="finput" id="fDate"></div>
<div class="mactions" id="mActs"><button class="mbtn mbtn-cancel" onclick="closeModal()">Cancel</button><button class="mbtn mbtn-save" id="mSaveBtn" onclick="saveTask()">Add Task</button></div>
</div></div>
<div class="modal-bg" id="tplModal"><div class="modal-box" style="max-width:380px">
<div class="mtitle" id="tplModalTitle">Save as Template</div>
<div class="field"><label class="flabel" id="tplNameLabel">Template Name</label><input type="text" class="finput" id="tplName" placeholder="e.g. Gym Day, Rest Day..."></div>
<div class="field"><label class="flabel">Icon</label><div class="egrid" id="tplEGrid"></div></div>
<div class="mactions"><button class="mbtn mbtn-cancel" onclick="document.getElementById('tplModal').classList.remove('show')">Cancel</button><button class="mbtn mbtn-save" id="tplSaveBtn" onclick="confirmSaveTemplate()">Save</button></div>
</div></div>
<script>
// ‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê
const EMOJIS=['üéØ','üèãÔ∏è','üìö','üé®','üç≥','üö∂','‚òï','üéÆ','üßò','üíä','üíß','üõí','üìû','üé¨','üé∏','‚úçÔ∏è'];
const QUOTES=["Small daily improvements lead to stunning results over time.","Success is the sum of small efforts repeated day in and day out.","Your future self will thank you for the habits you build today.","Consistency is the key to unlocking your potential.","Every completed task is a step towards your goals.","Discipline is choosing between what you want now and what you want most."];
const PMAP={morning:{sec:'mornSec',inner:'mornInner',list:'mornList',badge:'mornBadge',chev:'mornChev',key:'morn'},afternoon:{sec:'aftSec',inner:'aftInner',list:'aftList',badge:'aftBadge',chev:'aftChev',key:'aft'},evening:{sec:'eveSec',inner:'eveInner',list:'eveList',badge:'eveBadge',chev:'eveChev',key:'eve'}};
const ACCENTS=[{id:'blue',color:'#3b82f6'},{id:'green',color:'#10b981'},{id:'purple',color:'#8b5cf6'},{id:'rose',color:'#f43f5e'},{id:'amber',color:'#f59e0b'},{id:'cyan',color:'#22d3ee'}];
const TPL_ICONS=['üì¶','üèãÔ∏è','üò¥','üìö','üßò','üéØ','üíº','üéâ','üèÉ','üßπ','üç≥','üí™'];
const GOALS=[
{id:'weight_loss',icon:'üèÉ',name:'Weight Loss',desc:'Calorie deficit + cardio focus',tasks:[{name:'Morning Walk',icon:'üö∂',time:'7:00 AM',duration:30,period:'morning',repeat:'daily'},{name:'Log Meals',icon:'üìù',time:'12:00 PM',duration:5,period:'afternoon',repeat:'daily'},{name:'Evening Cardio',icon:'üèÉ',time:'6:00 PM',duration:45,period:'evening',repeat:'weekdays'},{name:'Drink Water (64oz)',icon:'üíß',time:'3:00 PM',duration:5,period:'afternoon',repeat:'daily'}]},
{id:'muscle_gain',icon:'üí™',name:'Muscle Gain',desc:'Strength training + protein timing',tasks:[{name:'Protein Shake',icon:'ü•§',time:'7:30 AM',duration:5,period:'morning',repeat:'daily'},{name:'Take Creatine',icon:'üíä',time:'8:00 AM',duration:5,period:'morning',repeat:'daily'},{name:'Gym ‚Äî Weights',icon:'üèãÔ∏è',time:'5:30 PM',duration:75,period:'evening',repeat:'weekdays'},{name:'Post-Workout Meal',icon:'üçó',time:'7:00 PM',duration:30,period:'evening',repeat:'weekdays'}]},
{id:'productivity',icon:'üß†',name:'Productivity',desc:'Deep work + focus sessions',tasks:[{name:'Morning Planning',icon:'üìù',time:'7:00 AM',duration:15,period:'morning',repeat:'daily'},{name:'Deep Work Block',icon:'üíª',time:'9:00 AM',duration:120,period:'morning',repeat:'weekdays'},{name:'Afternoon Review',icon:'üìã',time:'3:00 PM',duration:15,period:'afternoon',repeat:'weekdays'},{name:'Evening Journal',icon:'üìì',time:'9:00 PM',duration:10,period:'evening',repeat:'daily'}]},
{id:'wellness',icon:'üßò',name:'Wellness',desc:'Balance mind + body + rest',tasks:[{name:'Morning Meditation',icon:'üßò',time:'7:00 AM',duration:15,period:'morning',repeat:'daily'},{name:'Stretch Break',icon:'ü§∏',time:'12:00 PM',duration:10,period:'afternoon',repeat:'daily'},{name:'Evening Yoga',icon:'üßò',time:'7:00 PM',duration:30,period:'evening',repeat:'daily'},{name:'Gratitude Journal',icon:'üôè',time:'9:30 PM',duration:10,period:'evening',repeat:'daily'}]}
];

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let tasks=JSON.parse(localStorage.getItem('routineTasks'))||[];
let done=JSON.parse(localStorage.getItem('completedTasks'))||[];
let history=JSON.parse(localStorage.getItem('dayHistory'))||{};
let templates=JSON.parse(localStorage.getItem('taskTemplates'))||[];
let settings=JSON.parse(localStorage.getItem('appSettings'))||{theme:'dark',accent:'blue',notif:false,notifLead:10};
let lastReset=localStorage.getItem('lastResetDate');
let streak=parseInt(localStorage.getItem('streak'))||0;
let selEmoji='üéØ',tplEmoji='üì¶',recognition=null,listening=false;
let calMo=new Date().getMonth(),calYr=new Date().getFullYear();
let editIdx=-1,customDays=new Set(),dragSrcIdx=null,dragPeriod=null;
let notifTimers=[];
// NEW state
let profiles=JSON.parse(localStorage.getItem('routineProfiles'))||[];
let activeProfile=localStorage.getItem('activeProfile')||null;
let calEvents=JSON.parse(localStorage.getItem('calEvents'))||[];
let journalEntries=JSON.parse(localStorage.getItem('journalEntries'))||[];
let userGoal=localStorage.getItem('userGoal')||null;
let vjRecognition=null,vjListening=false,vjTranscriptText='';
let confettiShown=false; // prevent repeated triggers per render cycle

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
function init(){
applySettings();
const today=new Date().toDateString();
const todayISO=new Date().toISOString().split('T')[0];
if(lastReset!==today){
if(lastReset){
const yISO=new Date(lastReset).toISOString().split('T')[0];
const yTasks=tasks.filter(t=>taskShowsOnDate(t,yISO));
const yTotal=yTasks.length,yDone=done.length;
if(yTotal>0){history[yISO]={done:yDone,total:yTotal,pct:Math.round(yDone/yTotal*100)};save('dayHistory',history)}
if(yDone>=yTotal&&yTotal>0)streak++;else if(yTotal>0)streak=0;
localStorage.setItem('streak',streak);
}
done=[];save('completedTasks',done);localStorage.setItem('lastResetDate',today);
tasks=tasks.filter(t=>{if(t.repeat==='once')return t.date>=todayISO;return true});save('routineTasks',tasks);
}
confettiShown=false;
initVoice();renderEmojiPicker();render();updateDT();setInterval(updateDT,1000);
initCalTracker();renderProfileBar();renderCalEventsToday();
document.getElementById('quote').textContent='"'+QUOTES[Math.floor(Math.random()*QUOTES.length)]+'"';
document.getElementById('aiInput').addEventListener('keypress',e=>{if(e.key==='Enter')processAI()});
document.getElementById('ctMealCal').addEventListener('keypress',e=>{if(e.key==='Enter')addMeal()});
document.getElementById('ctMealName').addEventListener('keypress',e=>{if(e.key==='Enter')document.getElementById('ctMealCal').focus()});
scheduleNotifications();renderJournalEntries();
}

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function escHtml(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function taskShowsOnDate(t,dateStr){
const dow=new Date(dateStr+'T12:00:00').getDay(),r=t.repeat;
if(r===undefined||r===null){if(!t.date)return true;return t.date===dateStr}
if(r==='daily')return true;if(r==='weekdays')return dow>=1&&dow<=5;if(r==='weekends')return dow===0||dow===6;
if(Array.isArray(r))return r.includes(dow);if(r==='once')return t.date===dateStr;return true;
}
function getTodayTasks(){const d=new Date().toISOString().split('T')[0];return tasks.filter(t=>taskShowsOnDate(t,d))}
function to24(t){const[tm,mod]=t.split(' ');let[h,m]=tm.split(':');h=+h;if(h===12)h=0;if(mod==='PM')h+=12;return String(h).padStart(2,'0')+':'+m}
function to12(t){let[h,m]=t.split(':');h=+h;const ap=h>=12?'PM':'AM';h=h%12||12;return h+':'+m+' '+ap}
function period4time(t){const h=+to24(t).split(':')[0];return h<12?'morning':h<17?'afternoon':'evening'}
function updateDT(){const n=new Date();document.getElementById('dateTime').textContent=n.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+' ‚Ä¢ '+n.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}
function saveSnapshot(){const todayISO=new Date().toISOString().split('T')[0],tt=getTodayTasks();if(tt.length>0){history[todayISO]={done:done.length,total:tt.length,pct:Math.round(done.length/tt.length*100)};save('dayHistory',history)}}
function schedLabel(t){const r=t.repeat;if(r==='daily')return'every day';if(r==='weekdays')return'weekdays';if(r==='weekends')return'weekends';if(Array.isArray(r))return r.map(d=>['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d]).join(', ');if(r==='once'&&t.date)return new Date(t.date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});return'every day'}

// ‚ïê‚ïê‚ïê CONFETTI ‚ïê‚ïê‚ïê
function fireConfetti(){
const canvas=document.getElementById('confettiCanvas');const ctx=canvas.getContext('2d');
canvas.width=window.innerWidth;canvas.height=window.innerHeight;
const particles=[];const colors=['#3b82f6','#22d3ee','#10b981','#f59e0b','#f43f5e','#8b5cf6','#fbbf24','#34d399'];
for(let i=0;i<150;i++){particles.push({x:canvas.width/2+(Math.random()-.5)*200,y:canvas.height/2,vx:(Math.random()-.5)*15,vy:Math.random()*-18-5,gravity:.4,color:colors[Math.floor(Math.random()*colors.length)],size:Math.random()*8+4,rotation:Math.random()*360,rotSpeed:(Math.random()-.5)*10,alpha:1,shape:Math.random()>.5?'rect':'circle'})}
let frame=0;function animate(){ctx.clearRect(0,0,canvas.width,canvas.height);let alive=false;
particles.forEach(p=>{p.vy+=p.gravity;p.x+=p.vx;p.y+=p.vy;p.rotation+=p.rotSpeed;p.alpha-=.008;
if(p.alpha>0){alive=true;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rotation*Math.PI/180);ctx.globalAlpha=p.alpha;ctx.fillStyle=p.color;
if(p.shape==='rect'){ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size*.6)}else{ctx.beginPath();ctx.arc(0,0,p.size/2,0,Math.PI*2);ctx.fill()}ctx.restore()}});
frame++;if(alive&&frame<180)requestAnimationFrame(animate);else{ctx.clearRect(0,0,canvas.width,canvas.height)}}
animate();
}

// ‚ïê‚ïê‚ïê RENDER (with animations) ‚ïê‚ïê‚ïê
function render(){
const tt=getTodayTasks(),total=tt.length,dn=done.length,pct=total?Math.round(dn/total*100):0;
document.getElementById('pctText').textContent=pct+'%';
document.getElementById('doneN').textContent=dn;
document.getElementById('leftN').textContent=total-dn;
document.getElementById('streakN').textContent=streak;
const circ=2*Math.PI*80,ring=document.getElementById('progressRing');
ring.style.strokeDasharray=circ;ring.style.strokeDashoffset=circ-(pct/100)*circ;
// Confetti at 100%
if(pct===100&&total>0&&!confettiShown){confettiShown=true;setTimeout(fireConfetti,300)}
document.getElementById('emptyState').style.display=total?'none':'block';
const grouped={morning:[],afternoon:[],evening:[]};
const ftt=typeof taskMatchesFilter!="undefined"?tt.filter(taskMatchesFilter):tt;ftt.forEach(t=>{const gi=tasks.indexOf(t);grouped[t.period].push({...t,idx:gi})});
Object.keys(PMAP).forEach(p=>{
const cfg=PMAP[p],list=grouped[p],sec=document.getElementById(cfg.sec),inner=document.getElementById(cfg.inner);
sec.style.display=list.length?'block':'none';
list.sort((a,b)=>{const oa=(a.sortOrder!=null)?a.sortOrder:999,ob=(b.sortOrder!=null)?b.sortOrder:999;if(oa!==ob)return oa-ob;return to24(a.time).localeCompare(to24(b.time))});
const pd=list.filter(t=>done.includes('t-'+t.idx)).length;
document.getElementById(cfg.badge).textContent=pd+'/'+list.length;
inner.innerHTML='';
list.forEach((task,listPos)=>{
const id='t-'+task.idx,isDone=done.includes(id);
const el=document.createElement('div');el.className='task-item'+(isDone?' done':'');
el.setAttribute('draggable','true');el.dataset.idx=task.idx;el.dataset.period=p;el.dataset.listpos=listPos;
let tags='';
if(task.aiSuggested)tags+='<span class="tag tag-ai">AI</span>';
if(task.repeat==='weekdays')tags+='<span class="tag tag-sched">M‚ÄìF</span>';
else if(task.repeat==='weekends')tags+='<span class="tag tag-sched">S‚ÄìS</span>';
else if(Array.isArray(task.repeat))tags+='<span class="tag tag-sched">'+task.repeat.map(d=>['Su','Mo','Tu','We','Th','Fr','Sa'][d]).join(' ')+'</span>';
else if(task.repeat==='once'&&task.date)tags+='<span class="tag tag-date">'+new Date(task.date+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})+'</span>';
const notesHtml=task.notes?'<div class="tnotes">üìù '+escHtml(task.notes)+'</div>':'';
el.innerHTML='<span class="drag-handle" title="Drag to reorder">‚†ø</span><span class="temoji">'+task.icon+'</span><div class="tinfo"><div class="tname"><span class="tname-text">'+escHtml(task.name)+'</span>'+tags+'</div><div class="tmeta">'+task.time+' ¬∑ '+task.duration+'m</div>'+notesHtml+'</div><div class="tactions"><button class="tbtn edit-b" data-i="'+task.idx+'" title="Edit">‚úèÔ∏è</button><button class="tbtn del" data-i="'+task.idx+'" title="Delete">üóëÔ∏è</button><button class="task-pomo-btn" data-idx="'+task.idx+'" title="Pomodoro Focus">&#9202;</button></div><div class="check'+(isDone?' on':'')+'" data-id="'+id+'"></div>';
el.querySelector('.check').addEventListener('click',e=>{e.stopPropagation();toggleDone(id,el)});
el.querySelector('.edit-b').addEventListener('click',e=>{e.stopPropagation();openEdit(+e.currentTarget.dataset.i)});
el.querySelector('.del').addEventListener('click',function(e){e.stopPropagation();const btn=this;if(btn.dataset.confirm==='1'){delTask(+btn.dataset.i)}else{btn.dataset.confirm='1';btn.textContent='‚ùå';btn.title='Tap again';setTimeout(()=>{if(btn.isConnected){btn.dataset.confirm='';btn.textContent='üóëÔ∏è';btn.title='Delete'}},2500)}
el.querySelector('.task-pomo-btn').addEventListener('click',e=>{e.stopPropagation();focusOnTask(+e.currentTarget.dataset.idx);});});
el.addEventListener('click',e=>{if(!e.target.closest('.tactions')&&!e.target.closest('.check')&&!e.target.closest('.drag-handle'))openEdit(task.idx)});
el.addEventListener('dragstart',e=>{dragSrcIdx=task.idx;dragPeriod=p;el.classList.add('dragging');e.dataTransfer.effectAllowed='move'});
el.addEventListener('dragend',()=>{el.classList.remove('dragging');dragSrcIdx=null;dragPeriod=null;document.querySelectorAll('.task-item').forEach(x=>x.style.borderTop='')});
el.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='move';el.style.borderTop='2px solid var(--accent)'});
el.addEventListener('dragleave',()=>{el.style.borderTop=''});
el.addEventListener('drop',e=>{e.preventDefault();el.style.borderTop='';const targetIdx=+el.dataset.idx;if(dragSrcIdx!==null&&dragSrcIdx!==targetIdx){reorderTask(dragSrcIdx,targetIdx,p)}});
inner.appendChild(el);
});
});
if(document.getElementById('tlWrap').classList.contains('open'))renderTL();
}

function toggleDone(id,taskEl){
const wasChecked=done.includes(id);
if(wasChecked){done=done.filter(c=>c!==id)}else{done.push(id)}
save('completedTasks',done);saveSnapshot();
// Animate
if(taskEl){
const checkEl=taskEl.querySelector('.check');
if(!wasChecked){
taskEl.classList.add('flash-done');checkEl.classList.add('popping');
setTimeout(()=>{taskEl.classList.remove('flash-done');checkEl.classList.remove('popping')},1000);
}else{
taskEl.classList.add('flash-undone');
setTimeout(()=>taskEl.classList.remove('flash-undone'),700);
}
}
// Schedule confetti check
confettiShown=false;
setTimeout(()=>render(),wasChecked?100:600);
}
function delTask(idx){done=done.filter(c=>c!=='t-'+idx);tasks.splice(idx,1);done=done.map(c=>{const oi=+c.split('-')[1];return oi>idx?'t-'+(oi-1):c});save('routineTasks',tasks);save('completedTasks',done);saveSnapshot();render()}
function togPeriod(key){const cfg=Object.values(PMAP).find(c=>c.key===key);document.getElementById(cfg.list).classList.toggle('open');document.getElementById(cfg.chev).classList.toggle('open')}

// ‚ïê‚ïê‚ïê DRAG REORDER ‚ïê‚ïê‚ïê
function reorderTask(srcIdx,targetIdx,period){
const tt=getTodayTasks().filter(t=>t.period===period).sort((a,b)=>{const oa=(a.sortOrder!=null)?a.sortOrder:999,ob=(b.sortOrder!=null)?b.sortOrder:999;if(oa!==ob)return oa-ob;return to24(a.time).localeCompare(to24(b.time))});
tt.forEach((t,i)=>{const gi=tasks.indexOf(t);if(gi>=0)tasks[gi].sortOrder=i*10});
const srcTask=tasks[srcIdx],targetTask=tasks[targetIdx];
if(srcTask&&targetTask&&srcTask.period===targetTask.period){srcTask.sortOrder=(targetTask.sortOrder||0)-1;
const periodTasks=tasks.filter(t=>t.period===srcTask.period&&getTodayTasks().includes(t));
periodTasks.sort((a,b)=>(a.sortOrder||0)-(b.sortOrder||0));periodTasks.forEach((t,i)=>t.sortOrder=i*10)}
save('routineTasks',tasks);render();
}
// ‚ïê‚ïê‚ïê TIMELINE ‚ïê‚ïê‚ïê
function togTL(){const w=document.getElementById('tlWrap');w.classList.toggle('open');document.getElementById('tlTog').textContent=w.classList.contains('open')?'Hide':'Show';if(w.classList.contains('open'))renderTL()}
function renderTL(){
const tl=document.getElementById('timeline'),tt=getTodayTasks();
if(!tt.length){tl.innerHTML='<div class="empty-tl">No tasks yet.</div>';return}
const sorted=tt.map(t=>({...t,idx:tasks.indexOf(t)})).sort((a,b)=>to24(a.time).localeCompare(to24(b.time)));
tl.innerHTML='';
sorted.forEach((t,i)=>{const isDone=done.includes('t-'+t.idx),el=document.createElement('div');el.className='tl-item';el.style.animationDelay=i*.08+'s';
el.innerHTML='<div class="tl-time">'+t.time+'</div><div class="tl-dot'+(isDone?' dn':'')+'"></div><div class="tl-card'+(isDone?' dn':'')+(t.aiSuggested?' ai':'')+'"><div class="tl-cn"><span>'+t.icon+'</span>'+escHtml(t.name)+(t.aiSuggested?'<span class="tag tag-ai">AI</span>':'')+'</div><div class="tl-cm">'+t.duration+' min'+(t.notes?' ¬∑ '+escHtml(t.notes):'')+'</div></div>';
tl.appendChild(el)});
}

// ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê
function renderEmojiPicker(){const g=document.getElementById('eGrid');g.innerHTML='';EMOJIS.forEach(e=>{const el=document.createElement('div');el.className='eopt'+(e===selEmoji?' sel':'');el.textContent=e;el.onclick=()=>{selEmoji=e;document.querySelectorAll('#eGrid .eopt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel')};g.appendChild(el)})}
function selEP(em){selEmoji=em;document.querySelectorAll('#eGrid .eopt').forEach(el=>el.classList.toggle('sel',el.textContent===em))}
function onSchedChange(){const v=document.getElementById('fSched').value;document.getElementById('fCustomDaysWrap').style.display=v==='custom'?'block':'none';document.getElementById('fDateWrap').style.display=v==='once'?'block':'none';if(v==='custom')renderDayPicker()}
function renderDayPicker(){const wrap=document.getElementById('dayPicker');wrap.innerHTML='';['Su','Mo','Tu','We','Th','Fr','Sa'].forEach((label,i)=>{const el=document.createElement('div');el.className='dp-day'+(customDays.has(i)?' on':'');el.textContent=label;el.onclick=()=>{if(customDays.has(i))customDays.delete(i);else customDays.add(i);el.classList.toggle('on')};wrap.appendChild(el)})}
function openModal(){editIdx=-1;document.getElementById('mTitle').textContent='Add Task';document.getElementById('mSaveBtn').textContent='Add Task';document.getElementById('fName').value='';document.getElementById('fTime').value='09:00';document.getElementById('fDur').value='30';document.getElementById('fPeriod').value='morning';document.getElementById('fNotes').value='';document.getElementById('fSched').value='daily';customDays=new Set();onSchedChange();document.getElementById('fDate').value=new Date().toISOString().split('T')[0];selEP('üéØ');const db=document.getElementById('mDelBtn');if(db)db.remove();document.getElementById('modal').classList.add('show')}
function openEdit(idx){editIdx=idx;const t=tasks[idx];if(!t)return;document.getElementById('mTitle').textContent='Edit Task';document.getElementById('mSaveBtn').textContent='Save Changes';document.getElementById('fName').value=t.name;document.getElementById('fTime').value=to24(t.time);document.getElementById('fDur').value=t.duration;document.getElementById('fPeriod').value=t.period;document.getElementById('fNotes').value=t.notes||'';
const r=t.repeat;customDays=new Set();
if(r===undefined||r===null){document.getElementById('fSched').value=t.date?'once':'daily'}
else if(r==='daily')document.getElementById('fSched').value='daily';
else if(r==='weekdays')document.getElementById('fSched').value='weekdays';
else if(r==='weekends')document.getElementById('fSched').value='weekends';
else if(r==='once')document.getElementById('fSched').value='once';
else if(Array.isArray(r)){document.getElementById('fSched').value='custom';customDays=new Set(r)}
onSchedChange();document.getElementById('fDate').value=t.date||new Date().toISOString().split('T')[0];
selEP(t.icon);const acts=document.getElementById('mActs');let db=document.getElementById('mDelBtn');if(!db){db=document.createElement('button');db.id='mDelBtn';db.className='mbtn mbtn-del';db.textContent='üóëÔ∏è Delete';db.onclick=()=>{const i=editIdx;closeModal();delTask(i)};acts.insertBefore(db,acts.firstChild)}document.getElementById('modal').classList.add('show')}
function closeModal(){document.getElementById('modal').classList.remove('show');editIdx=-1;const db=document.getElementById('mDelBtn');if(db)db.remove()}
function saveTask(){const name=document.getElementById('fName').value.trim();if(!name)return alert('Enter a name');
const time12=to12(document.getElementById('fTime').value),period=document.getElementById('fPeriod').value,duration=parseInt(document.getElementById('fDur').value)||30,notes=document.getElementById('fNotes').value.trim(),sched=document.getElementById('fSched').value;
let repeat,date=null;
if(sched==='daily')repeat='daily';else if(sched==='weekdays')repeat='weekdays';else if(sched==='weekends')repeat='weekends';
else if(sched==='custom'){repeat=[...customDays].sort();if(!repeat.length)return alert('Pick at least one day')}
else if(sched==='once'){repeat='once';date=document.getElementById('fDate').value;if(!date)return alert('Pick a date')}
if(editIdx>=0){tasks[editIdx]={...tasks[editIdx],name,icon:selEmoji,duration,time:time12,period,date,repeat,notes:notes||undefined}}
else{tasks.push({name,icon:selEmoji,duration,time:time12,period,date,repeat,notes:notes||undefined,aiSuggested:false})}
save('routineTasks',tasks);closeModal();render();scheduleNotifications()}

// ‚ïê‚ïê‚ïê VOICE ‚ïê‚ïê‚ïê
function initVoice(){if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window))return;const SR=window.SpeechRecognition||window.webkitSpeechRecognition;recognition=new SR();recognition.continuous=false;recognition.interimResults=false;recognition.lang='en-US';recognition.onresult=e=>{document.getElementById('aiInput').value=e.results[0][0].transcript;stopV();processAI()};recognition.onerror=()=>stopV();recognition.onend=()=>stopV()}
function togVoice(){if(!recognition)return alert('Voice not supported');listening?stopV():startV()}
function startV(){listening=true;try{recognition.start()}catch(e){}document.getElementById('voiceBtn').classList.add('listening');document.getElementById('vIcon').textContent='üî¥'}
function stopV(){listening=false;try{if(recognition)recognition.stop()}catch(e){}document.getElementById('voiceBtn').classList.remove('listening');document.getElementById('vIcon').textContent='üé§'}

// ‚ïê‚ïê‚ïê AI PARSER ‚ïê‚ïê‚ïê
async function processAI(){
const input=document.getElementById('aiInput').value.trim();if(!input)return;
const resp=document.getElementById('aiResp');resp.className='ai-resp thinking show';resp.textContent='Thinking';
await new Promise(r=>setTimeout(r,500));
try{
const parsed=smartParse(input);if(!parsed.length)throw 0;
parsed.forEach(t=>tasks.push({name:t.name,icon:t.icon,duration:t.duration,time:t.time,period:t.period,date:t.date,repeat:t.repeat,notes:t.notes,aiSuggested:true}));
save('routineTasks',tasks);let msg='';
if(parsed.length===1){const t=parsed[0];msg='‚úÖ <strong>'+escHtml(t.icon)+' '+escHtml(t.name)+'</strong> ‚Äî '+schedLabel(t)+' at '+t.time+' ('+t.duration+'m)'}
else{msg='‚úÖ Added '+parsed.length+' tasks:<br>';parsed.forEach(t=>{msg+='&nbsp;&nbsp;'+escHtml(t.icon)+' <strong>'+escHtml(t.name)+'</strong> at '+t.time+' ('+schedLabel(t)+')<br>'})}
resp.className='ai-resp show';resp.innerHTML=msg;document.getElementById('aiInput').value='';render();scheduleNotifications();setTimeout(()=>resp.classList.remove('show'),4500);
}catch(e){resp.className='ai-resp show';resp.innerHTML='‚ùå Try: "Take pill at 2pm and 10pm"';setTimeout(()=>resp.classList.remove('show'),5000)}}

function smartParse(input){const dateResult=extractDate(input);let sharedDate=null,sharedRepeat='daily';
if(dateResult&&typeof dateResult==='object'&&dateResult.repeat){sharedRepeat=dateResult.repeat;sharedDate=null}
else if(typeof dateResult==='string'){sharedDate=dateResult;sharedRepeat='once'}
const allTimes=extractAllTimes(input),sharedDur=extractDur(input);
if(allTimes.length>1){const split=trySplitTasks(input);if(split&&split.length>1)return split.map(seg=>{const t=extractAllTimes(seg)[0]||'5:00 PM';return mkTask(cleanName(seg),t,pickIcon(seg),extractDur(seg)||sharedDur||guessDur(seg),sharedDate,sharedRepeat)});const baseName=cleanName(input);return allTimes.map(t=>mkTask(baseName,t,pickIcon(input),sharedDur||guessDur(input),sharedDate,sharedRepeat))}
const time=allTimes[0]||guessTime(input);return[mkTask(cleanName(input),time,pickIcon(input),sharedDur||guessDur(input),sharedDate,sharedRepeat)]}
function mkTask(name,time,icon,dur,date,repeat){name=(name||'').trim();if(!name||name.length<2)name='Task';name=name.charAt(0).toUpperCase()+name.slice(1);if(!repeat)repeat=date?'once':'daily';return{name,time,icon,duration:dur,date,repeat,period:period4time(time)}}
function extractAllTimes(input){const times=[];const re=/(\d{1,2}):?(\d{2})?\s*(am|pm)/gi;let m;while((m=re.exec(input))!==null){let h=+m[1];const min=m[2]||'00';const mer=m[3].toUpperCase();if(mer==='PM'&&h!==12)h+=12;if(mer==='AM'&&h===12)h=0;times.push((h%12||12)+':'+min+' '+mer)}return times}
function guessTime(input){const l=input.toLowerCase();if(l.includes('morning')||l.includes('breakfast'))return'8:00 AM';if(l.includes('lunch')||l.includes('noon'))return'12:00 PM';if(l.includes('afternoon'))return'3:00 PM';if(l.includes('dinner')||l.includes('evening'))return'6:00 PM';if(l.includes('night')||l.includes('bedtime'))return'9:00 PM';return'5:00 PM'}
function trySplitTasks(input){const parts=input.split(/\s+and\s+|,\s*/i).map(s=>s.trim()).filter(s=>s.length>0);if(parts.length<=1)return null;if(parts.filter(p=>extractAllTimes(p).length>0).length===parts.length)return parts;return null}
function extractDate(input){const l=input.toLowerCase();const today=new Date();
if(/\b(daily|every\s*day|each\s*day)\b/i.test(l))return null;
if(/\b(weekday|weekdays|mon\s*-?\s*fri)\b/i.test(l))return{repeat:'weekdays'};
if(/\b(weekend|weekends?|sat\s*-?\s*sun)\b/i.test(l))return{repeat:'weekends'};
if(/\b(mwf|mon\s*wed\s*fri)\b/i.test(l))return{repeat:[1,3,5]};
if(/\bevery\s+other\s+day\b/i.test(l))return{repeat:[1,3,5]};
const everyMatch=l.match(/every\s+((?:(?:mon|tue|wed|thu|fri|sat|sun|monday|tuesday|wednesday|thursday|friday|saturday|sunday)[\s,and]*)+)/i);
if(everyMatch){const days={sunday:0,sun:0,monday:1,mon:1,tuesday:2,tue:2,tues:2,wednesday:3,wed:3,thursday:4,thu:4,thur:4,thurs:4,friday:5,fri:5,saturday:6,sat:6};const nums=[];for(const[d,n]of Object.entries(days))if(new RegExp('\\b'+d+'\\b','i').test(everyMatch[1])&&!nums.includes(n))nums.push(n);if(nums.length)return{repeat:nums.sort()}}
if(l.includes('tomorrow')){const t=new Date(today);t.setDate(today.getDate()+1);return t.toISOString().split('T')[0]}
if(/\btoday\b/i.test(l))return today.toISOString().split('T')[0];
const days={sunday:0,sun:0,monday:1,mon:1,tuesday:2,tue:2,tues:2,wednesday:3,wed:3,thursday:4,thu:4,thur:4,thurs:4,friday:5,fri:5,saturday:6,sat:6};
for(const[d,n]of Object.entries(days)){if(new RegExp('\\b'+d+'\\b','i').test(l)){let diff=n-today.getDay();if(diff<=0)diff+=7;if(/\bnext\b/i.test(l))diff+=7;const t=new Date(today);t.setDate(today.getDate()+diff);return t.toISOString().split('T')[0]}}return null}
function extractDur(input){const m=input.match(/(\d+)\s*(min|minute|minutes|hour|hours|hr|hrs)\b/i);if(m){const n=+m[1],u=m[2].toLowerCase();return u.startsWith('hour')||u.startsWith('hr')?n*60:n}return null}
function guessDur(input){const l=input.toLowerCase();if(/pill|vitamin|medicine|supplement|water|creatine|greens/.test(l))return 5;if(/call|stretch|quick/.test(l))return 15;if(/meeting|meditat/.test(l))return 30;if(/workout|gym|lunch|dinner/.test(l))return 60;if(/movie/.test(l))return 120;return 30}
function pickIcon(input){const l=input.toLowerCase();const map={pill:'üíä',vitamin:'üíä',medicine:'üíä',supplement:'üíä',creatine:'üíä',greens:'üåø',meeting:'üë•',call:'üìû',workout:'üèãÔ∏è',gym:'üí™',exercise:'üèãÔ∏è',dinner:'üçΩÔ∏è',lunch:'üç±',breakfast:'üç≥',eat:'üç¥',cook:'üë®‚Äçüç≥',movie:'üé¨',shopping:'üõí',doctor:'‚öïÔ∏è',birthday:'üéÇ',party:'üéâ',study:'üìö',read:'üìñ',work:'üíº',code:'üíª',clean:'üßπ',drive:'üöó',travel:'‚úàÔ∏è',music:'üéµ',game:'üéÆ',coffee:'‚òï',water:'üíß',walk:'üö∂',run:'üèÉ',yoga:'üßò',meditat:'üßò',sleep:'üò¥',relax:'üòå',plan:'üìù',journal:'üìù',email:'üìß',pray:'üôè',shower:'üöø',skin:'üß¥',teeth:'ü™•'};for(const[k,v]of Object.entries(map))if(l.includes(k))return v;return'üìã'}
function cleanName(input){let n=input;n=n.replace(/(\d{1,2}):?(\d{2})?\s*(am|pm)/gi,'');n=n.replace(/\b(tomorrow|today|tonight|daily|every\s*day|each\s*day|recurring|weekday|weekdays|weekend|weekends|mwf)\b/gi,'');n=n.replace(/\b(morning|afternoon|evening|night|noon|midnight|bedtime)\b/gi,'');n=n.replace(/\b(monday|tuesday|wednesday|thursday|friday|saturday|sunday|mon|tue|tues|wed|thu|thur|thurs|fri|sat|sun)\b/gi,'');n=n.replace(/\bnext\s*(week)?\b/gi,'');n=n.replace(/\bevery\s*(other\s*day)?\b/gi,'');n=n.replace(/\b(\d+)\s*(min|minute|minutes|hour|hours|hr|hrs)\b/gi,'');n=n.replace(/\b(at|on|for|every|from|until|one|the|a|an|in|and|to|through|thru)\b/gi,'');n=n.replace(/[,;.]+/g,' ');n=n.replace(/\s+/g,' ').trim();n=n.replace(/^[\s,\-‚Äì‚Äî]+|[\s,\-‚Äì‚Äî]+$/g,'').trim();return n}
function resetDay(){done=[];save('completedTasks',done);saveSnapshot();confettiShown=false;localStorage.setItem('lastResetDate',new Date().toDateString());render()}

// ‚ïê‚ïê‚ïê VIEWS ‚ïê‚ïê‚ïê
function switchView(v){
['todayView','statsView','calView','settView'].forEach(id=>document.getElementById(id).style.display='none');
['tabToday','tabStats','tabCal','tabSet'].forEach(id=>document.getElementById(id).classList.remove('active'));
if(v==='today'){document.getElementById('todayView').style.display='block';document.getElementById('tabToday').classList.add('active')}
else if(v==='stats'){document.getElementById('statsView').style.display='block';document.getElementById('tabStats').classList.add('active');renderStats()}
else if(v==='calendar'){document.getElementById('calView').style.display='block';document.getElementById('tabCal').classList.add('active');renderCal()}
else if(v==='settings'){document.getElementById('settView').style.display='block';document.getElementById('tabSet').classList.add('active');renderSettings()}
}

// ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê
function renderStats(){renderSummary();renderOptimizer();renderHeatmap();renderAnalytics();renderDayBars();renderTrends();renderCalTrends()}
function getHistoryDays(n){const result=[],today=new Date();for(let i=n-1;i>=0;i--){const d=new Date(today);d.setDate(today.getDate()-i);const ds=d.toISOString().split('T')[0];const h=history[ds];if(i===0){const tt=getTodayTasks(),total=tt.length,dn=done.length;result.push({date:ds,pct:total?Math.round(dn/total*100):null,done:dn,total,dayOfWeek:d.getDay()})}else if(h)result.push({date:ds,pct:h.pct,done:h.done,total:h.total,dayOfWeek:d.getDay()});else result.push({date:ds,pct:null,done:0,total:0,dayOfWeek:d.getDay()})}return result}

// ‚ïê‚ïê‚ïê DAILY SUMMARY ‚ïê‚ïê‚ïê
function renderSummary(){
const area=document.getElementById('summaryArea');
const tt=getTodayTasks(),dn=done.length,total=tt.length,pct=total?Math.round(dn/total*100):0;
const days7=getHistoryDays(7).filter(d=>d.pct!==null);
const avg7=days7.length?Math.round(days7.reduce((s,d)=>s+d.pct,0)/days7.length):0;
const calTotal=meals.reduce((s,m)=>s+m.cal,0);
const calRemain=calSettings.target-calTotal;
const totalMin=tt.reduce((s,t)=>s+t.duration,0);
const doneMin=tt.filter((_,i)=>done.includes('t-'+tasks.indexOf(tt[i]))).reduce((s,t)=>s+t.duration,0);
// Insights
let insight='';
if(pct===100)insight='üéâ <strong>Perfect day!</strong> Every task completed. Keep the streak alive!';
else if(pct>=75)insight='üí™ <strong>Almost there!</strong> Just '+(total-dn)+' task'+(total-dn>1?'s':'')+' left to finish strong.';
else if(pct>=50)insight='üëç <strong>Halfway done.</strong> Stay focused ‚Äî you\'ve got momentum.';
else if(total>0)insight='üöÄ <strong>Let\'s go!</strong> '+(total-dn)+' tasks waiting. Start with the easiest one.';
else insight='üìã No tasks scheduled today. Add some to get started!';
let html='<div class="sum-grid">';
html+='<div class="sum-box"><div class="sum-val" style="color:var(--accentL)">'+pct+'%</div><div class="sum-lbl">Today</div></div>';
html+='<div class="sum-box"><div class="sum-val" style="color:var(--cyan)">'+avg7+'%</div><div class="sum-lbl">7-Day Avg</div></div>';
html+='<div class="sum-box"><div class="sum-val" style="color:var(--em)">'+(calTotal>0?calTotal.toLocaleString():'‚Äî')+'</div><div class="sum-lbl">Calories</div></div>';
html+='<div class="sum-box"><div class="sum-val" style="color:var(--amber)">'+doneMin+'<span style="font-size:.5em;color:var(--t3)">m</span></div><div class="sum-lbl">Active Time</div></div>';
html+='</div><div class="sum-insight">'+insight+'</div>';
area.innerHTML=html;
}

// ‚ïê‚ïê‚ïê AI ROUTINE OPTIMIZER ‚ïê‚ïê‚ïê
function renderOptimizer(){
const area=document.getElementById('optimizerArea');
const days30=getHistoryDays(30).filter(d=>d.pct!==null);
if(days30.length<3){area.innerHTML='<div class="no-data">Track 3+ days for AI insights!</div>';return}
const suggestions=[];
// Analyze completion by day
const byDay=Array.from({length:7},()=>[]);
days30.forEach(d=>{if(d.pct!==null)byDay[d.dayOfWeek].push(d.pct)});
const dayAvgs=byDay.map(arr=>arr.length?Math.round(arr.reduce((s,v)=>s+v,0)/arr.length):null);
const dayNames=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
// Find weak days
dayAvgs.forEach((avg,i)=>{if(avg!==null&&avg<50)suggestions.push({icon:'üìâ',title:dayNames[i]+'s are tough ('+avg+'% avg)',desc:'Consider reducing tasks or moving harder ones to stronger days.',action:null})});
// Find strong days
const strongDays=dayAvgs.map((a,i)=>({avg:a,day:i})).filter(d=>d.avg!==null&&d.avg>=90);
if(strongDays.length)suggestions.push({icon:'üèÜ',title:'Your best days: '+strongDays.map(d=>dayNames[d.day].slice(0,3)).join(', '),desc:'Schedule your most important tasks on these days for maximum follow-through.',action:null});
// Check evening completion
const tt=getTodayTasks();
const eveningTasks=tt.filter(t=>t.period==='evening');
const eveningDone=eveningTasks.filter(t=>done.includes('t-'+tasks.indexOf(t))).length;
if(eveningTasks.length>3)suggestions.push({icon:'üåô',title:'Heavy evening load ('+eveningTasks.length+' tasks)',desc:'Try moving some tasks to morning when willpower is highest.',action:null});
// Check if too many tasks
const avgTotal=days30.length?Math.round(days30.reduce((s,d)=>s+d.total,0)/days30.length):0;
const avgDone=days30.length?Math.round(days30.reduce((s,d)=>s+d.done,0)/days30.length):0;
if(avgTotal>0&&avgDone/avgTotal<0.6)suggestions.push({icon:'üìã',title:'Consider fewer tasks (avg '+avgTotal+'/day, completing '+avgDone+')',desc:'Quality over quantity. Try removing your least important task to boost completion rate.',action:null});
// Streak tip
if(streak>=7)suggestions.push({icon:'üî•',title:streak+'-day streak! Amazing!',desc:'You\'re building a real habit. Keep the momentum ‚Äî consistency beats perfection.',action:null});
else if(streak===0&&days30.length>=5)suggestions.push({icon:'üí°',title:'Start a new streak today',desc:'Even completing 1 task starts the chain. Don\'t break it!',action:null});
// Calorie insight
const calDays=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];const ch=calHistory[ds];if(ch)calDays.push(ch.total)}
if(calDays.length>=3){const calAvg=Math.round(calDays.reduce((s,v)=>s+v,0)/calDays.length);if(calAvg>calSettings.max)suggestions.push({icon:'üçΩÔ∏è',title:'Calories averaging '+calAvg+' (over max '+calSettings.max+')',desc:'Consider adding smaller meals or reducing portion sizes.',action:null});else if(calAvg<calSettings.target-300)suggestions.push({icon:'‚ö†Ô∏è',title:'Calories averaging '+calAvg+' (under target)',desc:'Make sure you\'re eating enough to fuel your activities.',action:null})}
if(!suggestions.length)suggestions.push({icon:'‚ú®',title:'Looking great!',desc:'Your routine is well-balanced. Keep it up!',action:null});
area.innerHTML=suggestions.map(s=>'<div class="opt-card"><div class="opt-title"><span>'+s.icon+'</span> '+escHtml(s.title)+'</div><div class="opt-desc">'+escHtml(s.desc)+'</div></div>').join('');
}

// ‚ïê‚ïê‚ïê STATS CHARTS (existing) ‚ïê‚ïê‚ïê
function renderHeatmap(){
const area=document.getElementById('heatmapArea'),days=getHistoryDays(84);
const weeks=[];let week=[];for(let i=0;i<days.length;i++){week.push(days[i]);if(week.length===7){weeks.push(week);week=[]}}if(week.length)weeks.push(week);
let html='<div style="display:flex;gap:4px"><div style="display:flex;flex-direction:column;gap:4px;padding-right:6px">';
['','M','','W','','F',''].forEach(d=>html+='<div style="font-family:var(--fm);font-size:.6em;color:var(--t3);height:16px;display:flex;align-items:center;justify-content:flex-end;width:16px">'+d+'</div>');
html+='</div><div style="display:flex;gap:4px;flex:1">';
weeks.forEach(w=>{html+='<div style="display:flex;flex-direction:column;gap:4px;flex:1">';w.forEach(day=>{let bg='var(--bg4)';if(day.pct!==null){if(day.pct===0)bg='var(--bg4)';else if(day.pct<=25)bg='rgba(59,130,246,.2)';else if(day.pct<=50)bg='rgba(59,130,246,.4)';else if(day.pct<=75)bg='rgba(59,130,246,.6)';else if(day.pct<100)bg='rgba(59,130,246,.8)';else bg='var(--accent)'}const tip=day.pct!==null?day.date+': '+day.pct+'%':'no data';html+='<div class="hm-cell" style="background:'+bg+';min-height:16px" data-tip="'+tip+'"></div>'});html+='</div>'});
html+='</div></div>';area.innerHTML=html}
function renderAnalytics(){const days=getHistoryDays(84),tracked=days.filter(d=>d.pct!==null);const avg=tracked.length?Math.round(tracked.reduce((s,d)=>s+d.pct,0)/tracked.length):0;document.getElementById('anAvg').textContent=tracked.length?avg+'%':'‚Äî';document.getElementById('anStreak').textContent=streak;document.getElementById('anTotal').textContent=tracked.length;let best=0,cur=0;getHistoryDays(365).forEach(d=>{if(d.pct!==null&&d.pct===100){cur++;if(cur>best)best=cur}else cur=0});document.getElementById('anBest').textContent=Math.max(best,streak)}
function renderDayBars(){const area=document.getElementById('barArea'),bwArea=document.getElementById('bwArea'),days=getHistoryDays(84);const byDay=Array.from({length:7},()=>[]);days.forEach(d=>{if(d.pct!==null)byDay[d.dayOfWeek].push(d.pct)});const avgs=byDay.map(arr=>arr.length?Math.round(arr.reduce((s,v)=>s+v,0)/arr.length):0);const maxAvg=Math.max(...avgs,1);const labels=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
let html='';avgs.forEach((avg,i)=>{html+='<div class="bar-row"><div class="bar-label">'+labels[i]+'</div><div class="bar-track"><div class="bar-fill" style="width:'+Math.round((avg/maxAvg)*100)+'%"></div></div><div class="bar-pct">'+avg+'%</div></div>'});
if(!days.some(d=>d.pct!==null))html='<div class="no-data">Complete tasks to see patterns!</div>';area.innerHTML=html;
if(days.some(d=>d.pct!==null)){let bestI=0,worstI=0;avgs.forEach((v,i)=>{if(v>avgs[bestI])bestI=i});const nz=avgs.map((v,i)=>byDay[i].length?v:999);worstI=nz.indexOf(Math.min(...nz));if(nz[worstI]===999)worstI=0;
bwArea.innerHTML='<div class="bw-card"><div class="bw-emoji">üèÜ</div><div class="bw-day" style="color:var(--em)">'+labels[bestI]+'</div><div class="bw-sub">Best ¬∑ '+avgs[bestI]+'%</div></div><div class="bw-card"><div class="bw-emoji">üò¥</div><div class="bw-day" style="color:var(--amber)">'+labels[worstI]+'</div><div class="bw-sub">Weakest ¬∑ '+avgs[worstI]+'%</div></div>'}else bwArea.innerHTML=''}
function renderTrends(){const area=document.getElementById('trendArea'),days=getHistoryDays(84),tracked=days.filter(d=>d.pct!==null);
if(tracked.length<3){area.innerHTML='<div class="no-data">Track 3+ days for trends!</div>';return}
let html='';const last7=getHistoryDays(7).filter(d=>d.pct!==null),prev7=getHistoryDays(14).slice(0,7).filter(d=>d.pct!==null);
const thisAvg=last7.length?Math.round(last7.reduce((s,d)=>s+d.pct,0)/last7.length):null,prevAvg=prev7.length?Math.round(prev7.reduce((s,d)=>s+d.pct,0)/prev7.length):null;
if(thisAvg!==null&&prevAvg!==null){const diff=thisAvg-prevAvg;if(diff>5)html+='<div class="trend-row"><div class="trend-icon">üìà</div><div class="trend-text"><div class="trend-title" style="color:var(--em)">Trending Up!</div><div class="trend-sub">This week '+thisAvg+'% vs last '+prevAvg+'%</div></div></div>';else if(diff<-5)html+='<div class="trend-row"><div class="trend-icon">üìâ</div><div class="trend-text"><div class="trend-title" style="color:var(--rose)">Slight Dip</div><div class="trend-sub">This week '+thisAvg+'% vs last '+prevAvg+'%</div></div></div>';else html+='<div class="trend-row"><div class="trend-icon">‚û°Ô∏è</div><div class="trend-text"><div class="trend-title" style="color:var(--accentL)">Holding Steady</div><div class="trend-sub">This week '+thisAvg+'% vs last '+prevAvg+'%</div></div></div>'}
const perfect=tracked.filter(d=>d.pct===100).length;if(perfect>0)html+='<div class="trend-row"><div class="trend-icon">‚≠ê</div><div class="trend-text"><div class="trend-title" style="color:var(--amber)">'+perfect+' Perfect Day'+(perfect>1?'s':'')+'</div><div class="trend-sub">Out of '+tracked.length+' tracked ('+Math.round(perfect/tracked.length*100)+'%)</div></div></div>';
const consistency=tracked.length>=7?Math.round((tracked.filter(d=>d.pct>=50).length/tracked.length)*100):null;
if(consistency!==null){let icon='üî•',label='Excellent!',col='var(--em)';if(consistency<50){icon='üí™';label='Building up';col='var(--amber)'}else if(consistency<75){icon='üëç';label='Getting there';col='var(--accentL)'}html+='<div class="trend-row"><div class="trend-icon">'+icon+'</div><div class="trend-text"><div class="trend-title" style="color:'+col+'">Consistency: '+consistency+'%</div><div class="trend-sub">Days with 50%+ completion</div></div></div>'}
if(!html)html='<div class="no-data">Keep tracking!</div>';area.innerHTML=html}

// ‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê
function renderCal(){const g=document.getElementById('calGrid'),mos=['January','February','March','April','May','June','July','August','September','October','November','December'];document.getElementById('calTitle').textContent=mos[calMo]+' '+calYr;g.innerHTML='';['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{const el=document.createElement('div');el.className='cal-dh';el.textContent=d;g.appendChild(el)});
const first=new Date(calYr,calMo,1).getDay(),daysIn=new Date(calYr,calMo+1,0).getDate(),prev=new Date(calYr,calMo,0).getDate(),todayStr=new Date().toISOString().split('T')[0];
for(let i=first-1;i>=0;i--){const el=document.createElement('div');el.className='cal-d oth';el.innerHTML='<div class="cal-dn">'+(prev-i)+'</div>';g.appendChild(el)}
for(let d=1;d<=daysIn;d++){const ds=calYr+'-'+String(calMo+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');const el=document.createElement('div');el.className='cal-d';if(ds===todayStr)el.classList.add('tod');const dt=tasks.filter(t=>taskShowsOnDate(t,ds));if(dt.length){el.classList.add('ht');const h=history[ds];if(ds===todayStr){if(done.length>=dt.length&&dt.length>0)el.classList.add('ad')}else if(h&&h.pct===100)el.classList.add('ad')}el.innerHTML='<div class="cal-dn">'+d+'</div>';el.onclick=()=>showPanel(ds,dt);g.appendChild(el)}
const rem=42-(first+daysIn);for(let d=1;d<=rem;d++){const el=document.createElement('div');el.className='cal-d oth';el.innerHTML='<div class="cal-dn">'+d+'</div>';g.appendChild(el)}}
function showPanel(ds,dt){document.getElementById('panelTitle').textContent=new Date(ds+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});const c=document.getElementById('panelTasks');c.innerHTML='';const h=history[ds];
if(!dt.length&&!h){c.innerHTML='<p style="text-align:center;color:var(--t3);padding:20px">No tasks this day</p>'}else{
if(h)c.innerHTML+='<div style="text-align:center;padding:12px;margin-bottom:12px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)"><span style="font-size:1.8em;font-weight:800;color:var(--accentL);font-family:var(--fm)">'+h.pct+'%</span><div style="font-size:.8em;color:var(--t3);margin-top:4px">'+h.done+'/'+h.total+' completed</div></div>';
const ch=calHistory[ds];if(ch){const cCol=ch.total>calSettings.max?'var(--rose)':ch.total>calSettings.target?'var(--amber)':'var(--em)';c.innerHTML+='<div style="text-align:center;padding:12px;margin-bottom:12px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)"><span style="font-size:1.4em;font-weight:800;color:'+cCol+';font-family:var(--fm)">üî• '+ch.total.toLocaleString()+' kcal</span><div style="font-size:.78em;color:var(--t3);margin-top:4px">'+ch.meals+' meal'+(ch.meals!==1?'s':'')+' ¬∑ Target: '+calSettings.target.toLocaleString()+'</div>'+(ch.items?'<div style="font-size:.72em;color:var(--t3);margin-top:6px">'+ch.items.map(m=>escHtml(m.name)+' ('+m.cal+')').join(' ¬∑ ')+'</div>':'')+'</div>'}
// Show ICS events for this date
const dayEvs=calEvents.filter(ev=>ev.date===ds);if(dayEvs.length){c.innerHTML+='<div style="font-weight:700;color:#a78bfa;margin-bottom:8px;font-size:.9em">üìÖ Calendar Events</div>';dayEvs.forEach(ev=>{c.innerHTML+='<div class="cal-ev"><div class="cal-ev-time">'+ev.time+'</div><div class="cal-ev-name">'+escHtml(ev.name)+'</div></div>'})}
const gr={morning:[],afternoon:[],evening:[]};dt.forEach(t=>gr[t.period].push(t));const icons={morning:'üåÖ',afternoon:'‚òÄÔ∏è',evening:'üåô'};
['morning','afternoon','evening'].forEach(p=>{if(!gr[p].length)return;const s=document.createElement('div');s.style.marginBottom='16px';s.innerHTML='<div style="font-weight:700;color:var(--accentL);margin-bottom:8px;font-size:.95em">'+icons[p]+' '+p.charAt(0).toUpperCase()+p.slice(1)+'</div>';gr[p].forEach(t=>{const r=document.createElement('div');r.style.cssText='display:flex;align-items:center;padding:12px;margin-bottom:6px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)';r.innerHTML='<span style="font-size:1.4em;margin-right:12px">'+t.icon+'</span><div style="flex:1"><div style="font-weight:600;font-size:.92em">'+escHtml(t.name)+'</div><div style="font-size:.8em;color:var(--t3);font-family:var(--fm)">'+t.time+' ¬∑ '+t.duration+'m</div>'+(t.notes?'<div style="font-size:.75em;color:var(--t3);font-style:italic;margin-top:2px">üìù '+escHtml(t.notes)+'</div>':'')+'</div>';s.appendChild(r)});c.appendChild(s)})}
document.getElementById('dayPanel').classList.add('show')}
function closePanel(){document.getElementById('dayPanel').classList.remove('show')}
function prevMo(){calMo--;if(calMo<0){calMo=11;calYr--}renderCal();closePanel()}
function nextMo(){calMo++;if(calMo>11){calMo=0;calYr++}renderCal();closePanel()}

// ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
function renderSettings(){
document.getElementById('darkToggle').classList.toggle('on',settings.theme==='dark');
document.getElementById('notifToggle').classList.toggle('on',settings.notif);
document.getElementById('notifLead').value=settings.notifLead||10;
const picker=document.getElementById('accentPicker');picker.innerHTML='';
ACCENTS.forEach(a=>{const dot=document.createElement('div');dot.className='acc-dot'+(settings.accent===a.id?' sel':'');dot.style.background=a.color;dot.onclick=()=>{settings.accent=a.id;saveSettings();applySettings();renderSettings()};picker.appendChild(dot)});
renderTemplates();renderCalSettingsFields();renderGoalGrid();renderProfileGrid();
}
function toggleTheme(){settings.theme=settings.theme==='dark'?'light':'dark';saveSettings();applySettings();renderSettings()}
function toggleNotif(){
if(!settings.notif){if('Notification' in window){Notification.requestPermission().then(p=>{if(p==='granted'){settings.notif=true;saveSettings();applySettings();renderSettings();scheduleNotifications()}else{alert('Please allow notifications');settings.notif=false;renderSettings()}})}else{alert('Not supported');return}}
else{settings.notif=false;clearNotifTimers();saveSettings();renderSettings()}}
function saveSettings(){settings.notifLead=parseInt(document.getElementById('notifLead').value)||10;save('appSettings',settings)}
function applySettings(){document.documentElement.setAttribute('data-theme',settings.theme);document.documentElement.setAttribute('data-accent',settings.accent);document.querySelector('meta[name="theme-color"]').content=settings.theme==='dark'?'#030712':'#f8fafc'}
// ‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê
function clearNotifTimers(){notifTimers.forEach(t=>clearTimeout(t));notifTimers=[]}
function scheduleNotifications(){
clearNotifTimers();if(!settings.notif||!('Notification' in window)||Notification.permission!=='granted')return;
const tt=getTodayTasks(),now=new Date(),lead=(settings.notifLead||10)*60*1000;
tt.forEach(t=>{const timeParts=to24(t.time).split(':');const taskDate=new Date();taskDate.setHours(+timeParts[0],+timeParts[1],0,0);
const notifTime=new Date(taskDate.getTime()-lead);const delay=notifTime.getTime()-now.getTime();
if(delay>0&&delay<86400000){notifTimers.push(setTimeout(()=>{if(done.includes('t-'+tasks.indexOf(t)))return;new Notification('‚è∞ '+t.icon+' '+t.name,{body:'Starting in '+(settings.notifLead||10)+' minutes\n'+t.time+' ¬∑ '+t.duration+'m'+(t.notes?'\nüìù '+t.notes:''),tag:'task-'+tasks.indexOf(t)})},delay))}});
}

// ‚ïê‚ïê‚ïê TEMPLATES ‚ïê‚ïê‚ïê
function renderTemplates(){
const grid=document.getElementById('tplGrid');grid.innerHTML='';
if(!templates.length){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--t3);padding:20px;font-style:italic">No templates yet</div>';return}
templates.forEach((tpl,i)=>{const card=document.createElement('div');card.className='tpl-card';card.innerHTML='<div class="tpl-icon">'+tpl.icon+'</div><div class="tpl-name">'+escHtml(tpl.name)+'</div><div class="tpl-count">'+tpl.tasks.length+' tasks</div><div class="tpl-actions"><button class="tpl-btn" onclick="event.stopPropagation();loadTemplate('+i+')">Load</button><button class="tpl-btn danger" onclick="event.stopPropagation();deleteTemplate('+i+')">Delete</button></div>';grid.appendChild(card)});
}
function saveAsTemplate(){
const g=document.getElementById('tplEGrid');g.innerHTML='';tplEmoji='üì¶';
TPL_ICONS.forEach(e=>{const el=document.createElement('div');el.className='eopt'+(e===tplEmoji?' sel':'');el.textContent=e;el.onclick=()=>{tplEmoji=e;document.querySelectorAll('#tplEGrid .eopt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel')};g.appendChild(el)});
document.getElementById('tplName').value='';
document.getElementById('tplModalTitle').textContent='Save as Template';
document.getElementById('tplNameLabel').textContent='Template Name';
document.getElementById('tplSaveBtn').onclick=confirmSaveTemplate;
document.getElementById('tplModal').classList.add('show');
}
function confirmSaveTemplate(){
const name=document.getElementById('tplName').value.trim();if(!name)return alert('Enter a name');
const currentTasks=tasks.filter(t=>t.repeat!=='once').map(t=>({name:t.name,icon:t.icon,duration:t.duration,time:t.time,period:t.period,repeat:t.repeat,notes:t.notes}));
if(!currentTasks.length)return alert('No recurring tasks to save');
templates.push({name,icon:tplEmoji,tasks:currentTasks});save('taskTemplates',templates);
document.getElementById('tplModal').classList.remove('show');renderTemplates();
}
function loadTemplate(idx){const tpl=templates[idx];if(!tpl)return;if(!confirm('Load "'+tpl.name+'" ('+tpl.tasks.length+' tasks)? This will ADD to your current tasks.'))return;
tpl.tasks.forEach(t=>{const exists=tasks.some(et=>et.name===t.name&&et.time===t.time&&et.period===t.period);if(!exists)tasks.push({...t,aiSuggested:false})});
save('routineTasks',tasks);render();scheduleNotifications();switchView('today');
}
function deleteTemplate(idx){if(!confirm('Delete template "'+templates[idx].name+'"?'))return;templates.splice(idx,1);save('taskTemplates',templates);renderTemplates()}

// ‚ïê‚ïê‚ïê PROFILES ‚ïê‚ïê‚ïê
function renderProfileBar(){
const bar=document.getElementById('profileBar');bar.innerHTML='';
if(!profiles.length&&!activeProfile){bar.style.display='none';return}
bar.style.display='flex';
profiles.forEach((p,i)=>{const chip=document.createElement('button');chip.className='prof-chip'+(activeProfile===p.name?' active':'');chip.innerHTML='<span>'+p.icon+'</span><span>'+escHtml(p.name)+'</span>';chip.onclick=()=>loadProfile(i);bar.appendChild(chip)});
const addBtn=document.createElement('button');addBtn.className='prof-add';addBtn.textContent='+ New';addBtn.onclick=()=>switchView('settings');bar.appendChild(addBtn);
}
function renderProfileGrid(){
const grid=document.getElementById('profileGrid');grid.innerHTML='';
if(!profiles.length){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--t3);padding:20px;font-style:italic">No profiles yet. Save your current routine as a profile!</div>';return}
profiles.forEach((p,i)=>{const card=document.createElement('div');card.className='tpl-card';card.innerHTML='<div class="tpl-icon">'+p.icon+'</div><div class="tpl-name">'+escHtml(p.name)+(activeProfile===p.name?' ‚úì':'')+'</div><div class="tpl-count">'+p.tasks.length+' tasks</div><div class="tpl-actions"><button class="tpl-btn" onclick="event.stopPropagation();loadProfile('+i+')">Activate</button><button class="tpl-btn danger" onclick="event.stopPropagation();deleteProfile('+i+')">Delete</button></div>';grid.appendChild(card)});
}
function saveAsProfile(){
const g=document.getElementById('tplEGrid');g.innerHTML='';tplEmoji='üì¶';
const profIcons=['üíº','üèãÔ∏è','üå¥','‚úàÔ∏è','üìö','üéØ','üè†','üéâ'];
profIcons.forEach(e=>{const el=document.createElement('div');el.className='eopt'+(e===tplEmoji?' sel':'');el.textContent=e;el.onclick=()=>{tplEmoji=e;document.querySelectorAll('#tplEGrid .eopt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel')};g.appendChild(el)});
document.getElementById('tplName').value='';
document.getElementById('tplModalTitle').textContent='Save as Profile';
document.getElementById('tplNameLabel').textContent='Profile Name';
document.getElementById('tplSaveBtn').onclick=confirmSaveProfile;
document.getElementById('tplModal').classList.add('show');
}
function confirmSaveProfile(){
const name=document.getElementById('tplName').value.trim();if(!name)return alert('Enter a name');
const snap=tasks.map(t=>({...t}));
profiles.push({name,icon:tplEmoji,tasks:snap});save('routineProfiles',profiles);
activeProfile=name;localStorage.setItem('activeProfile',name);
document.getElementById('tplModal').classList.remove('show');renderProfileBar();renderProfileGrid();
}
function loadProfile(idx){
const p=profiles[idx];if(!p)return;
if(!confirm('Switch to "'+p.name+'"? This replaces all current tasks.'))return;
// Save current as snapshot of active profile
if(activeProfile){const curProf=profiles.find(pr=>pr.name===activeProfile);if(curProf)curProf.tasks=tasks.map(t=>({...t}))}
tasks=p.tasks.map(t=>({...t}));done=[];
activeProfile=p.name;localStorage.setItem('activeProfile',p.name);
save('routineTasks',tasks);save('completedTasks',done);save('routineProfiles',profiles);
confettiShown=false;render();renderProfileBar();scheduleNotifications();switchView('today');
}
function deleteProfile(idx){if(!confirm('Delete profile "'+profiles[idx].name+'"?'))return;
if(activeProfile===profiles[idx].name){activeProfile=null;localStorage.removeItem('activeProfile')}
profiles.splice(idx,1);save('routineProfiles',profiles);renderProfileBar();renderProfileGrid()}


// ‚ïê‚ïê‚ïê GOALS & SUGGESTIONS ‚ïê‚ïê‚ïê
function renderGoalGrid(){
const grid=document.getElementById('goalGrid');grid.innerHTML='';
GOALS.forEach(g=>{const card=document.createElement('div');card.className='goal-card'+(userGoal===g.id?' sel':'');card.innerHTML='<div class="goal-icon">'+g.icon+'</div><div class="goal-name">'+g.name+'</div><div class="goal-desc">'+g.desc+'</div>';card.onclick=()=>{userGoal=userGoal===g.id?null:g.id;localStorage.setItem('userGoal',userGoal||'');renderGoalGrid()};grid.appendChild(card)});
const sugArea=document.getElementById('goalSuggestions');
if(!userGoal){sugArea.innerHTML='';return}
const goal=GOALS.find(g=>g.id===userGoal);if(!goal){sugArea.innerHTML='';return}
let html='<div class="goal-suggest"><div class="goal-suggest-title">Suggested tasks for '+goal.name+'</div>';
goal.tasks.forEach((t,i)=>{const exists=tasks.some(et=>et.name===t.name);
html+='<div class="goal-suggest-item" onclick="addGoalTask(\''+goal.id+'\','+i+')" style="'+(exists?'opacity:.4;pointer-events:none':'')+'"><span>'+t.icon+'</span> <strong>'+t.name+'</strong> - '+t.time+' '+t.duration+'m'+(exists?' (added)':'')+'</div>'});
html+='</div>';sugArea.innerHTML=html;
}
function addGoalTask(goalId,taskIdx){
const goal=GOALS.find(g=>g.id===goalId);if(!goal)return;
const t=goal.tasks[taskIdx];if(!t)return;
if(tasks.some(et=>et.name===t.name))return;
tasks.push({...t,aiSuggested:false,notes:'From '+goal.name+' goal'});
save('routineTasks',tasks);render();scheduleNotifications();renderGoalGrid();
}

// ‚ïê‚ïê‚ïê CALENDAR SYNC (ICS IMPORT) ‚ïê‚ïê‚ïê
function importICS(event){
const file=event.target.files[0];if(!file)return;
const reader=new FileReader();reader.onload=e=>{
try{const text=e.target.result;const events=parseICS(text);
calEvents=[...calEvents,...events];
const seen=new Set();calEvents=calEvents.filter(ev=>{const key=ev.date+ev.time+ev.name;if(seen.has(key))return false;seen.add(key);return true});
save('calEvents',calEvents);renderCalEventsToday();alert('Imported '+events.length+' events!')
}catch(err){alert('Could not parse .ics file')}
};reader.readAsText(file);event.target.value='';
}
function parseICS(text){
const events=[];const blocks=text.split('BEGIN:VEVENT');
for(let i=1;i<blocks.length;i++){
const block=blocks[i].split('END:VEVENT')[0];
let name='Event',date='',time='All day';
const sm=block.match(/SUMMARY[^:]*:(.*)/);if(sm)name=sm[1].trim();
const dt=block.match(/DTSTART[^:]*:(\d{4})(\d{2})(\d{2})T?(\d{2})?(\d{2})?/);
if(dt){date=dt[1]+'-'+dt[2]+'-'+dt[3];if(dt[4]&&dt[5]){let h=+dt[4],m=dt[5];const ap=h>=12?'PM':'AM';h=h%12||12;time=h+':'+m+' '+ap}}
else{const dv=block.match(/DTSTART;VALUE=DATE:(\d{4})(\d{2})(\d{2})/);if(dv)date=dv[1]+'-'+dv[2]+'-'+dv[3]}
if(date)events.push({name,date,time})
}return events
}
function renderCalEventsToday(){
const todayISO=new Date().toISOString().split('T')[0];
const todayEvs=calEvents.filter(ev=>ev.date===todayISO);
const section=document.getElementById('calEvSection'),wrap=document.getElementById('calEvWrap');
if(!todayEvs.length){section.style.display='none';return}
section.style.display='block';wrap.innerHTML='';
todayEvs.forEach(ev=>{wrap.innerHTML+='<div class="cal-ev"><div class="cal-ev-time">'+ev.time+'</div><div class="cal-ev-name">'+escHtml(ev.name)+'</div></div>'})
}
function toggleCalEv(){const w=document.getElementById('calEvWrap'),t=document.getElementById('calEvTog');if(w.style.display==='none'){w.style.display='block';t.textContent='Hide'}else{w.style.display='none';t.textContent='Show'}}
function clearCalEvents(){if(!confirm('Clear all imported calendar events?'))return;calEvents=[];save('calEvents',calEvents);renderCalEventsToday()}

// ‚ïê‚ïê‚ïê VOICE JOURNAL ‚ïê‚ïê‚ïê
function toggleJournalRec(){
if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window)){alert('Voice not supported');return}
if(vjListening){stopJournalRec();return}
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
vjRecognition=new SR();vjRecognition.continuous=true;vjRecognition.interimResults=true;vjRecognition.lang='en-US';
vjTranscriptText='';
vjRecognition.onresult=e=>{let interim='',final='';
for(let i=0;i<e.results.length;i++){if(e.results[i].isFinal)final+=e.results[i][0].transcript+' ';else interim+=e.results[i][0].transcript}
vjTranscriptText=final;
document.getElementById('vjTranscript').textContent=final+(interim?' ...'+interim:'');
document.getElementById('vjTranscript').style.display='block'};
vjRecognition.onerror=()=>stopJournalRec();
vjRecognition.onend=()=>{if(vjListening)stopJournalRec()};
vjListening=true;try{vjRecognition.start()}catch(e){vjListening=false;return}
document.getElementById('vjRecBtn').classList.add('on');
document.getElementById('vjStatus').textContent='Recording... Tap to stop';
}
function stopJournalRec(){
vjListening=false;try{if(vjRecognition)vjRecognition.stop()}catch(e){}
document.getElementById('vjRecBtn').classList.remove('on');
document.getElementById('vjStatus').textContent='Tap to record your reflection';
if(vjTranscriptText.trim()){document.getElementById('vjActions').style.display='flex';generateJournalSummary(vjTranscriptText.trim())}
}
function generateJournalSummary(text){
const words=text.toLowerCase().split(/\s+/);
const pos=['good','great','amazing','awesome','happy','proud','accomplished','excited','love','wonderful','fantastic','productive','well','better','best','fun','enjoyed'];
const neg=['bad','tired','stressed','difficult','hard','frustrated','anxious','overwhelmed','missed','failed','behind','struggle','tough','worried','sad'];
let pScore=0,nScore=0;
words.forEach(w=>{if(pos.some(p=>w.includes(p)))pScore++;if(neg.some(n=>w.includes(n)))nScore++});
let mood='neutral',emoji='üòê';
if(pScore>nScore+1){mood='positive';emoji='üòä'}else if(nScore>pScore+1){mood='reflective';emoji='ü§î'}else if(pScore>0&&nScore>0){mood='mixed';emoji='üîÑ'}
const tt=getTodayTasks(),dn=done.length,pct=tt.length?Math.round(dn/tt.length*100):0;
const calTotal=meals.reduce((s,m)=>s+m.cal,0);
let summary='<strong>'+emoji+' Mood: '+mood.charAt(0).toUpperCase()+mood.slice(1)+'</strong><br>';
summary+='Today you completed '+dn+'/'+tt.length+' tasks ('+pct+'%)';
if(calTotal>0)summary+=' and consumed '+calTotal.toLocaleString()+' calories';
summary+='. ';
if(pScore>nScore)summary+='Sounds like a '+mood+' day! Keep up the great energy.';
else if(nScore>pScore)summary+='Tough day noted. Tomorrow is a fresh start.';
else summary+='Steady progress. Every day counts.';
const sumEl=document.getElementById('vjSummary');sumEl.innerHTML=summary;sumEl.style.display='block';
}
function saveJournalEntry(){
if(!vjTranscriptText.trim())return;
const entry={date:new Date().toISOString(),text:vjTranscriptText.trim(),summary:document.getElementById('vjSummary').innerHTML,pct:getTodayTasks().length?Math.round(done.length/getTodayTasks().length*100):0};
journalEntries.unshift(entry);if(journalEntries.length>30)journalEntries=journalEntries.slice(0,30);
save('journalEntries',journalEntries);clearJournal();renderJournalEntries();
}
function clearJournal(){
vjTranscriptText='';
document.getElementById('vjTranscript').style.display='none';
document.getElementById('vjSummary').style.display='none';
document.getElementById('vjActions').style.display='none';
document.getElementById('vjTranscript').textContent='';
}
function renderJournalEntries(){
const area=document.getElementById('vjEntries');
if(!journalEntries.length){area.innerHTML='';return}
let html='<div class="vj-entries-title">Recent Entries</div>';
journalEntries.slice(0,5).forEach((e,i)=>{
const d=new Date(e.date);
html+='<div class="vj-entry"><button class="vj-entry-del" onclick="deleteJournalEntry('+i+')">x</button><div class="vj-entry-date">'+d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})+' - '+d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})+' - '+e.pct+'% done</div><div class="vj-entry-text">'+escHtml(e.text.slice(0,200))+(e.text.length>200?'...':'')+'</div></div>'});
area.innerHTML=html;
}
function deleteJournalEntry(idx){journalEntries.splice(idx,1);save('journalEntries',journalEntries);renderJournalEntries()}

// ‚ïê‚ïê‚ïê EXPORT/IMPORT ‚ïê‚ïê‚ïê
function exportData(){
const data={tasks,history,templates,settings,streak,done,meals,calHistory,calSettings,profiles,activeProfile,calEvents,journalEntries,userGoal};
const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='routine-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(url)
}
function importData(event){
const file=event.target.files[0];if(!file)return;
const reader=new FileReader();reader.onload=e=>{
try{const data=JSON.parse(e.target.result);
if(data.tasks)tasks=data.tasks;if(data.history)history=data.history;if(data.templates)templates=data.templates;
if(data.settings){settings=data.settings;applySettings()}
if(data.streak!=null)streak=data.streak;if(data.done)done=data.done;
if(data.meals)meals=data.meals;if(data.calHistory)calHistory=data.calHistory;
if(data.calSettings){calSettings=data.calSettings;save('calSettings',calSettings)}
if(data.profiles){profiles=data.profiles;save('routineProfiles',profiles)}
if(data.activeProfile!=null){activeProfile=data.activeProfile;localStorage.setItem('activeProfile',activeProfile||'')}
if(data.calEvents){calEvents=data.calEvents;save('calEvents',calEvents)}
if(data.journalEntries){journalEntries=data.journalEntries;save('journalEntries',journalEntries)}
if(data.userGoal!=null){userGoal=data.userGoal;localStorage.setItem('userGoal',userGoal||'')}
save('routineTasks',tasks);save('dayHistory',history);save('taskTemplates',templates);save('appSettings',settings);save('completedTasks',done);save('todayMeals',meals);save('calHistory',calHistory);localStorage.setItem('streak',streak);
render();renderSettings();renderProfileBar();renderCalEventsToday();renderJournalEntries();
alert('Data imported successfully!')
}catch(err){alert('Invalid file format')}};
reader.readAsText(file);event.target.value='';
}

// ‚ïê‚ïê‚ïê CALORIE TRACKER ‚ïê‚ïê‚ïê
let meals=JSON.parse(localStorage.getItem('todayMeals'))||[];
let calHistory=JSON.parse(localStorage.getItem('calHistory'))||{};
let calSettings=JSON.parse(localStorage.getItem('calSettings'))||{target:2100,max:2300,presets:[{name:'Coffee',cal:50},{name:'Protein Shake',cal:300},{name:'Chicken & Rice',cal:650},{name:'Snack',cal:200}]};
let calMealResetDate=localStorage.getItem('calMealResetDate');

function initCalTracker(){
const today=new Date().toDateString();
if(calMealResetDate!==today){
if(calMealResetDate&&meals.length>0){const yISO=new Date(calMealResetDate).toISOString().split('T')[0];const total=meals.reduce((s,m)=>s+m.cal,0);calHistory[yISO]={total,meals:meals.length,items:[...meals]};save('calHistory',calHistory)}
meals=[];save('todayMeals',meals);localStorage.setItem('calMealResetDate',today)}
renderCalTracker()
}
function renderCalTracker(){
const total=meals.reduce((s,m)=>s+m.cal,0);
const target=calSettings.target,max=calSettings.max;
const pct=max>0?Math.min((total/max)*100,110):0;
const idealPct=max>0?Math.min((target/max)*100,100):0;
document.getElementById('ctCurrent').textContent=total.toLocaleString();
document.getElementById('ctTargetLabel').textContent=target.toLocaleString();
document.getElementById('ctMaxLabel').textContent=max.toLocaleString();
const fill=document.getElementById('ctBarFill');
fill.style.width=Math.min(pct,100)+'%';
fill.className='ct-bar-fill '+(total<=target?'under':total<=max?'ideal':'over');
document.getElementById('ctIdealMark').style.left=idealPct+'%';
document.getElementById('ctMaxMark').style.left='100%';
const remain=target-total;
const remEl=document.getElementById('ctRemain');
remEl.textContent=remain>0?remain.toLocaleString():remain===0?'0':'Over by '+(Math.abs(remain));
remEl.style.color=remain>0?'var(--em)':remain>=(target-max)?'var(--amber)':'var(--rose)';
document.getElementById('ctMealCount').textContent=meals.length;
document.getElementById('ctAvgMeal').textContent=meals.length?Math.round(total/meals.length):'--';
document.getElementById('ctMealTogText').textContent=(document.getElementById('ctMealList').classList.contains('open')?'Hide':'Show')+' meals ('+meals.length+')';
renderQuickBtns();renderMealList()
}
function renderQuickBtns(){
const wrap=document.getElementById('ctQuickBtns');wrap.innerHTML='';
calSettings.presets.forEach(p=>{const btn=document.createElement('button');btn.className='ct-quick';btn.textContent=p.name+' ('+p.cal+')';btn.onclick=()=>{meals.push({name:p.name,cal:p.cal,time:new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})});save('todayMeals',meals);saveCalSnapshot();renderCalTracker()};wrap.appendChild(btn)})
}
function renderMealList(){
const list=document.getElementById('ctMealList');list.innerHTML='';
if(!meals.length){list.innerHTML='<div style="padding:12px;text-align:center;color:var(--t3);font-size:.85em;font-style:italic">No meals logged yet today</div>';return}
[...meals].reverse().forEach((m,ri)=>{const i=meals.length-1-ri;const el=document.createElement('div');el.className='ct-meal';
el.innerHTML='<div class="ct-meal-name">'+escHtml(m.name)+'</div><div class="ct-meal-time">'+m.time+'</div><div class="ct-meal-cal">'+m.cal+' kcal</div><button class="ct-meal-del" onclick="delMeal('+i+')">x</button>';list.appendChild(el)})
}
function addMeal(){
const nameInput=document.getElementById('ctMealName'),calInput=document.getElementById('ctMealCal');
const name=nameInput.value.trim()||'Meal',cal=parseInt(calInput.value);
if(!cal||cal<=0)return alert('Enter calories');
meals.push({name,cal,time:new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})});
save('todayMeals',meals);saveCalSnapshot();nameInput.value='';calInput.value='';renderCalTracker()
}
function delMeal(idx){meals.splice(idx,1);save('todayMeals',meals);saveCalSnapshot();renderCalTracker()}
function toggleMealList(){document.getElementById('ctMealList').classList.toggle('open');renderCalTracker()}
function toggleCtSettings(){switchView('settings')}
function saveCalSnapshot(){const todayISO=new Date().toISOString().split('T')[0];const total=meals.reduce((s,m)=>s+m.cal,0);calHistory[todayISO]={total,meals:meals.length,items:[...meals]};save('calHistory',calHistory)}
function updateCalSettings(){calSettings.target=parseInt(document.getElementById('settCalTarget').value)||2100;calSettings.max=parseInt(document.getElementById('settCalMax').value)||2300;
const presetsRaw=document.getElementById('settCalPresets').value;const presets=[];
presetsRaw.split(',').forEach(p=>{const parts=p.trim().split(':');if(parts.length===2){const name=parts[0].trim(),cal=parseInt(parts[1]);if(name&&cal>0)presets.push({name,cal})}});
if(presets.length)calSettings.presets=presets;save('calSettings',calSettings);renderCalTracker()}
function renderCalSettingsFields(){document.getElementById('settCalTarget').value=calSettings.target;document.getElementById('settCalMax').value=calSettings.max;document.getElementById('settCalPresets').value=calSettings.presets.map(p=>p.name+':'+p.cal).join(', ')}
function renderCalTrends(){
const area=document.getElementById('calTrendArea');const days=[];const today=new Date();
for(let i=6;i>=0;i--){const d=new Date(today);d.setDate(today.getDate()-i);const ds=d.toISOString().split('T')[0];const h=calHistory[ds];
const label=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
if(i===0){const total=meals.reduce((s,m)=>s+m.cal,0);days.push({date:ds,label,total,meals:meals.length})}
else if(h)days.push({date:ds,label,total:h.total,meals:h.meals});
else days.push({date:ds,label,total:null,meals:0})}
const tracked=days.filter(d=>d.total!==null);
if(!tracked.length){area.innerHTML='<div class="no-data">Log calories to see trends!</div>';return}
const maxCal=Math.max(...tracked.map(d=>d.total),calSettings.max);let html='';
days.forEach(d=>{const pct=d.total!==null&&maxCal>0?Math.round((d.total/maxCal)*100):0;
let col='var(--em)';if(d.total!==null){if(d.total>calSettings.max)col='var(--rose)';else if(d.total>calSettings.target)col='var(--amber)'}
const valText=d.total!==null?d.total.toLocaleString()+' kcal':'--';
html+='<div class="bar-row"><div class="bar-label">'+d.label+'</div><div class="bar-track"><div class="bar-fill" style="width:'+pct+'%;background:'+col+'"></div></div><div class="bar-pct" style="color:'+col+'">'+valText+'</div></div>'});
const avg=tracked.length?Math.round(tracked.reduce((s,d)=>s+d.total,0)/tracked.length):0;
const diff=avg-calSettings.target;
html+='<div style="display:flex;gap:12px;margin-top:16px">';
html+='<div class="an-box" style="flex:1"><div class="an-val '+(diff<=0?'green':'amber')+'">'+avg.toLocaleString()+'</div><div class="an-lbl">7-day avg</div></div>';
html+='<div class="an-box" style="flex:1"><div class="an-val '+(diff<=0?'green':'amber')+'">'+(diff>0?'+':'')+diff+'</div><div class="an-lbl">vs target</div></div>';
html+='</div>';area.innerHTML=html}

// POMODORO & FILTER
let _taskFilter="all",_taskSearch="",_pomoTimer=null,_pomoRunning=false,_pomoPhase="focus",_pomoSecsLeft=0,_pomoSession=0;
function filterTasks(){_taskSearch=document.getElementById("taskSearch").value.toLowerCase();const cl=document.getElementById("searchClear");if(cl)cl.style.display=_taskSearch?"":"none";render();}
function clearSearch(){document.getElementById("taskSearch").value="";_taskSearch="";document.getElementById("searchClear").style.display="none";render();}
function setFilter(f,el){_taskFilter=f;document.querySelectorAll(".filter-pill").forEach(p=>p.classList.remove("active"));if(el)el.classList.add("active");render();}
function taskMatchesFilter(t){if(_taskSearch&&!((t.name||"").toLowerCase().includes(_taskSearch)||(t.notes||"").toLowerCase().includes(_taskSearch)))return false;if(_taskFilter==="done")return done.includes(t.idx);if(_taskFilter==="pending")return!done.includes(t.idx);if(_taskFilter==="ai")return!!t.aiSuggested;if(_taskFilter==="morning")return t.period==="morning";if(_taskFilter==="afternoon")return t.period==="afternoon";if(_taskFilter==="evening")return t.period==="evening";return true;}
function openPomo(){document.getElementById("pomoOverlay").style.display="flex";renderPomoDotsRow();updatePomoDisplay();}
function closePomo(){document.getElementById("pomoOverlay").style.display="none";}
function getPFocusMin(){return parseInt(document.getElementById("pomoFocusMin").value)||25;}
function getPBreakMin(){return parseInt(document.getElementById("pomoBreakMin").value)||5;}
function getPSessions(){return parseInt(document.getElementById("pomoSessions").value)||4;}
function renderPomoDotsRow(){const n=getPSessions();let h="";for(let i=0;i<n;i++)h+='<div class="pomo-session-dot'+(i<_pomoSession?' filled':'')+'"></div>';document.getElementById("pomoDotsRow").innerHTML=h;}
function updatePomoDisplay(){const total=(_pomoPhase==="focus"?getPFocusMin():getPBreakMin())*60;const left=_pomoSecsLeft||total;const m=String(Math.floor(left/60)).padStart(2,"0");const s=String(left%60).padStart(2,"0");const el=document.getElementById("pomoDisplay");if(el)el.textContent=m+":"+s;const lbl=document.getElementById("pomoPhaseLabel");if(lbl)lbl.textContent=_pomoPhase==="focus"?"Focus":"Break ‚òï";const fg=document.getElementById("pomoRingFg");if(fg){const circ=2*Math.PI*65;fg.style.strokeDashoffset=circ*(1-left/total);fg.style.strokeDasharray=circ;fg.style.stroke=_pomoPhase==="focus"?"var(--accent)":"#22c55e";}}
function togglePomo(){_pomoRunning?pausePomo():startPomoTimer();}
function startPomoTimer(){if(!_pomoSecsLeft)_pomoSecsLeft=getPFocusMin()*60;_pomoRunning=true;const btn=document.getElementById("pomoBtnGo");if(btn)btn.innerHTML='&#9646;&#9646; Pause';const fab=document.getElementById("pomoFab");if(fab)fab.classList.add("pomo-active");_pomoTimer=setInterval(()=>{_pomoSecsLeft--;updatePomoDisplay();if(_pomoSecsLeft<=0)handlePomoPhaseEnd();},1000);}
function pausePomo(){_pomoRunning=false;clearInterval(_pomoTimer);const btn=document.getElementById("pomoBtnGo");if(btn)btn.innerHTML='&#9654; Resume';}
function handlePomoPhaseEnd(){clearInterval(_pomoTimer);_pomoRunning=false;if(_pomoPhase==="focus"){_pomoSession++;renderPomoDotsRow();_pomoPhase="break";_pomoSecsLeft=(_pomoSession>=getPSessions()?getPBreakMin()*3:getPBreakMin())*60;}else{_pomoPhase="focus";_pomoSecsLeft=getPFocusMin()*60;}updatePomoDisplay();const btn=document.getElementById("pomoBtnGo");if(btn)btn.innerHTML='&#9654; Start';const fab=document.getElementById("pomoFab");if(fab)fab.classList.remove("pomo-active");}
function resetPomo(){clearInterval(_pomoTimer);_pomoRunning=false;_pomoPhase="focus";_pomoSecsLeft=getPFocusMin()*60;const btn=document.getElementById("pomoBtnGo");if(btn)btn.innerHTML='&#9654; Start';const fab=document.getElementById("pomoFab");if(fab)fab.classList.remove("pomo-active");updatePomoDisplay();renderPomoDotsRow();}
function focusOnTask(idx){const t=tasks.find(t=>t.idx===idx);if(t){const lbl=document.getElementById("pomoForLabel");if(lbl)lbl.textContent="Focusing: "+t.name;}openPomo();}

init();
</script>

<!-- Pomodoro Timer -->
<button class="pomo-fab" id="pomoFab" onclick="openPomo()" title="Pomodoro Focus Timer">&#9202;</button>
<div class="pomo-overlay" id="pomoOverlay" style="display:none" onclick="if(event.target===this)closePomo()">
<div class="pomo-modal">
<button class="pomo-close-btn" onclick="closePomo()">&#10005;</button>
<div class="pomo-title">&#9202; Pomodoro Timer</div>
<div class="pomo-for" id="pomoForLabel">Ready to focus</div>
<div class="pomo-ring">
<svg viewBox="0 0 150 150">
<circle class="pomo-ring-bg" cx="75" cy="75" r="65"/>
<circle class="pomo-ring-fg" id="pomoRingFg" cx="75" cy="75" r="65"/>
</svg>
<div class="pomo-ring-time">
<div class="pomo-timer-display" id="pomoDisplay">25:00</div>
<div class="pomo-phase-label" id="pomoPhaseLabel">Focus</div>
</div>
</div>
<div class="pomo-ctrls">
<button class="pomo-btn-go" id="pomoBtnGo" onclick="togglePomo()">&#9654; Start</button>
<button class="pomo-btn-reset" onclick="resetPomo()">&#8635; Reset</button>
</div>
<div class="pomo-sessions-row" id="pomoDotsRow"></div>
<div class="pomo-config">
<label>Focus <input type="number" id="pomoFocusMin" value="25" min="1" max="99" onchange="resetPomo()"/> min</label>
<label>Break <input type="number" id="pomoBreakMin" value="5" min="1" max="30" onchange="resetPomo()"/> min</label>
<label>Sessions <input type="number" id="pomoSessions" value="4" min="1" max="8" onchange="renderPomoDotsRow()"/></label>
</div>
</div>
</div></body>
</html>
