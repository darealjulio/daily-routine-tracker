<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#030712">
<title>Daily Routine Tracker</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRGFpbHkgUm91dGluZSIsInNob3J0X25hbWUiOiJSb3V0aW5lIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMzA3MTIiLCJ0aGVtZV9jb2xvciI6IiMwMzA3MTIifQ==">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg0:#030712;--bg1:#0a1128;--bg2:#0d1b2a;--bg3:#122240;--bg4:#1b2e4a;--b9:#1e3a5f;--b7:#1d4ed8;--b6:#2563eb;--b5:#3b82f6;--b4:#60a5fa;--b3:#93c5fd;--cyan:#22d3ee;--em:#10b981;--rose:#f43f5e;--amber:#f59e0b;--t1:#f0f4ff;--t2:#94a3b8;--t3:#475569;--bd:rgba(59,130,246,.12);--bda:rgba(59,130,246,.4);--glow:rgba(59,130,246,.15);--glowS:rgba(59,130,246,.35);--r1:8px;--r2:14px;--r3:20px;--r4:28px;--sh:0 4px 24px rgba(0,0,0,.4),0 0 0 1px var(--bd);--ff:'Outfit',sans-serif;--fm:'JetBrains Mono',monospace;--accent:var(--b5);--accentD:var(--b6);--accentL:var(--b4)}
[data-theme="light"]{--bg0:#f8fafc;--bg1:#f1f5f9;--bg2:#e2e8f0;--bg3:#cbd5e1;--bg4:#94a3b8;--b9:#64748b;--t1:#0f172a;--t2:#475569;--t3:#94a3b8;--bd:rgba(59,130,246,.15);--bda:rgba(59,130,246,.3);--glow:rgba(59,130,246,.1);--glowS:rgba(59,130,246,.2);--sh:0 4px 24px rgba(0,0,0,.08),0 0 0 1px var(--bd)}
[data-theme="light"] body::before,[data-theme="light"] body::after{display:none}
[data-theme="light"] .check.on::after{color:#fff}
[data-accent="green"]{--accent:#10b981;--accentD:#059669;--accentL:#34d399}
[data-accent="purple"]{--accent:#8b5cf6;--accentD:#7c3aed;--accentL:#a78bfa}
[data-accent="rose"]{--accent:#f43f5e;--accentD:#e11d48;--accentL:#fb7185}
[data-accent="amber"]{--accent:#f59e0b;--accentD:#d97706;--accentL:#fbbf24}
[data-accent="cyan"]{--accent:#22d3ee;--accentD:#06b6d4;--accentL:#67e8f9}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--ff);background:var(--bg0);min-height:100vh;color:var(--t1);overflow-x:hidden;transition:background .3s,color .3s}
body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse 600px 400px at 20% 20%,rgba(29,78,216,.08) 0%,transparent 70%),radial-gradient(ellipse 500px 500px at 80% 80%,rgba(34,211,238,.04) 0%,transparent 70%);z-index:0;pointer-events:none}
body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(59,130,246,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(59,130,246,.03) 1px,transparent 1px);background-size:60px 60px;z-index:0;pointer-events:none}
.app{position:relative;z-index:1;max-width:640px;margin:0 auto;padding:20px 16px 100px}
.nav-tabs{display:flex;gap:4px;background:var(--bg2);padding:5px;border-radius:var(--r3);border:1px solid var(--bd);margin-bottom:28px;position:sticky;top:10px;z-index:100;backdrop-filter:blur(20px)}
.nav-tab{flex:1;display:flex;align-items:center;justify-content:center;gap:5px;padding:11px 6px;border:none;background:transparent;color:var(--t3);border-radius:var(--r2);cursor:pointer;transition:all .3s;font-family:var(--ff);font-size:.82em;font-weight:600}
.nav-tab:hover{color:var(--accentL);background:var(--glow)}
.nav-tab.active{background:linear-gradient(135deg,var(--accentD),var(--accent));color:#fff;box-shadow:0 4px 16px rgba(37,99,235,.35)}
.header{text-align:center;margin-bottom:32px;padding:10px 0}
.header h1{font-size:2.2em;font-weight:800;letter-spacing:-.03em;background:linear-gradient(135deg,var(--b3),var(--accent),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
.date-time{font-family:var(--fm);font-size:.85em;color:var(--t2);letter-spacing:.04em}
.card{background:var(--bg2);border-radius:var(--r4);padding:32px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:20px;position:relative;overflow:hidden;transition:background .3s,border .3s}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.5}
.card-sm{padding:24px}
.ring-container{position:relative;width:180px;height:180px;margin:0 auto 24px}
.ring-bg{fill:none;stroke:var(--bg4);stroke-width:14}
.ring-progress{fill:none;stroke:url(#blueGrad);stroke-width:14;stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1);filter:drop-shadow(0 0 8px rgba(59,130,246,.4))}
.ring-label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.ring-pct{font-size:2.8em;font-weight:800;letter-spacing:-.04em;line-height:1}
.ring-sub{font-size:.75em;color:var(--t2);font-weight:500;margin-top:4px}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.stat-box{text-align:center;padding:16px 8px;background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);transition:background .3s}
.stat-val{font-size:1.8em;font-weight:700;color:var(--accentL);font-family:var(--fm)}
.stat-lbl{font-size:.75em;color:var(--t2);font-weight:500;margin-top:4px;text-transform:uppercase;letter-spacing:.08em}
.empty-state{text-align:center;padding:60px 20px;background:var(--bg2);border-radius:var(--r4);border:1px dashed var(--bda);margin-bottom:24px}
.empty-state-icon{font-size:3.5em;margin-bottom:16px;opacity:.6}
.empty-state h3{font-size:1.3em;font-weight:700;margin-bottom:8px}
.empty-state p{color:var(--t2);font-size:.95em;max-width:300px;margin:0 auto;line-height:1.5}
.period-section{background:var(--bg2);border-radius:var(--r4);border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:16px;overflow:hidden;transition:background .3s}
.period-header{display:flex;align-items:center;padding:18px 22px;cursor:pointer;user-select:none;transition:background .2s}
.period-header:hover{background:var(--glow)}
.period-emoji{font-size:1.4em;margin-right:12px}.period-name{flex:1;font-size:1.05em;font-weight:700}
.period-badge{font-family:var(--fm);font-size:.8em;font-weight:600;background:var(--bg4);color:var(--accentL);padding:4px 12px;border-radius:20px;border:1px solid var(--bd);margin-right:12px}
.chevron{color:var(--t3);transition:transform .3s;font-size:.8em}.chevron.open{transform:rotate(180deg)}
.task-list{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.4,0,.2,1)}.task-list.open{max-height:2000px}
.task-list-inner{padding:0 14px 14px}
.task-item{display:flex;align-items:center;padding:14px 16px;margin-bottom:6px;background:var(--bg1);border-radius:var(--r2);cursor:pointer;transition:all .25s;border:1px solid transparent;position:relative}
.task-item:hover{background:var(--bg4);border-color:var(--bd);transform:translateX(4px)}
.task-item.done{opacity:.45}.task-item.done .tname-text{text-decoration:line-through}
.task-item.dragging{opacity:.5;border:2px dashed var(--accent);transform:scale(.97)}
.task-item .drag-handle{cursor:grab;padding:4px 6px;margin-right:6px;color:var(--t3);font-size:.9em;opacity:.4;transition:opacity .2s}
.task-item:hover .drag-handle{opacity:1}
.temoji{font-size:1.6em;margin-right:14px;flex-shrink:0}.tinfo{flex:1;min-width:0}
.tname{font-weight:600;font-size:.95em;margin-bottom:3px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.tmeta{font-family:var(--fm);font-size:.78em;color:var(--t3)}
.tnotes{font-size:.78em;color:var(--t3);margin-top:2px;font-style:italic;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tag{display:inline-block;font-size:.65em;font-weight:700;padding:2px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.06em}
.tag-ai{background:rgba(34,211,238,.15);color:var(--cyan)}.tag-date{background:rgba(59,130,246,.15);color:var(--b4)}.tag-sched{background:rgba(16,185,129,.15);color:var(--em)}
.tactions{display:flex;align-items:center;gap:2px;margin-left:8px}
.tbtn{background:none;border:none;color:var(--t3);cursor:pointer;padding:6px 8px;border-radius:6px;font-size:.85em;transition:all .2s}
.tbtn:hover{color:var(--accentL);background:var(--glow)}.tbtn.del:hover{color:var(--rose);background:rgba(244,63,94,.1)}
.check{width:26px;height:26px;border:2px solid var(--b9);border-radius:50%;flex-shrink:0;margin-left:6px;display:flex;align-items:center;justify-content:center;transition:all .3s}
.check.on{background:linear-gradient(135deg,var(--accentD),var(--accent));border-color:var(--accent);box-shadow:0 0 12px rgba(59,130,246,.4)}
.check.on::after{content:'‚úì';color:#fff;font-weight:700;font-size:.85em}
.ai-section{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:16px;position:relative;overflow:hidden;transition:background .3s}
.ai-section::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);opacity:.4}
.ai-label{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.ai-label span:first-child{font-size:1.3em}
.ai-label-text{font-weight:700;font-size:1.05em;background:linear-gradient(135deg,var(--accentL),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.ai-examples{font-size:.78em;color:var(--t3);margin-bottom:14px;line-height:1.7;padding:10px 14px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)}
.ai-examples strong{color:var(--t2)}
.ai-row{display:flex;gap:8px}
.ai-input{flex:1;padding:14px 18px;border:1px solid var(--bd);background:var(--bg1);color:var(--t1);border-radius:var(--r2);font-family:var(--ff);font-size:.92em;transition:all .3s}
.ai-input::placeholder{color:var(--t3)}.ai-input:focus{outline:none;border-color:var(--accent);background:var(--bg2)}
.ibtn{width:50px;height:50px;border:1px solid var(--bd);background:var(--bg1);color:var(--accentL);border-radius:var(--r2);font-size:1.15em;cursor:pointer;transition:all .3s;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.ibtn:hover{background:var(--glow);border-color:var(--accent)}
.ibtn.listening{background:var(--rose);border-color:var(--rose);color:#fff;animation:pmic 1.5s infinite}
@keyframes pmic{0%,100%{box-shadow:0 0 0 0 rgba(244,63,94,.4)}50%{box-shadow:0 0 0 10px rgba(244,63,94,0)}}
.sbtn{padding:0 22px;height:50px;border:none;background:linear-gradient(135deg,var(--accentD),var(--accent));color:#fff;border-radius:var(--r2);font-family:var(--ff);font-weight:700;font-size:.9em;cursor:pointer;transition:all .3s;flex-shrink:0}
.sbtn:hover{box-shadow:0 4px 16px rgba(37,99,235,.4);transform:translateY(-1px)}
.ai-resp{margin-top:14px;padding:14px 18px;background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);font-size:.9em;color:var(--t2);display:none;animation:sUp .3s ease;line-height:1.5}
.ai-resp.show{display:block}.ai-resp.thinking{display:flex;align-items:center;gap:8px;color:var(--accentL);font-weight:600}
@keyframes sUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.tl-section{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:16px;transition:background .3s}
.tl-head{display:flex;justify-content:space-between;align-items:center}
.tl-title{font-weight:700;font-size:1.05em;background:linear-gradient(135deg,var(--accentL),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.togbtn{padding:8px 18px;background:var(--bg1);border:1px solid var(--bd);color:var(--accentL);border-radius:var(--r1);font-family:var(--ff);font-weight:600;font-size:.82em;cursor:pointer;transition:all .3s}
.togbtn:hover{background:var(--glow);border-color:var(--accent)}
.tl-wrap{margin-top:20px;display:none}.tl-wrap.open{display:block}
.timeline{position:relative;padding:10px 0}
.timeline::before{content:'';position:absolute;left:42px;top:0;bottom:0;width:2px;background:linear-gradient(180deg,var(--accent),var(--b9),transparent)}
.tl-item{display:flex;align-items:flex-start;margin-bottom:16px;position:relative;animation:fSlide .4s ease both}
@keyframes fSlide{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
.tl-time{width:70px;text-align:right;padding-right:16px;font-family:var(--fm);font-size:.78em;font-weight:600;color:var(--accentL);padding-top:2px;flex-shrink:0}
.tl-dot{width:12px;height:12px;border:2px solid var(--accent);background:var(--bg0);border-radius:50%;position:absolute;left:37px;top:6px;z-index:1}
.tl-dot.dn{background:var(--accent);box-shadow:0 0 10px rgba(59,130,246,.5)}
.tl-card{flex:1;background:var(--bg1);padding:14px 18px;border-radius:var(--r2);margin-left:24px;border:1px solid var(--bd);transition:background .3s}
.tl-card.dn{opacity:.4}.tl-card.ai{border-left:3px solid var(--cyan)}
.tl-cn{font-weight:600;font-size:.95em;display:flex;align-items:center;gap:8px}
.tl-cm{font-size:.8em;color:var(--t3);margin-top:4px}
.empty-tl{text-align:center;padding:30px;color:var(--t3);font-style:italic}
.act-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
.act-btn{padding:16px;border-radius:var(--r2);font-family:var(--ff);font-weight:700;font-size:.92em;cursor:pointer;transition:all .3s;border:1px solid var(--bd)}
.btn-rst{background:var(--bg2);color:var(--t2)}.btn-rst:hover{background:var(--bg4);color:var(--t1)}
.btn-add{background:linear-gradient(135deg,var(--accentD),var(--accent));color:#fff;border:none;box-shadow:0 4px 16px rgba(37,99,235,.3)}
.btn-add:hover{box-shadow:0 6px 24px rgba(37,99,235,.45);transform:translateY(-2px)}
.quote{text-align:center;padding:22px 28px;background:var(--bg2);border-radius:var(--r3);border:1px solid var(--bd);color:var(--t2);font-style:italic;font-size:.95em;line-height:1.6;margin-bottom:20px;transition:background .3s}
/* Modal */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal-bg.show{display:flex}
.modal-box{background:var(--bg2);border:1px solid var(--bda);border-radius:var(--r4);padding:32px;width:100%;max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,.6);position:relative;overflow:hidden;max-height:90vh;overflow-y:auto}
.modal-box::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
.mtitle{font-size:1.4em;font-weight:800;margin-bottom:24px;background:linear-gradient(135deg,var(--b3),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.field{margin-bottom:20px}
.flabel{display:block;font-weight:600;font-size:.85em;color:var(--t2);margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em}
.finput,.fselect{width:100%;padding:13px 16px;background:var(--bg1);border:1px solid var(--bd);color:var(--t1);border-radius:var(--r1);font-family:var(--ff);font-size:.95em;transition:all .3s}
.finput:focus,.fselect:focus{outline:none;border-color:var(--accent);background:var(--bg2)}
.fselect option{background:var(--bg2);color:var(--t1)}
.egrid{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}
.eopt{font-size:1.7em;text-align:center;padding:8px;border-radius:var(--r1);cursor:pointer;transition:all .2s;border:2px solid transparent}
.eopt:hover{background:var(--glow);transform:scale(1.15)}
.eopt.sel{background:var(--glowS);border-color:var(--accent);transform:scale(1.15)}
.mactions{display:flex;gap:10px;margin-top:28px}
.mbtn{flex:1;padding:14px;border-radius:var(--r1);font-family:var(--ff);font-weight:700;font-size:.95em;cursor:pointer;transition:all .3s}
.mbtn-cancel{background:var(--bg1);border:1px solid var(--bd);color:var(--t2)}.mbtn-cancel:hover{background:var(--bg4);color:var(--t1)}
.mbtn-save{background:linear-gradient(135deg,var(--accentD),var(--accent));border:none;color:#fff}.mbtn-save:hover{box-shadow:0 6px 24px rgba(37,99,235,.5)}
.mbtn-del{background:rgba(244,63,94,.15);border:1px solid rgba(244,63,94,.3);color:var(--rose);flex:0 0 auto;padding:14px 20px}.mbtn-del:hover{background:rgba(244,63,94,.25)}
.day-picker{display:flex;gap:6px;flex-wrap:wrap}
.dp-day{width:42px;height:42px;display:flex;align-items:center;justify-content:center;border-radius:var(--r1);border:2px solid var(--bd);background:var(--bg1);color:var(--t2);font-family:var(--fm);font-size:.78em;font-weight:700;cursor:pointer;transition:all .2s;user-select:none}
.dp-day:hover{border-color:var(--accent);color:var(--accentL)}
.dp-day.on{background:var(--glowS);border-color:var(--accent);color:var(--t1)}
/* Calendar */
.cal-hdr{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;background:var(--bg2);border-radius:var(--r4);border:1px solid var(--bd);margin-bottom:16px;transition:background .3s}
.cal-title{font-size:1.3em;font-weight:800;background:linear-gradient(135deg,var(--b3),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.cal-nav{width:40px;height:40px;background:var(--bg1);border:1px solid var(--bd);color:var(--accentL);border-radius:var(--r1);font-size:1.3em;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center}
.cal-nav:hover{background:var(--glow);border-color:var(--accent)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:20px;background:var(--bg2);border-radius:var(--r4);border:1px solid var(--bd);margin-bottom:16px;transition:background .3s}
.cal-dh{text-align:center;font-family:var(--fm);font-weight:600;font-size:.75em;color:var(--t3);padding:8px;text-transform:uppercase}
.cal-d{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:var(--r1);cursor:pointer;transition:all .25s;border:1px solid transparent;position:relative;background:var(--bg1)}
.cal-d:hover{background:var(--bg4);border-color:var(--bd)}
.cal-d.oth{opacity:.2;cursor:default;background:transparent}.cal-d.oth:hover{background:transparent;border-color:transparent}
.cal-d.tod{border-color:var(--accent);background:var(--glow)}
.cal-d.ht::after{content:'';position:absolute;bottom:4px;width:5px;height:5px;background:var(--accent);border-radius:50%}
.cal-d.ad::after{background:var(--em)}
.cal-dn{font-weight:600;font-size:.95em}
.cal-legend{display:flex;gap:20px;justify-content:center;padding:14px;background:var(--bg2);border-radius:var(--r2);border:1px solid var(--bd);margin-bottom:16px;transition:background .3s}
.leg-item{display:flex;align-items:center;gap:8px;color:var(--t2);font-size:.82em}.leg-dot{width:10px;height:10px;border-radius:50%}
.day-panel{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);margin-top:16px;animation:sUp .3s ease;display:none;transition:background .3s}
.day-panel.show{display:block}
.dp-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.dp-title{font-weight:700;font-size:1.15em;background:linear-gradient(135deg,var(--accentL),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.dp-close{width:32px;height:32px;background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.2);color:var(--rose);border-radius:50%;font-size:1em;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center}
.dp-close:hover{background:rgba(244,63,94,.2);transform:rotate(90deg)}
/* Stats */
.sec-title{font-weight:800;font-size:1.15em;margin-bottom:20px;background:linear-gradient(135deg,var(--b3),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hm-cell{aspect-ratio:1;border-radius:4px;cursor:default;position:relative;transition:transform .15s}
.hm-cell:hover{transform:scale(1.4);z-index:2}
.hm-cell[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg4);color:var(--t1);padding:4px 10px;border-radius:6px;font-size:.7em;white-space:nowrap;z-index:10;border:1px solid var(--bd);font-family:var(--fm);pointer-events:none}
.hm-legend{display:flex;align-items:center;gap:8px;justify-content:flex-end;margin-top:12px;font-size:.72em;color:var(--t3)}
.hm-lcells{display:flex;gap:3px}.hm-lc{width:14px;height:14px;border-radius:3px}
.an-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.an-box{background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);padding:18px;text-align:center;transition:background .3s}
.an-val{font-size:1.6em;font-weight:800;font-family:var(--fm);margin-bottom:4px}
.an-val.blue{color:var(--accentL)}.an-val.cyan{color:var(--cyan)}.an-val.green{color:var(--em)}.an-val.amber{color:var(--amber)}
.an-lbl{font-size:.75em;color:var(--t2);text-transform:uppercase;letter-spacing:.06em;font-weight:600}
.bar-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.bar-label{width:36px;font-family:var(--fm);font-size:.75em;color:var(--t2);font-weight:600;text-align:right;flex-shrink:0}
.bar-track{flex:1;height:28px;background:var(--bg1);border-radius:6px;overflow:hidden;border:1px solid var(--bd)}
.bar-fill{height:100%;border-radius:6px;transition:width .8s cubic-bezier(.4,0,.2,1);background:linear-gradient(90deg,var(--accentD),var(--accent));min-width:0}
.bar-pct{font-family:var(--fm);font-size:.72em;font-weight:700;color:var(--t2);width:38px;text-align:left;flex-shrink:0}
.bw-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
.bw-card{padding:16px;background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);text-align:center;transition:background .3s}
.bw-emoji{font-size:2em;margin-bottom:6px}.bw-day{font-weight:700;font-size:1em;margin-bottom:2px}.bw-sub{font-size:.75em;color:var(--t3)}
.trend-row{display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg1);border-radius:var(--r2);border:1px solid var(--bd);margin-bottom:10px;transition:background .3s}
.trend-icon{font-size:2em}.trend-text{flex:1}.trend-title{font-weight:700;font-size:.95em;margin-bottom:2px}.trend-sub{font-size:.82em;color:var(--t2)}
.no-data{text-align:center;padding:40px;color:var(--t3);font-style:italic}
/* Settings */
.settings-section{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:16px;transition:background .3s}
.sett-title{font-weight:700;font-size:.95em;color:var(--t2);margin-bottom:16px;text-transform:uppercase;letter-spacing:.06em;font-size:.82em}
.sett-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--bd)}
.sett-row:last-child{border-bottom:none}
.sett-label{font-weight:600;font-size:.92em}
.sett-desc{font-size:.78em;color:var(--t3);margin-top:2px}
.toggle-sw{position:relative;width:52px;height:28px;background:var(--bg4);border-radius:14px;cursor:pointer;transition:background .3s;flex-shrink:0;border:none}
.toggle-sw.on{background:var(--accent)}
.toggle-sw::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:50%;transition:transform .3s;box-shadow:0 2px 6px rgba(0,0,0,.3)}
.toggle-sw.on::after{transform:translateX(24px)}
.accent-picker{display:flex;gap:8px;flex-wrap:wrap}
.acc-dot{width:32px;height:32px;border-radius:50%;cursor:pointer;transition:all .2s;border:3px solid transparent}
.acc-dot:hover{transform:scale(1.2)}
.acc-dot.sel{border-color:var(--t1);box-shadow:0 0 16px rgba(59,130,246,.4)}
/* Templates */
.tpl-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.tpl-card{background:var(--bg1);border:1px solid var(--bd);border-radius:var(--r2);padding:16px;cursor:pointer;transition:all .25s;text-align:center}
.tpl-card:hover{background:var(--bg4);border-color:var(--accent);transform:translateY(-2px)}
.tpl-icon{font-size:2em;margin-bottom:8px}
.tpl-name{font-weight:700;font-size:.9em;margin-bottom:4px}
.tpl-count{font-size:.75em;color:var(--t3)}
.tpl-actions{display:flex;gap:6px;margin-top:10px;justify-content:center}
.tpl-btn{padding:6px 14px;border:1px solid var(--bd);background:var(--bg2);color:var(--t2);border-radius:6px;font-family:var(--ff);font-size:.75em;font-weight:600;cursor:pointer;transition:all .2s}
.tpl-btn:hover{border-color:var(--accent);color:var(--accentL)}
.tpl-btn.danger:hover{border-color:var(--rose);color:var(--rose)}
/* Calorie Tracker */
.cal-tracker{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:16px;position:relative;overflow:hidden;transition:background .3s}
.cal-tracker::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--em),transparent);opacity:.5}
.ct-header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.ct-header-icon{font-size:1.3em}
.ct-header-text{font-weight:700;font-size:1.05em;background:linear-gradient(135deg,var(--em),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.ct-summary{display:flex;align-items:baseline;gap:8px;margin-bottom:6px}
.ct-current{font-family:var(--fm);font-size:2.2em;font-weight:800;color:var(--t1)}
.ct-of{font-size:.85em;color:var(--t3)}
.ct-target-val{font-family:var(--fm);font-weight:700;color:var(--t2)}
.ct-bar-wrap{position:relative;height:32px;background:var(--bg1);border-radius:8px;border:1px solid var(--bd);margin-bottom:8px;overflow:visible}
.ct-bar-fill{height:100%;border-radius:8px;transition:width .6s cubic-bezier(.4,0,.2,1);position:relative;z-index:1}
.ct-bar-fill.green{background:linear-gradient(90deg,#059669,#10b981)}
.ct-bar-fill.amber{background:linear-gradient(90deg,#d97706,#f59e0b)}
.ct-bar-fill.red{background:linear-gradient(90deg,#dc2626,#ef4444)}
.ct-marker{position:absolute;top:-4px;bottom:-4px;width:3px;border-radius:2px;z-index:2;transition:left .3s}
.ct-marker::after{content:attr(data-label);position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-family:var(--fm);font-size:.6em;font-weight:700;white-space:nowrap;padding:2px 6px;border-radius:4px}
.ct-marker.ideal{background:var(--em)}.ct-marker.ideal::after{color:var(--em);background:rgba(16,185,129,.15)}
.ct-marker.max{background:var(--rose)}.ct-marker.max::after{color:var(--rose);background:rgba(244,63,94,.15)}
.ct-remaining{font-family:var(--fm);font-size:.82em;color:var(--t3);margin-bottom:16px}
.ct-remaining strong{color:var(--t2)}
.ct-meals{margin-bottom:16px}
.ct-meal{display:flex;align-items:center;padding:10px 14px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd);margin-bottom:6px;animation:sUp .25s ease;transition:background .2s}
.ct-meal:hover{background:var(--bg4)}
.ct-meal-icon{font-size:1.2em;margin-right:10px;flex-shrink:0}
.ct-meal-info{flex:1;min-width:0}
.ct-meal-name{font-weight:600;font-size:.88em}
.ct-meal-time{font-family:var(--fm);font-size:.72em;color:var(--t3)}
.ct-meal-cal{font-family:var(--fm);font-weight:700;font-size:.9em;color:var(--em);margin:0 8px}
.ct-meal-del{background:none;border:none;color:var(--t3);cursor:pointer;padding:4px 6px;border-radius:4px;font-size:.8em;transition:all .2s}
.ct-meal-del:hover{color:var(--rose);background:rgba(244,63,94,.1)}
.ct-add-row{display:flex;gap:8px}
.ct-add-input{flex:1;padding:12px 16px;background:var(--bg1);border:1px solid var(--bd);color:var(--t1);border-radius:var(--r1);font-family:var(--ff);font-size:.9em;transition:all .3s}
.ct-add-input:focus{outline:none;border-color:var(--em);background:var(--bg2)}
.ct-add-input::placeholder{color:var(--t3)}
.ct-add-cal{width:100px;padding:12px;background:var(--bg1);border:1px solid var(--bd);color:var(--t1);border-radius:var(--r1);font-family:var(--fm);font-size:.9em;text-align:center;transition:all .3s;flex-shrink:0}
.ct-add-cal:focus{outline:none;border-color:var(--em)}
.ct-add-btn{padding:12px 20px;background:linear-gradient(135deg,#059669,#10b981);border:none;color:#fff;border-radius:var(--r1);font-family:var(--ff);font-weight:700;font-size:.9em;cursor:pointer;transition:all .3s;flex-shrink:0}
.ct-add-btn:hover{box-shadow:0 4px 16px rgba(16,185,129,.4);transform:translateY(-1px)}
.ct-macros{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--bd)}
.ct-macro{text-align:center;padding:8px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)}
.ct-macro-val{font-family:var(--fm);font-weight:700;font-size:1em;margin-bottom:2px}
.ct-macro-lbl{font-size:.65em;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;font-weight:600}
.ct-quick-btns{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.ct-quick{padding:6px 14px;background:var(--bg1);border:1px solid var(--bd);color:var(--t2);border-radius:20px;font-family:var(--ff);font-size:.75em;font-weight:600;cursor:pointer;transition:all .2s}
.ct-quick:hover{border-color:var(--em);color:var(--em);background:rgba(16,185,129,.1)}
.notif-badge{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:6px}
/* Calorie Tracker */
.ct-card{background:var(--bg2);border-radius:var(--r4);padding:24px;border:1px solid var(--bd);box-shadow:var(--sh);margin-bottom:20px;position:relative;overflow:hidden;transition:background .3s}
.ct-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--em),transparent);opacity:.5}
.ct-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.ct-title{font-weight:700;font-size:1.05em;display:flex;align-items:center;gap:8px}
.ct-title-text{background:linear-gradient(135deg,var(--em),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.ct-cals{font-family:var(--fm);font-size:1.6em;font-weight:800;text-align:center;margin-bottom:4px}
.ct-cals-sub{font-size:.78em;color:var(--t3);text-align:center;margin-bottom:16px;font-family:var(--fm)}
.ct-bar-wrap{position:relative;height:32px;background:var(--bg1);border-radius:16px;border:1px solid var(--bd);overflow:visible;margin-bottom:20px}
.ct-bar-fill{height:100%;border-radius:16px;transition:width .6s cubic-bezier(.4,0,.2,1);position:relative;z-index:1}
.ct-bar-fill.under{background:linear-gradient(90deg,var(--em),#34d399)}
.ct-bar-fill.ideal{background:linear-gradient(90deg,#34d399,var(--amber))}
.ct-bar-fill.over{background:linear-gradient(90deg,var(--amber),var(--rose))}
.ct-marker{position:absolute;top:-6px;bottom:-6px;width:3px;border-radius:2px;z-index:2;transition:left .3s}
.ct-marker-label{position:absolute;top:-22px;left:50%;transform:translateX(-50%);font-family:var(--fm);font-size:.6em;font-weight:700;white-space:nowrap;padding:2px 6px;border-radius:4px}
.ct-marker.ideal{background:var(--em)}
.ct-marker.ideal .ct-marker-label{color:var(--em);background:rgba(16,185,129,.15)}
.ct-marker.max{background:var(--rose)}
.ct-marker.max .ct-marker-label{color:var(--rose);background:rgba(244,63,94,.15)}
.ct-add-row{display:flex;gap:8px;margin-bottom:12px}
.ct-add-input{flex:1;padding:12px 16px;border:1px solid var(--bd);background:var(--bg1);color:var(--t1);border-radius:var(--r1);font-family:var(--fm);font-size:.95em;transition:all .3s}
.ct-add-input::placeholder{color:var(--t3)}
.ct-add-input:focus{outline:none;border-color:var(--em);background:var(--bg2)}
.ct-add-name{flex:1.5}
.ct-add-cal{flex:0.8;max-width:100px}
.ct-add-btn{padding:12px 20px;border:none;background:linear-gradient(135deg,#059669,var(--em));color:#fff;border-radius:var(--r1);font-family:var(--ff);font-weight:700;font-size:.85em;cursor:pointer;transition:all .3s;flex-shrink:0}
.ct-add-btn:hover{box-shadow:0 4px 16px rgba(16,185,129,.4);transform:translateY(-1px)}
.ct-meals{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.4,0,.2,1)}
.ct-meals.open{max-height:500px}
.ct-meal{display:flex;align-items:center;padding:10px 14px;margin-bottom:4px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd);transition:all .2s}
.ct-meal:hover{background:var(--bg4)}
.ct-meal-name{flex:1;font-weight:600;font-size:.88em}
.ct-meal-cal{font-family:var(--fm);font-size:.85em;font-weight:700;color:var(--em);margin-right:12px}
.ct-meal-time{font-family:var(--fm);font-size:.72em;color:var(--t3);margin-right:10px}
.ct-meal-del{background:none;border:none;color:var(--t3);cursor:pointer;font-size:.8em;padding:4px 8px;border-radius:4px;transition:all .2s}
.ct-meal-del:hover{color:var(--rose);background:rgba(244,63,94,.1)}
.ct-toggle-meals{background:none;border:none;color:var(--t3);font-family:var(--ff);font-size:.8em;cursor:pointer;padding:6px 0;font-weight:600;transition:color .2s}
.ct-toggle-meals:hover{color:var(--accentL)}
.ct-quick-btns{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.ct-quick{padding:6px 12px;border:1px solid var(--bd);background:var(--bg1);color:var(--t2);border-radius:20px;font-family:var(--ff);font-size:.75em;font-weight:600;cursor:pointer;transition:all .2s}
.ct-quick:hover{border-color:var(--em);color:var(--em);background:rgba(16,185,129,.1)}
.ct-macros{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
.ct-macro{text-align:center;padding:10px 6px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)}
.ct-macro-val{font-family:var(--fm);font-weight:700;font-size:1.1em;margin-bottom:2px}
.ct-macro-lbl{font-size:.68em;color:var(--t3);text-transform:uppercase;font-weight:600;letter-spacing:.06em}
@media(max-width:480px){.header h1{font-size:1.7em}.egrid{grid-template-columns:repeat(6,1fr)}.stats-row{gap:8px}.stat-val{font-size:1.4em}.ai-row{flex-wrap:wrap}.ai-input{min-width:100%}.nav-tab{font-size:.75em;padding:10px 4px;gap:3px}.tpl-grid{grid-template-columns:1fr}.ct-add-row{flex-wrap:wrap}.ct-add-input{min-width:0}}
</style>
</head>
<body>
<div class="app">
<div class="nav-tabs">
<button class="nav-tab active" onclick="switchView('today')" id="tabToday"><span>üìã</span><span>Today</span></button>
<button class="nav-tab" onclick="switchView('stats')" id="tabStats"><span>üìä</span><span>Stats</span></button>
<button class="nav-tab" onclick="switchView('calendar')" id="tabCal"><span>üóìÔ∏è</span><span>Calendar</span></button>
<button class="nav-tab" onclick="switchView('settings')" id="tabSet"><span>‚öôÔ∏è</span><span>Settings</span></button>
</div>
<div class="header"><h1>Daily Routine</h1><div class="date-time" id="dateTime"></div></div>

<!-- TODAY -->
<div id="todayView">
<div class="card">
<div class="ring-container"><svg width="180" height="180"><defs><linearGradient id="blueGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:var(--accent)"/><stop offset="100%" style="stop-color:var(--cyan)"/></linearGradient></defs><circle class="ring-bg" cx="90" cy="90" r="80"/><circle class="ring-progress" cx="90" cy="90" r="80" id="progressRing"/></svg><div class="ring-label"><div class="ring-pct" id="pctText">0%</div><div class="ring-sub">completed</div></div></div>
<div class="stats-row"><div class="stat-box"><div class="stat-val" id="doneN">0</div><div class="stat-lbl">Done</div></div><div class="stat-box"><div class="stat-val" id="leftN">0</div><div class="stat-lbl">Left</div></div><div class="stat-box"><div class="stat-val" id="streakN">0</div><div class="stat-lbl">Streak</div></div></div>
</div>
<div class="ct-card" id="ctCard">
<div class="ct-header"><div class="ct-title"><span>üî•</span><span class="ct-title-text">Calorie Tracker</span></div><button class="togbtn" onclick="toggleCtSettings()" id="ctSettBtn" style="font-size:.72em;padding:6px 12px">‚öôÔ∏è</button></div>
<div class="ct-cals"><span id="ctCurrent">0</span> <span style="font-size:.5em;color:var(--t3)">kcal</span></div>
<div class="ct-cals-sub">Target: <span id="ctTargetLabel">2,100</span> ¬∑ Max: <span id="ctMaxLabel">2,300</span></div>
<div class="ct-bar-wrap"><div class="ct-bar-fill under" id="ctBarFill" style="width:0%"></div><div class="ct-marker ideal" id="ctIdealMark" style="left:0%"><div class="ct-marker-label">Target</div></div><div class="ct-marker max" id="ctMaxMark" style="left:100%"><div class="ct-marker-label">Max</div></div></div>
<div class="ct-quick-btns" id="ctQuickBtns"></div>
<div class="ct-add-row"><input type="text" class="ct-add-input ct-add-name" id="ctMealName" placeholder="Meal name..."><input type="number" class="ct-add-input ct-add-cal" id="ctMealCal" placeholder="kcal"><button class="ct-add-btn" onclick="addMeal()">+ Add</button></div>
<button class="ct-toggle-meals" onclick="toggleMealList()"><span id="ctMealTogText">Show meals (0)</span></button>
<div class="ct-meals" id="ctMealList"></div>
<div class="ct-macros"><div class="ct-macro"><div class="ct-macro-val" id="ctRemain" style="color:var(--em)">‚Äî</div><div class="ct-macro-lbl">Remaining</div></div><div class="ct-macro"><div class="ct-macro-val" id="ctMealCount" style="color:var(--accentL)">0</div><div class="ct-macro-lbl">Meals</div></div><div class="ct-macro"><div class="ct-macro-val" id="ctAvgMeal" style="color:var(--cyan)">‚Äî</div><div class="ct-macro-lbl">Avg/meal</div></div></div>
</div>
<div class="empty-state" id="emptyState" style="display:none"><div class="empty-state-icon">‚ú®</div><h3>No tasks yet</h3><p>Add your first task or load a template.</p></div>
<div class="period-section" id="mornSec" style="display:none"><div class="period-header" onclick="togPeriod('morn')"><span class="period-emoji">üåÖ</span><span class="period-name">Morning</span><span class="period-badge" id="mornBadge">0/0</span><span class="chevron open" id="mornChev">‚ñº</span></div><div class="task-list open" id="mornList"><div class="task-list-inner" id="mornInner"></div></div></div>
<div class="period-section" id="aftSec" style="display:none"><div class="period-header" onclick="togPeriod('aft')"><span class="period-emoji">‚òÄÔ∏è</span><span class="period-name">Afternoon</span><span class="period-badge" id="aftBadge">0/0</span><span class="chevron open" id="aftChev">‚ñº</span></div><div class="task-list open" id="aftList"><div class="task-list-inner" id="aftInner"></div></div></div>
<div class="period-section" id="eveSec" style="display:none"><div class="period-header" onclick="togPeriod('eve')"><span class="period-emoji">üåô</span><span class="period-name">Evening</span><span class="period-badge" id="eveBadge">0/0</span><span class="chevron open" id="eveChev">‚ñº</span></div><div class="task-list open" id="eveList"><div class="task-list-inner" id="eveInner"></div></div></div>
<div class="ai-section"><div class="ai-label"><span>ü§ñ</span><span class="ai-label-text">AI Assistant</span></div><div class="ai-examples"><strong>Try:</strong> "Take pill at 2pm and 10pm" ¬∑ "Gym weekdays at 6pm" ¬∑ "Yoga every Mon Wed Fri" ¬∑ "Dinner Friday 7pm"</div><div class="ai-row"><input type="text" class="ai-input" id="aiInput" placeholder="Describe your task(s)..."><button class="ibtn" id="voiceBtn" onclick="togVoice()"><span id="vIcon">üé§</span></button><button class="sbtn" onclick="processAI()">Send</button></div><div class="ai-resp" id="aiResp"></div></div>
<div class="tl-section"><div class="tl-head"><span class="tl-title">üìÖ Daily Timeline</span><button class="togbtn" onclick="togTL()"><span id="tlTog">Show</span></button></div><div class="tl-wrap" id="tlWrap"><div class="timeline" id="timeline"></div></div></div>
<div class="act-btns"><button class="act-btn btn-rst" onclick="resetDay()">‚Üª Reset Day</button><button class="act-btn btn-add" onclick="openModal()">+ Add Task</button></div>
<div class="quote" id="quote"></div>
</div>

<!-- STATS -->
<div id="statsView" style="display:none">
<div class="card card-sm"><div class="sec-title">üî• Streak Heatmap ‚Äî Last 12 Weeks</div><div id="heatmapArea"></div><div class="hm-legend"><span>Less</span><div class="hm-lcells"><div class="hm-lc" style="background:var(--bg4)"></div><div class="hm-lc" style="background:rgba(59,130,246,.2)"></div><div class="hm-lc" style="background:rgba(59,130,246,.45)"></div><div class="hm-lc" style="background:rgba(59,130,246,.7)"></div><div class="hm-lc" style="background:var(--accent)"></div></div><span>More</span></div></div>
<div class="card card-sm"><div class="sec-title">üìà Weekly Analytics</div><div class="an-grid"><div class="an-box"><div class="an-val blue" id="anAvg">‚Äî</div><div class="an-lbl">Avg Completion</div></div><div class="an-box"><div class="an-val cyan" id="anStreak">0</div><div class="an-lbl">Current Streak</div></div><div class="an-box"><div class="an-val green" id="anBest">0</div><div class="an-lbl">Best Streak</div></div><div class="an-box"><div class="an-val amber" id="anTotal">0</div><div class="an-lbl">Days Tracked</div></div></div></div>
<div class="card card-sm"><div class="sec-title">üìä Completion by Day of Week</div><div id="barArea"></div><div class="bw-grid" id="bwArea"></div></div>
<div class="card card-sm"><div class="sec-title">üìâ Trends</div><div id="trendArea"></div></div>
<div class="card card-sm"><div class="sec-title">üî• Calorie Trends ‚Äî Last 7 Days</div><div id="calTrendArea"></div></div>
</div>

<!-- CALENDAR -->
<div id="calView" style="display:none">
<div class="cal-hdr"><button class="cal-nav" onclick="prevMo()">‚Äπ</button><h2 class="cal-title" id="calTitle"></h2><button class="cal-nav" onclick="nextMo()">‚Ä∫</button></div>
<div class="cal-grid" id="calGrid"></div>
<div class="cal-legend"><div class="leg-item"><span class="leg-dot" style="background:var(--accent)"></span>Has Tasks</div><div class="leg-item"><span class="leg-dot" style="background:var(--em)"></span>All Done</div><div class="leg-item"><span class="leg-dot" style="background:var(--glowS);border:1px solid var(--accent)"></span>Today</div></div>
<div class="day-panel" id="dayPanel"><div class="dp-hdr"><span class="dp-title" id="panelTitle"></span><button class="dp-close" onclick="closePanel()">‚úï</button></div><div id="panelTasks"></div></div>
</div>

<!-- SETTINGS -->
<div id="settView" style="display:none">
<div class="settings-section">
<div class="sec-title">üé® Appearance</div>
<div class="sett-row"><div><div class="sett-label">Dark Mode</div><div class="sett-desc">Toggle dark/light theme</div></div><button class="toggle-sw on" id="darkToggle" onclick="toggleTheme()"></button></div>
<div class="sett-row"><div><div class="sett-label">Accent Color</div><div class="sett-desc">Choose your accent color</div></div><div class="accent-picker" id="accentPicker"></div></div>
</div>
<div class="settings-section">
<div class="sec-title">üîî Notifications</div>
<div class="sett-row"><div><div class="sett-label">Task Reminders</div><div class="sett-desc">Get notified before each task</div></div><button class="toggle-sw" id="notifToggle" onclick="toggleNotif()"></button></div>
<div class="sett-row"><div><div class="sett-label">Reminder Lead Time</div><div class="sett-desc">How many minutes before</div></div><select class="fselect" id="notifLead" onchange="saveSettings()" style="width:100px"><option value="5">5 min</option><option value="10" selected>10 min</option><option value="15">15 min</option><option value="30">30 min</option></select></div>
</div>
<div class="settings-section">
<div class="sec-title">üî• Calorie Tracker</div>
<div class="sett-row"><div><div class="sett-label">Target Calories</div><div class="sett-desc">Ideal daily intake goal</div></div><input type="number" class="finput" id="settCalTarget" value="2100" style="width:100px;text-align:center" onchange="updateCalSettings()"></div>
<div class="sett-row"><div><div class="sett-label">Max Calories</div><div class="sett-desc">Hard upper limit</div></div><input type="number" class="finput" id="settCalMax" value="2300" style="width:100px;text-align:center" onchange="updateCalSettings()"></div>
<div class="sett-row"><div><div class="sett-label">Quick Add Presets</div><div class="sett-desc">Common meals (name:calories, comma-separated)</div></div></div>
<textarea class="finput" id="settCalPresets" rows="3" style="font-family:var(--fm);font-size:.82em;margin-top:8px" onchange="updateCalSettings()" placeholder="Coffee:50, Protein Shake:300, Chicken Rice:650"></textarea>
</div>
<div class="settings-section">
<div class="sec-title">üì¶ Task Templates</div>
<div class="tpl-grid" id="tplGrid"></div>
<div class="act-btns"><button class="act-btn btn-add" onclick="saveAsTemplate()" style="font-size:.85em">üíæ Save Current as Template</button></div>
</div>
<div class="settings-section">
<div class="sec-title">üóÑÔ∏è Data</div>
<div class="act-btns"><button class="act-btn btn-rst" onclick="exportData()">üì§ Export Data</button><button class="act-btn btn-rst" onclick="document.getElementById('importFile').click()">üì• Import Data</button></div>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
</div>
</div>
</div>

<!-- Modal -->
<div class="modal-bg" id="modal"><div class="modal-box">
<div class="mtitle" id="mTitle">Add Task</div>
<div class="field"><label class="flabel">Task Name</label><input type="text" class="finput" id="fName" placeholder="e.g. Morning workout"></div>
<div class="field"><label class="flabel">Icon</label><div class="egrid" id="eGrid"></div></div>
<div class="field"><label class="flabel">Period</label><select class="fselect" id="fPeriod"><option value="morning">üåÖ Morning</option><option value="afternoon">‚òÄÔ∏è Afternoon</option><option value="evening">üåô Evening</option></select></div>
<div class="field"><label class="flabel">Time</label><input type="time" class="finput" id="fTime" value="09:00"></div>
<div class="field"><label class="flabel">Duration (minutes)</label><input type="number" class="finput" id="fDur" value="30" min="5" max="300"></div>
<div class="field"><label class="flabel">Notes (optional)</label><textarea class="finput" id="fNotes" rows="2" placeholder="e.g. 5mg dosage, bring water..." style="resize:vertical;font-family:var(--ff)"></textarea></div>
<div class="field"><label class="flabel">Schedule</label><select class="fselect" id="fSched" onchange="onSchedChange()"><option value="daily">üîÅ Every day</option><option value="weekdays">üìÖ Weekdays (Mon‚ÄìFri)</option><option value="weekends">üå¥ Weekends (Sat‚ÄìSun)</option><option value="custom">üéØ Custom days</option><option value="once">üìå One-time date</option></select></div>
<div class="field" id="fCustomDaysWrap" style="display:none"><label class="flabel">Pick Days</label><div class="day-picker" id="dayPicker"></div></div>
<div class="field" id="fDateWrap" style="display:none"><label class="flabel">Date</label><input type="date" class="finput" id="fDate"></div>
<div class="mactions" id="mActs"><button class="mbtn mbtn-cancel" onclick="closeModal()">Cancel</button><button class="mbtn mbtn-save" id="mSaveBtn" onclick="saveTask()">Add Task</button></div>
</div></div>

<!-- Template Name Modal -->
<div class="modal-bg" id="tplModal"><div class="modal-box" style="max-width:380px">
<div class="mtitle">Save as Template</div>
<div class="field"><label class="flabel">Template Name</label><input type="text" class="finput" id="tplName" placeholder="e.g. Gym Day, Rest Day..."></div>
<div class="field"><label class="flabel">Icon</label><div class="egrid" id="tplEGrid"></div></div>
<div class="mactions"><button class="mbtn mbtn-cancel" onclick="document.getElementById('tplModal').classList.remove('show')">Cancel</button><button class="mbtn mbtn-save" onclick="confirmSaveTemplate()">Save</button></div>
</div></div>

<script>
// ‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê
const EMOJIS=['üéØ','üèãÔ∏è','üìö','üé®','üç≥','üö∂','‚òï','üéÆ','üßò','üíä','üíß','üõí','üìû','üé¨','üé∏','‚úçÔ∏è'];
const QUOTES=["Small daily improvements lead to stunning results over time.","Success is the sum of small efforts repeated day in and day out.","Your future self will thank you for the habits you build today.","Consistency is the key to unlocking your potential.","Every completed task is a step towards your goals.","Discipline is choosing between what you want now and what you want most."];
const PMAP={morning:{sec:'mornSec',inner:'mornInner',list:'mornList',badge:'mornBadge',chev:'mornChev',key:'morn'},afternoon:{sec:'aftSec',inner:'aftInner',list:'aftList',badge:'aftBadge',chev:'aftChev',key:'aft'},evening:{sec:'eveSec',inner:'eveInner',list:'eveList',badge:'eveBadge',chev:'eveChev',key:'eve'}};
const ACCENTS=[{id:'blue',color:'#3b82f6'},{id:'green',color:'#10b981'},{id:'purple',color:'#8b5cf6'},{id:'rose',color:'#f43f5e'},{id:'amber',color:'#f59e0b'},{id:'cyan',color:'#22d3ee'}];
const TPL_ICONS=['üì¶','üèãÔ∏è','üò¥','üìö','üßò','üéØ','üíº','üéâ','üèÉ','üßπ','üç≥','üí™'];

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let tasks=JSON.parse(localStorage.getItem('routineTasks'))||[];
let done=JSON.parse(localStorage.getItem('completedTasks'))||[];
let history=JSON.parse(localStorage.getItem('dayHistory'))||{};
let templates=JSON.parse(localStorage.getItem('taskTemplates'))||[];
let settings=JSON.parse(localStorage.getItem('appSettings'))||{theme:'dark',accent:'blue',notif:false,notifLead:10};
let lastReset=localStorage.getItem('lastResetDate');
let streak=parseInt(localStorage.getItem('streak'))||0;
let selEmoji='üéØ',tplEmoji='üì¶',recognition=null,listening=false;
let calMo=new Date().getMonth(),calYr=new Date().getFullYear();
let editIdx=-1,customDays=new Set(),dragSrcIdx=null,dragPeriod=null;
let notifTimers=[];

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
function init(){
applySettings();
const today=new Date().toDateString();
const todayISO=new Date().toISOString().split('T')[0];
if(lastReset!==today){
if(lastReset){
const yISO=new Date(lastReset).toISOString().split('T')[0];
const yTasks=tasks.filter(t=>taskShowsOnDate(t,yISO));
const yTotal=yTasks.length,yDone=done.length;
if(yTotal>0){history[yISO]={done:yDone,total:yTotal,pct:Math.round(yDone/yTotal*100)};save('dayHistory',history)}
if(yDone>=yTotal&&yTotal>0)streak++;else if(yTotal>0)streak=0;
localStorage.setItem('streak',streak);
}
done=[];save('completedTasks',done);localStorage.setItem('lastResetDate',today);
tasks=tasks.filter(t=>{if(t.repeat==='once')return t.date>=todayISO;return true});save('routineTasks',tasks);
}
initVoice();renderEmojiPicker();render();updateDT();setInterval(updateDT,1000);
initCalTracker();
document.getElementById('quote').textContent='"'+QUOTES[Math.floor(Math.random()*QUOTES.length)]+'"';
document.getElementById('aiInput').addEventListener('keypress',e=>{if(e.key==='Enter')processAI()});
document.getElementById('ctMealCal').addEventListener('keypress',e=>{if(e.key==='Enter')addMeal()});
document.getElementById('ctMealName').addEventListener('keypress',e=>{if(e.key==='Enter')document.getElementById('ctMealCal').focus()});
scheduleNotifications();
}

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function taskShowsOnDate(t,dateStr){
const dow=new Date(dateStr+'T12:00:00').getDay(),r=t.repeat;
if(r===undefined||r===null){if(!t.date)return true;return t.date===dateStr}
if(r==='daily')return true;
if(r==='weekdays')return dow>=1&&dow<=5;
if(r==='weekends')return dow===0||dow===6;
if(Array.isArray(r))return r.includes(dow);
if(r==='once')return t.date===dateStr;
return true;
}
function getTodayTasks(){const d=new Date().toISOString().split('T')[0];return tasks.filter(t=>taskShowsOnDate(t,d))}
function to24(t){const[tm,mod]=t.split(' ');let[h,m]=tm.split(':');h=+h;if(h===12)h=0;if(mod==='PM')h+=12;return String(h).padStart(2,'0')+':'+m}
function to12(t){let[h,m]=t.split(':');h=+h;const ap=h>=12?'PM':'AM';h=h%12||12;return h+':'+m+' '+ap}
function period4time(t){const h=+to24(t).split(':')[0];return h<12?'morning':h<17?'afternoon':'evening'}
function updateDT(){const n=new Date();document.getElementById('dateTime').textContent=n.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+' ‚Ä¢ '+n.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}
function saveSnapshot(){const todayISO=new Date().toISOString().split('T')[0],tt=getTodayTasks();if(tt.length>0){history[todayISO]={done:done.length,total:tt.length,pct:Math.round(done.length/tt.length*100)};save('dayHistory',history)}}
function schedLabel(t){const r=t.repeat;if(r==='daily')return'every day';if(r==='weekdays')return'weekdays';if(r==='weekends')return'weekends';if(Array.isArray(r))return r.map(d=>['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d]).join(', ');if(r==='once'&&t.date)return new Date(t.date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});return'every day'}
// ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê
function render(){
const tt=getTodayTasks(),total=tt.length,dn=done.length,pct=total?Math.round(dn/total*100):0;
document.getElementById('pctText').textContent=pct+'%';
document.getElementById('doneN').textContent=dn;
document.getElementById('leftN').textContent=total-dn;
document.getElementById('streakN').textContent=streak;
const circ=2*Math.PI*80,ring=document.getElementById('progressRing');
ring.style.strokeDasharray=circ;ring.style.strokeDashoffset=circ-(pct/100)*circ;
document.getElementById('emptyState').style.display=total?'none':'block';
const grouped={morning:[],afternoon:[],evening:[]};
tt.forEach(t=>{const gi=tasks.indexOf(t);grouped[t.period].push({...t,idx:gi})});
Object.keys(PMAP).forEach(p=>{
const cfg=PMAP[p],list=grouped[p],sec=document.getElementById(cfg.sec),inner=document.getElementById(cfg.inner);
sec.style.display=list.length?'block':'none';
list.sort((a,b)=>{
const oa=(a.sortOrder!=null)?a.sortOrder:999,ob=(b.sortOrder!=null)?b.sortOrder:999;
if(oa!==ob)return oa-ob;
return to24(a.time).localeCompare(to24(b.time));
});
const pd=list.filter(t=>done.includes('t-'+t.idx)).length;
document.getElementById(cfg.badge).textContent=pd+'/'+list.length;
inner.innerHTML='';
list.forEach((task,listPos)=>{
const id='t-'+task.idx,isDone=done.includes(id);
const el=document.createElement('div');el.className='task-item'+(isDone?' done':'');
el.setAttribute('draggable','true');
el.dataset.idx=task.idx;el.dataset.period=p;el.dataset.listpos=listPos;
let tags='';
if(task.aiSuggested)tags+='<span class="tag tag-ai">AI</span>';
if(task.repeat==='weekdays')tags+='<span class="tag tag-sched">M‚ÄìF</span>';
else if(task.repeat==='weekends')tags+='<span class="tag tag-sched">S‚ÄìS</span>';
else if(Array.isArray(task.repeat))tags+='<span class="tag tag-sched">'+task.repeat.map(d=>['Su','Mo','Tu','We','Th','Fr','Sa'][d]).join(' ')+'</span>';
else if(task.repeat==='once'&&task.date)tags+='<span class="tag tag-date">'+new Date(task.date+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})+'</span>';
const notesHtml=task.notes?'<div class="tnotes">üìù '+escHtml(task.notes)+'</div>':'';
el.innerHTML='<span class="drag-handle" title="Drag to reorder">‚†ø</span><span class="temoji">'+task.icon+'</span><div class="tinfo"><div class="tname"><span class="tname-text">'+escHtml(task.name)+'</span>'+tags+'</div><div class="tmeta">'+task.time+' ¬∑ '+task.duration+'m</div>'+notesHtml+'</div><div class="tactions"><button class="tbtn edit-b" data-i="'+task.idx+'" title="Edit">‚úèÔ∏è</button><button class="tbtn del" data-i="'+task.idx+'" title="Delete">üóëÔ∏è</button></div><div class="check'+(isDone?' on':'')+'" data-id="'+id+'"></div>';
el.querySelector('.check').addEventListener('click',e=>{e.stopPropagation();toggleDone(id)});
el.querySelector('.edit-b').addEventListener('click',e=>{e.stopPropagation();openEdit(+e.currentTarget.dataset.i)});
el.querySelector('.del').addEventListener('click',function(e){e.stopPropagation();const btn=this;if(btn.dataset.confirm==='1'){delTask(+btn.dataset.i)}else{btn.dataset.confirm='1';btn.textContent='‚ùå';btn.title='Tap again';setTimeout(()=>{if(btn.isConnected){btn.dataset.confirm='';btn.textContent='üóëÔ∏è';btn.title='Delete'}},2500)}});
el.addEventListener('click',e=>{if(!e.target.closest('.tactions')&&!e.target.closest('.check')&&!e.target.closest('.drag-handle'))openEdit(task.idx)});
// Drag events
el.addEventListener('dragstart',e=>{dragSrcIdx=task.idx;dragPeriod=p;el.classList.add('dragging');e.dataTransfer.effectAllowed='move'});
el.addEventListener('dragend',()=>{el.classList.remove('dragging');dragSrcIdx=null;dragPeriod=null;document.querySelectorAll('.task-item').forEach(x=>x.style.borderTop='')});
el.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='move';el.style.borderTop='2px solid var(--accent)'});
el.addEventListener('dragleave',()=>{el.style.borderTop=''});
el.addEventListener('drop',e=>{e.preventDefault();el.style.borderTop='';const targetIdx=+el.dataset.idx;if(dragSrcIdx!==null&&dragSrcIdx!==targetIdx){reorderTask(dragSrcIdx,targetIdx,p)}});
inner.appendChild(el);
});
});
if(document.getElementById('tlWrap').classList.contains('open'))renderTL();
}
function escHtml(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function toggleDone(id){if(done.includes(id))done=done.filter(c=>c!==id);else done.push(id);save('completedTasks',done);saveSnapshot();render()}
function delTask(idx){done=done.filter(c=>c!=='t-'+idx);tasks.splice(idx,1);done=done.map(c=>{const oi=+c.split('-')[1];return oi>idx?'t-'+(oi-1):c});save('routineTasks',tasks);save('completedTasks',done);saveSnapshot();render()}
function togPeriod(key){const cfg=Object.values(PMAP).find(c=>c.key===key);document.getElementById(cfg.list).classList.toggle('open');document.getElementById(cfg.chev).classList.toggle('open')}

// ‚ïê‚ïê‚ïê DRAG REORDER ‚ïê‚ïê‚ïê
function reorderTask(srcIdx,targetIdx,period){
const tt=getTodayTasks().filter(t=>t.period===period).sort((a,b)=>{
const oa=(a.sortOrder!=null)?a.sortOrder:999,ob=(b.sortOrder!=null)?b.sortOrder:999;
if(oa!==ob)return oa-ob;
return to24(a.time).localeCompare(to24(b.time));
});
// Assign sort orders
tt.forEach((t,i)=>{const gi=tasks.indexOf(t);if(gi>=0)tasks[gi].sortOrder=i*10});
// Now move src to target position
const srcTask=tasks[srcIdx],targetTask=tasks[targetIdx];
if(srcTask&&targetTask&&srcTask.period===targetTask.period){
const newOrder=targetTask.sortOrder!=null?targetTask.sortOrder:0;
srcTask.sortOrder=newOrder-1;
// Re-normalize
const periodTasks=tasks.filter(t=>t.period===srcTask.period&&getTodayTasks().includes(t));
periodTasks.sort((a,b)=>(a.sortOrder||0)-(b.sortOrder||0));
periodTasks.forEach((t,i)=>t.sortOrder=i*10);
}
save('routineTasks',tasks);render();
}
// ‚ïê‚ïê‚ïê TIMELINE ‚ïê‚ïê‚ïê
function togTL(){const w=document.getElementById('tlWrap');w.classList.toggle('open');document.getElementById('tlTog').textContent=w.classList.contains('open')?'Hide':'Show';if(w.classList.contains('open'))renderTL()}
function renderTL(){
const tl=document.getElementById('timeline'),tt=getTodayTasks();
if(!tt.length){tl.innerHTML='<div class="empty-tl">No tasks yet.</div>';return}
const sorted=tt.map(t=>({...t,idx:tasks.indexOf(t)})).sort((a,b)=>to24(a.time).localeCompare(to24(b.time)));
tl.innerHTML='';
sorted.forEach((t,i)=>{const isDone=done.includes('t-'+t.idx),el=document.createElement('div');el.className='tl-item';el.style.animationDelay=i*.08+'s';
el.innerHTML='<div class="tl-time">'+t.time+'</div><div class="tl-dot'+(isDone?' dn':'')+'"></div><div class="tl-card'+(isDone?' dn':'')+(t.aiSuggested?' ai':'')+'"><div class="tl-cn"><span>'+t.icon+'</span>'+escHtml(t.name)+(t.aiSuggested?'<span class="tag tag-ai">AI</span>':'')+'</div><div class="tl-cm">'+t.duration+' min'+(t.notes?' ¬∑ '+escHtml(t.notes):'')+'</div></div>';
tl.appendChild(el)});
}

// ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê
function renderEmojiPicker(){const g=document.getElementById('eGrid');g.innerHTML='';EMOJIS.forEach(e=>{const el=document.createElement('div');el.className='eopt'+(e===selEmoji?' sel':'');el.textContent=e;el.onclick=()=>{selEmoji=e;document.querySelectorAll('#eGrid .eopt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel')};g.appendChild(el)})}
function selEP(em){selEmoji=em;document.querySelectorAll('#eGrid .eopt').forEach(el=>el.classList.toggle('sel',el.textContent===em))}
function onSchedChange(){const v=document.getElementById('fSched').value;document.getElementById('fCustomDaysWrap').style.display=v==='custom'?'block':'none';document.getElementById('fDateWrap').style.display=v==='once'?'block':'none';if(v==='custom')renderDayPicker()}
function renderDayPicker(){const wrap=document.getElementById('dayPicker');wrap.innerHTML='';['Su','Mo','Tu','We','Th','Fr','Sa'].forEach((label,i)=>{const el=document.createElement('div');el.className='dp-day'+(customDays.has(i)?' on':'');el.textContent=label;el.onclick=()=>{if(customDays.has(i))customDays.delete(i);else customDays.add(i);el.classList.toggle('on')};wrap.appendChild(el)})}
function openModal(){editIdx=-1;document.getElementById('mTitle').textContent='Add Task';document.getElementById('mSaveBtn').textContent='Add Task';document.getElementById('fName').value='';document.getElementById('fTime').value='09:00';document.getElementById('fDur').value='30';document.getElementById('fPeriod').value='morning';document.getElementById('fNotes').value='';document.getElementById('fSched').value='daily';customDays=new Set();onSchedChange();document.getElementById('fDate').value=new Date().toISOString().split('T')[0];selEP('üéØ');const db=document.getElementById('mDelBtn');if(db)db.remove();document.getElementById('modal').classList.add('show')}
function openEdit(idx){editIdx=idx;const t=tasks[idx];if(!t)return;document.getElementById('mTitle').textContent='Edit Task';document.getElementById('mSaveBtn').textContent='Save Changes';document.getElementById('fName').value=t.name;document.getElementById('fTime').value=to24(t.time);document.getElementById('fDur').value=t.duration;document.getElementById('fPeriod').value=t.period;document.getElementById('fNotes').value=t.notes||'';
const r=t.repeat;customDays=new Set();
if(r===undefined||r===null){document.getElementById('fSched').value=t.date?'once':'daily'}
else if(r==='daily')document.getElementById('fSched').value='daily';
else if(r==='weekdays')document.getElementById('fSched').value='weekdays';
else if(r==='weekends')document.getElementById('fSched').value='weekends';
else if(r==='once')document.getElementById('fSched').value='once';
else if(Array.isArray(r)){document.getElementById('fSched').value='custom';customDays=new Set(r)}
onSchedChange();document.getElementById('fDate').value=t.date||new Date().toISOString().split('T')[0];
selEP(t.icon);const acts=document.getElementById('mActs');let db=document.getElementById('mDelBtn');if(!db){db=document.createElement('button');db.id='mDelBtn';db.className='mbtn mbtn-del';db.textContent='üóëÔ∏è Delete';db.onclick=()=>{const i=editIdx;closeModal();delTask(i)};acts.insertBefore(db,acts.firstChild)}document.getElementById('modal').classList.add('show')}
function closeModal(){document.getElementById('modal').classList.remove('show');editIdx=-1;const db=document.getElementById('mDelBtn');if(db)db.remove()}
function saveTask(){const name=document.getElementById('fName').value.trim();if(!name)return alert('Enter a name');
const time12=to12(document.getElementById('fTime').value),period=document.getElementById('fPeriod').value,duration=parseInt(document.getElementById('fDur').value)||30,notes=document.getElementById('fNotes').value.trim(),sched=document.getElementById('fSched').value;
let repeat,date=null;
if(sched==='daily')repeat='daily';else if(sched==='weekdays')repeat='weekdays';else if(sched==='weekends')repeat='weekends';
else if(sched==='custom'){repeat=[...customDays].sort();if(!repeat.length)return alert('Pick at least one day')}
else if(sched==='once'){repeat='once';date=document.getElementById('fDate').value;if(!date)return alert('Pick a date')}
if(editIdx>=0){tasks[editIdx]={...tasks[editIdx],name,icon:selEmoji,duration,time:time12,period,date,repeat,notes:notes||undefined}}
else{tasks.push({name,icon:selEmoji,duration,time:time12,period,date,repeat,notes:notes||undefined,aiSuggested:false})}
save('routineTasks',tasks);closeModal();render();scheduleNotifications()}

// ‚ïê‚ïê‚ïê VOICE ‚ïê‚ïê‚ïê
function initVoice(){if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window))return;const SR=window.SpeechRecognition||window.webkitSpeechRecognition;recognition=new SR();recognition.continuous=false;recognition.interimResults=false;recognition.lang='en-US';recognition.onresult=e=>{document.getElementById('aiInput').value=e.results[0][0].transcript;stopV();processAI()};recognition.onerror=()=>stopV();recognition.onend=()=>stopV()}
function togVoice(){if(!recognition)return alert('Voice not supported');listening?stopV():startV()}
function startV(){listening=true;recognition.start();document.getElementById('voiceBtn').classList.add('listening');document.getElementById('vIcon').textContent='üî¥'}
function stopV(){listening=false;if(recognition)recognition.stop();document.getElementById('voiceBtn').classList.remove('listening');document.getElementById('vIcon').textContent='üé§'}
// ‚ïê‚ïê‚ïê AI PARSER ‚ïê‚ïê‚ïê
async function processAI(){
const input=document.getElementById('aiInput').value.trim();if(!input)return;
const resp=document.getElementById('aiResp');resp.className='ai-resp thinking show';resp.textContent='Thinking';
await new Promise(r=>setTimeout(r,500));
try{
const parsed=smartParse(input);if(!parsed.length)throw 0;
parsed.forEach(t=>tasks.push({name:t.name,icon:t.icon,duration:t.duration,time:t.time,period:t.period,date:t.date,repeat:t.repeat,notes:t.notes,aiSuggested:true}));
save('routineTasks',tasks);let msg='';
if(parsed.length===1){const t=parsed[0];msg='‚úÖ <strong>'+t.icon+' '+t.name+'</strong> ‚Äî '+schedLabel(t)+' at '+t.time+' ('+t.duration+'m)'}
else{msg='‚úÖ Added '+parsed.length+' tasks:<br>';parsed.forEach(t=>{msg+='&nbsp;&nbsp;'+t.icon+' <strong>'+t.name+'</strong> at '+t.time+' ('+schedLabel(t)+')<br>'})}
resp.className='ai-resp show';resp.innerHTML=msg;document.getElementById('aiInput').value='';render();scheduleNotifications();setTimeout(()=>resp.classList.remove('show'),4500);
}catch(e){resp.className='ai-resp show';resp.innerHTML='‚ùå Try: "Take pill at 2pm and 10pm"';setTimeout(()=>resp.classList.remove('show'),5000)}}

function smartParse(input){const dateResult=extractDate(input);let sharedDate=null,sharedRepeat='daily';
if(dateResult&&typeof dateResult==='object'&&dateResult.repeat){sharedRepeat=dateResult.repeat;sharedDate=null}
else if(typeof dateResult==='string'){sharedDate=dateResult;sharedRepeat='once'}
const allTimes=extractAllTimes(input),sharedDur=extractDur(input);
if(allTimes.length>1){const split=trySplitTasks(input);if(split&&split.length>1)return split.map(seg=>{const t=extractAllTimes(seg)[0]||'5:00 PM';return mkTask(cleanName(seg),t,pickIcon(seg),extractDur(seg)||sharedDur||guessDur(seg),sharedDate,sharedRepeat)});const baseName=cleanName(input);return allTimes.map(t=>mkTask(baseName,t,pickIcon(input),sharedDur||guessDur(input),sharedDate,sharedRepeat))}
const time=allTimes[0]||guessTime(input);return[mkTask(cleanName(input),time,pickIcon(input),sharedDur||guessDur(input),sharedDate,sharedRepeat)]}
function mkTask(name,time,icon,dur,date,repeat){name=(name||'').trim();if(!name||name.length<2)name='Task';name=name.charAt(0).toUpperCase()+name.slice(1);if(!repeat)repeat=date?'once':'daily';return{name,time,icon,duration:dur,date,repeat,period:period4time(time)}}
function extractAllTimes(input){const times=[];const re=/(\d{1,2}):?(\d{2})?\s*(am|pm)/gi;let m;while((m=re.exec(input))!==null){let h=+m[1];const min=m[2]||'00';const mer=m[3].toUpperCase();if(mer==='PM'&&h!==12)h+=12;if(mer==='AM'&&h===12)h=0;times.push((h%12||12)+':'+min+' '+mer)}return times}
function guessTime(input){const l=input.toLowerCase();if(l.includes('morning')||l.includes('breakfast'))return'8:00 AM';if(l.includes('lunch')||l.includes('noon'))return'12:00 PM';if(l.includes('afternoon'))return'3:00 PM';if(l.includes('dinner')||l.includes('evening'))return'6:00 PM';if(l.includes('night')||l.includes('bedtime'))return'9:00 PM';return'5:00 PM'}
function trySplitTasks(input){const parts=input.split(/\s+and\s+|,\s*/i).map(s=>s.trim()).filter(s=>s.length>0);if(parts.length<=1)return null;if(parts.filter(p=>extractAllTimes(p).length>0).length===parts.length)return parts;return null}
function extractDate(input){const l=input.toLowerCase();const today=new Date();
if(/\b(daily|every\s*day|each\s*day)\b/i.test(l))return null;
if(/\b(weekday|weekdays|mon\s*-?\s*fri)\b/i.test(l))return{repeat:'weekdays'};
if(/\b(weekend|weekends?|sat\s*-?\s*sun)\b/i.test(l))return{repeat:'weekends'};
if(/\b(mwf|mon\s*wed\s*fri)\b/i.test(l))return{repeat:[1,3,5]};
if(/\bevery\s+other\s+day\b/i.test(l))return{repeat:[1,3,5]};
const everyMatch=l.match(/every\s+((?:(?:mon|tue|wed|thu|fri|sat|sun|monday|tuesday|wednesday|thursday|friday|saturday|sunday)[\s,and]*)+)/i);
if(everyMatch){const days={sunday:0,sun:0,monday:1,mon:1,tuesday:2,tue:2,tues:2,wednesday:3,wed:3,thursday:4,thu:4,thur:4,thurs:4,friday:5,fri:5,saturday:6,sat:6};const nums=[];for(const[d,n]of Object.entries(days))if(new RegExp('\\b'+d+'\\b','i').test(everyMatch[1])&&!nums.includes(n))nums.push(n);if(nums.length)return{repeat:nums.sort()}}
if(l.includes('tomorrow')){const t=new Date(today);t.setDate(today.getDate()+1);return t.toISOString().split('T')[0]}
if(/\btoday\b/i.test(l))return today.toISOString().split('T')[0];
const days={sunday:0,sun:0,monday:1,mon:1,tuesday:2,tue:2,tues:2,wednesday:3,wed:3,thursday:4,thu:4,thur:4,thurs:4,friday:5,fri:5,saturday:6,sat:6};
for(const[d,n]of Object.entries(days)){if(new RegExp('\\b'+d+'\\b','i').test(l)){let diff=n-today.getDay();if(diff<=0)diff+=7;if(/\bnext\b/i.test(l))diff+=7;const t=new Date(today);t.setDate(today.getDate()+diff);return t.toISOString().split('T')[0]}}return null}
function extractDur(input){const m=input.match(/(\d+)\s*(min|minute|minutes|hour|hours|hr|hrs)\b/i);if(m){const n=+m[1],u=m[2].toLowerCase();return u.startsWith('hour')||u.startsWith('hr')?n*60:n}return null}
function guessDur(input){const l=input.toLowerCase();if(/pill|vitamin|medicine|supplement|water|creatine|greens/.test(l))return 5;if(/call|stretch|quick/.test(l))return 15;if(/meeting|meditat/.test(l))return 30;if(/workout|gym|lunch|dinner/.test(l))return 60;if(/movie/.test(l))return 120;return 30}
function pickIcon(input){const l=input.toLowerCase();const map={pill:'üíä',vitamin:'üíä',medicine:'üíä',supplement:'üíä',creatine:'üíä',greens:'üåø',meeting:'üë•',call:'üìû',workout:'üèãÔ∏è',gym:'üí™',exercise:'üèãÔ∏è',dinner:'üçΩÔ∏è',lunch:'üç±',breakfast:'üç≥',eat:'üç¥',cook:'üë®‚Äçüç≥',movie:'üé¨',shopping:'üõí',doctor:'‚öïÔ∏è',birthday:'üéÇ',party:'üéâ',study:'üìö',read:'üìñ',work:'üíº',code:'üíª',clean:'üßπ',drive:'üöó',travel:'‚úàÔ∏è',music:'üéµ',game:'üéÆ',coffee:'‚òï',water:'üíß',walk:'üö∂',run:'üèÉ',yoga:'üßò',meditat:'üßò',sleep:'üò¥',relax:'üòå',plan:'üìù',journal:'üìù',email:'üìß',pray:'üôè',shower:'üöø',skin:'üß¥',teeth:'ü™•'};for(const[k,v]of Object.entries(map))if(l.includes(k))return v;return'üìã'}
function cleanName(input){let n=input;n=n.replace(/(\d{1,2}):?(\d{2})?\s*(am|pm)/gi,'');n=n.replace(/\b(tomorrow|today|tonight|daily|every\s*day|each\s*day|recurring|weekday|weekdays|weekend|weekends|mwf)\b/gi,'');n=n.replace(/\b(morning|afternoon|evening|night|noon|midnight|bedtime)\b/gi,'');n=n.replace(/\b(monday|tuesday|wednesday|thursday|friday|saturday|sunday|mon|tue|tues|wed|thu|thur|thurs|fri|sat|sun)\b/gi,'');n=n.replace(/\bnext\s*(week)?\b/gi,'');n=n.replace(/\bevery\s*(other\s*day)?\b/gi,'');n=n.replace(/\b(\d+)\s*(min|minute|minutes|hour|hours|hr|hrs)\b/gi,'');n=n.replace(/\b(at|on|for|every|from|until|one|the|a|an|in|and|to|through|thru)\b/gi,'');n=n.replace(/[,;.]+/g,' ');n=n.replace(/\s+/g,' ').trim();n=n.replace(/^[\s,\-‚Äì‚Äî]+|[\s,\-‚Äì‚Äî]+$/g,'').trim();return n}
function resetDay(){done=[];save('completedTasks',done);saveSnapshot();localStorage.setItem('lastResetDate',new Date().toDateString());render()}
// ‚ïê‚ïê‚ïê VIEWS ‚ïê‚ïê‚ïê
function switchView(v){
['todayView','statsView','calView','settView'].forEach(id=>document.getElementById(id).style.display='none');
['tabToday','tabStats','tabCal','tabSet'].forEach(id=>document.getElementById(id).classList.remove('active'));
if(v==='today'){document.getElementById('todayView').style.display='block';document.getElementById('tabToday').classList.add('active')}
else if(v==='stats'){document.getElementById('statsView').style.display='block';document.getElementById('tabStats').classList.add('active');renderStats()}
else if(v==='calendar'){document.getElementById('calView').style.display='block';document.getElementById('tabCal').classList.add('active');renderCal()}
else if(v==='settings'){document.getElementById('settView').style.display='block';document.getElementById('tabSet').classList.add('active');renderSettings()}
}

// ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê
function renderStats(){renderHeatmap();renderAnalytics();renderDayBars();renderTrends();renderCalTrends()}
function getHistoryDays(n){const result=[],today=new Date();for(let i=n-1;i>=0;i--){const d=new Date(today);d.setDate(today.getDate()-i);const ds=d.toISOString().split('T')[0];const h=history[ds];if(i===0){const tt=getTodayTasks(),total=tt.length,dn=done.length;result.push({date:ds,pct:total?Math.round(dn/total*100):null,done:dn,total,dayOfWeek:d.getDay()})}else if(h)result.push({date:ds,pct:h.pct,done:h.done,total:h.total,dayOfWeek:d.getDay()});else result.push({date:ds,pct:null,done:0,total:0,dayOfWeek:d.getDay()})}return result}
function renderHeatmap(){
const area=document.getElementById('heatmapArea'),days=getHistoryDays(84);
const weeks=[];let week=[];for(let i=0;i<days.length;i++){week.push(days[i]);if(week.length===7){weeks.push(week);week=[]}}if(week.length)weeks.push(week);
let html='<div style="display:flex;gap:4px"><div style="display:flex;flex-direction:column;gap:4px;padding-right:6px">';
['','M','','W','','F',''].forEach(d=>html+='<div style="font-family:var(--fm);font-size:.6em;color:var(--t3);height:16px;display:flex;align-items:center;justify-content:flex-end;width:16px">'+d+'</div>');
html+='</div><div style="display:flex;gap:4px;flex:1">';
weeks.forEach(w=>{html+='<div style="display:flex;flex-direction:column;gap:4px;flex:1">';w.forEach(day=>{let bg='var(--bg4)';if(day.pct!==null){if(day.pct===0)bg='var(--bg4)';else if(day.pct<=25)bg='rgba(59,130,246,.2)';else if(day.pct<=50)bg='rgba(59,130,246,.4)';else if(day.pct<=75)bg='rgba(59,130,246,.6)';else if(day.pct<100)bg='rgba(59,130,246,.8)';else bg='var(--accent)'}const tip=day.pct!==null?day.date+': '+day.pct+'%':'no data';html+='<div class="hm-cell" style="background:'+bg+';min-height:16px" data-tip="'+tip+'"></div>'});html+='</div>'});
html+='</div></div>';area.innerHTML=html}
function renderAnalytics(){const days=getHistoryDays(84),tracked=days.filter(d=>d.pct!==null);const avg=tracked.length?Math.round(tracked.reduce((s,d)=>s+d.pct,0)/tracked.length):0;document.getElementById('anAvg').textContent=tracked.length?avg+'%':'‚Äî';document.getElementById('anStreak').textContent=streak;document.getElementById('anTotal').textContent=tracked.length;let best=0,cur=0;getHistoryDays(365).forEach(d=>{if(d.pct!==null&&d.pct===100){cur++;if(cur>best)best=cur}else cur=0});document.getElementById('anBest').textContent=Math.max(best,streak)}
function renderDayBars(){const area=document.getElementById('barArea'),bwArea=document.getElementById('bwArea'),days=getHistoryDays(84);const byDay=Array.from({length:7},()=>[]);days.forEach(d=>{if(d.pct!==null)byDay[d.dayOfWeek].push(d.pct)});const avgs=byDay.map(arr=>arr.length?Math.round(arr.reduce((s,v)=>s+v,0)/arr.length):0);const maxAvg=Math.max(...avgs,1);const labels=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
let html='';avgs.forEach((avg,i)=>{html+='<div class="bar-row"><div class="bar-label">'+labels[i]+'</div><div class="bar-track"><div class="bar-fill" style="width:'+Math.round((avg/maxAvg)*100)+'%"></div></div><div class="bar-pct">'+avg+'%</div></div>'});
if(!days.some(d=>d.pct!==null))html='<div class="no-data">Complete tasks to see patterns!</div>';
area.innerHTML=html;
if(days.some(d=>d.pct!==null)){let bestI=0,worstI=0;avgs.forEach((v,i)=>{if(v>avgs[bestI])bestI=i});const nz=avgs.map((v,i)=>byDay[i].length?v:999);worstI=nz.indexOf(Math.min(...nz));if(nz[worstI]===999)worstI=0;
bwArea.innerHTML='<div class="bw-card"><div class="bw-emoji">üèÜ</div><div class="bw-day" style="color:var(--em)">'+labels[bestI]+'</div><div class="bw-sub">Best ¬∑ '+avgs[bestI]+'%</div></div><div class="bw-card"><div class="bw-emoji">üò¥</div><div class="bw-day" style="color:var(--amber)">'+labels[worstI]+'</div><div class="bw-sub">Weakest ¬∑ '+avgs[worstI]+'%</div></div>'}else bwArea.innerHTML=''}
function renderTrends(){const area=document.getElementById('trendArea'),days=getHistoryDays(84),tracked=days.filter(d=>d.pct!==null);
if(tracked.length<3){area.innerHTML='<div class="no-data">Track 3+ days for trends!</div>';return}
let html='';const last7=getHistoryDays(7).filter(d=>d.pct!==null),prev7=getHistoryDays(14).slice(0,7).filter(d=>d.pct!==null);
const thisAvg=last7.length?Math.round(last7.reduce((s,d)=>s+d.pct,0)/last7.length):null,prevAvg=prev7.length?Math.round(prev7.reduce((s,d)=>s+d.pct,0)/prev7.length):null;
if(thisAvg!==null&&prevAvg!==null){const diff=thisAvg-prevAvg;if(diff>5)html+='<div class="trend-row"><div class="trend-icon">üìà</div><div class="trend-text"><div class="trend-title" style="color:var(--em)">Trending Up!</div><div class="trend-sub">This week '+thisAvg+'% vs last '+prevAvg+'%</div></div></div>';else if(diff<-5)html+='<div class="trend-row"><div class="trend-icon">üìâ</div><div class="trend-text"><div class="trend-title" style="color:var(--rose)">Slight Dip</div><div class="trend-sub">This week '+thisAvg+'% vs last '+prevAvg+'%</div></div></div>';else html+='<div class="trend-row"><div class="trend-icon">‚û°Ô∏è</div><div class="trend-text"><div class="trend-title" style="color:var(--accentL)">Holding Steady</div><div class="trend-sub">This week '+thisAvg+'% vs last '+prevAvg+'%</div></div></div>'}
const perfect=tracked.filter(d=>d.pct===100).length;if(perfect>0)html+='<div class="trend-row"><div class="trend-icon">‚≠ê</div><div class="trend-text"><div class="trend-title" style="color:var(--amber)">'+perfect+' Perfect Day'+(perfect>1?'s':'')+'</div><div class="trend-sub">Out of '+tracked.length+' tracked ('+Math.round(perfect/tracked.length*100)+'%)</div></div></div>';
const consistency=tracked.length>=7?Math.round((tracked.filter(d=>d.pct>=50).length/tracked.length)*100):null;
if(consistency!==null){let icon='üî•',label='Excellent!',col='var(--em)';if(consistency<50){icon='üí™';label='Building up';col='var(--amber)'}else if(consistency<75){icon='üëç';label='Getting there';col='var(--accentL)'}html+='<div class="trend-row"><div class="trend-icon">'+icon+'</div><div class="trend-text"><div class="trend-title" style="color:'+col+'">Consistency: '+consistency+'%</div><div class="trend-sub">Days with 50%+ completion</div></div></div>'}
if(!html)html='<div class="no-data">Keep tracking!</div>';area.innerHTML=html}
// ‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê
function renderCal(){const g=document.getElementById('calGrid'),mos=['January','February','March','April','May','June','July','August','September','October','November','December'];document.getElementById('calTitle').textContent=mos[calMo]+' '+calYr;g.innerHTML='';['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{const el=document.createElement('div');el.className='cal-dh';el.textContent=d;g.appendChild(el)});
const first=new Date(calYr,calMo,1).getDay(),daysIn=new Date(calYr,calMo+1,0).getDate(),prev=new Date(calYr,calMo,0).getDate(),todayStr=new Date().toISOString().split('T')[0];
for(let i=first-1;i>=0;i--){const el=document.createElement('div');el.className='cal-d oth';el.innerHTML='<div class="cal-dn">'+(prev-i)+'</div>';g.appendChild(el)}
for(let d=1;d<=daysIn;d++){const ds=calYr+'-'+String(calMo+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');const el=document.createElement('div');el.className='cal-d';if(ds===todayStr)el.classList.add('tod');const dt=tasks.filter(t=>taskShowsOnDate(t,ds));if(dt.length){el.classList.add('ht');const h=history[ds];if(ds===todayStr){if(done.length>=dt.length&&dt.length>0)el.classList.add('ad')}else if(h&&h.pct===100)el.classList.add('ad')}el.innerHTML='<div class="cal-dn">'+d+'</div>';el.onclick=()=>showPanel(ds,dt);g.appendChild(el)}
const rem=42-(first+daysIn);for(let d=1;d<=rem;d++){const el=document.createElement('div');el.className='cal-d oth';el.innerHTML='<div class="cal-dn">'+d+'</div>';g.appendChild(el)}}
function showPanel(ds,dt){document.getElementById('panelTitle').textContent=new Date(ds+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});const c=document.getElementById('panelTasks');c.innerHTML='';const h=history[ds];
if(!dt.length&&!h){c.innerHTML='<p style="text-align:center;color:var(--t3);padding:20px">No tasks this day</p>'}else{
if(h)c.innerHTML+='<div style="text-align:center;padding:12px;margin-bottom:12px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)"><span style="font-size:1.8em;font-weight:800;color:var(--accentL);font-family:var(--fm)">'+h.pct+'%</span><div style="font-size:.8em;color:var(--t3);margin-top:4px">'+h.done+'/'+h.total+' completed</div></div>';
const ch=calHistory[ds];if(ch){const cCol=ch.total>calSettings.max?'var(--rose)':ch.total>calSettings.target?'var(--amber)':'var(--em)';c.innerHTML+='<div style="text-align:center;padding:12px;margin-bottom:12px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)"><span style="font-size:1.4em;font-weight:800;color:'+cCol+';font-family:var(--fm)">üî• '+ch.total.toLocaleString()+' kcal</span><div style="font-size:.78em;color:var(--t3);margin-top:4px">'+ch.meals+' meal'+(ch.meals!==1?'s':'')+' ¬∑ Target: '+calSettings.target.toLocaleString()+'</div>'+(ch.items?'<div style="font-size:.72em;color:var(--t3);margin-top:6px">'+ch.items.map(m=>m.name+' ('+m.cal+')').join(' ¬∑ ')+'</div>':'')+'</div>'}
const gr={morning:[],afternoon:[],evening:[]};dt.forEach(t=>gr[t.period].push(t));const icons={morning:'üåÖ',afternoon:'‚òÄÔ∏è',evening:'üåô'};
['morning','afternoon','evening'].forEach(p=>{if(!gr[p].length)return;const s=document.createElement('div');s.style.marginBottom='16px';s.innerHTML='<div style="font-weight:700;color:var(--accentL);margin-bottom:8px;font-size:.95em">'+icons[p]+' '+p.charAt(0).toUpperCase()+p.slice(1)+'</div>';gr[p].forEach(t=>{const r=document.createElement('div');r.style.cssText='display:flex;align-items:center;padding:12px;margin-bottom:6px;background:var(--bg1);border-radius:var(--r1);border:1px solid var(--bd)';r.innerHTML='<span style="font-size:1.4em;margin-right:12px">'+t.icon+'</span><div style="flex:1"><div style="font-weight:600;font-size:.92em">'+escHtml(t.name)+'</div><div style="font-size:.8em;color:var(--t3);font-family:var(--fm)">'+t.time+' ¬∑ '+t.duration+'m</div>'+(t.notes?'<div style="font-size:.75em;color:var(--t3);font-style:italic;margin-top:2px">üìù '+escHtml(t.notes)+'</div>':'')+'</div>';s.appendChild(r)});c.appendChild(s)})}
document.getElementById('dayPanel').classList.add('show')}
function closePanel(){document.getElementById('dayPanel').classList.remove('show')}
function prevMo(){calMo--;if(calMo<0){calMo=11;calYr--}renderCal();closePanel()}
function nextMo(){calMo++;if(calMo>11){calMo=0;calYr++}renderCal();closePanel()}

// ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
function renderSettings(){
// Theme toggle
document.getElementById('darkToggle').classList.toggle('on',settings.theme==='dark');
// Notif toggle
document.getElementById('notifToggle').classList.toggle('on',settings.notif);
document.getElementById('notifLead').value=settings.notifLead||10;
// Accent picker
const picker=document.getElementById('accentPicker');picker.innerHTML='';
ACCENTS.forEach(a=>{const dot=document.createElement('div');dot.className='acc-dot'+(settings.accent===a.id?' sel':'');dot.style.background=a.color;dot.onclick=()=>{settings.accent=a.id;saveSettings();applySettings();renderSettings()};picker.appendChild(dot)});
// Templates
renderTemplates();
renderCalSettingsFields();
}
function toggleTheme(){settings.theme=settings.theme==='dark'?'light':'dark';saveSettings();applySettings();renderSettings()}
function toggleNotif(){
if(!settings.notif){
if('Notification' in window){
Notification.requestPermission().then(p=>{if(p==='granted'){settings.notif=true;saveSettings();applySettings();renderSettings();scheduleNotifications()}else{alert('Please allow notifications in your browser settings');settings.notif=false;renderSettings()}})
}else{alert('Notifications not supported');return}
}else{settings.notif=false;clearNotifTimers();saveSettings();renderSettings()}
}
function saveSettings(){save('appSettings',settings)}
function applySettings(){
document.documentElement.setAttribute('data-theme',settings.theme);
document.documentElement.setAttribute('data-accent',settings.accent);
document.querySelector('meta[name="theme-color"]').content=settings.theme==='dark'?'#030712':'#f8fafc';
}
// ‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê
function clearNotifTimers(){notifTimers.forEach(t=>clearTimeout(t));notifTimers=[]}
function scheduleNotifications(){
clearNotifTimers();
if(!settings.notif||!('Notification' in window)||Notification.permission!=='granted')return;
const tt=getTodayTasks(),now=new Date(),lead=(settings.notifLead||10)*60*1000;
tt.forEach(t=>{
const[time24]=to24(t.time).split(':').map(Number);
const timeParts=to24(t.time).split(':');
const taskDate=new Date();taskDate.setHours(+timeParts[0],+timeParts[1],0,0);
const notifTime=new Date(taskDate.getTime()-lead);
const delay=notifTime.getTime()-now.getTime();
if(delay>0&&delay<86400000){
const timer=setTimeout(()=>{
if(done.includes('t-'+tasks.indexOf(t)))return; // Skip if already done
new Notification('‚è∞ '+t.icon+' '+t.name,{body:'Starting in '+(settings.notifLead||10)+' minutes\n'+t.time+' ¬∑ '+t.duration+'m'+(t.notes?'\nüìù '+t.notes:''),tag:'task-'+tasks.indexOf(t),requireInteraction:false});
},delay);
notifTimers.push(timer);
}
});
}

// ‚ïê‚ïê‚ïê TEMPLATES ‚ïê‚ïê‚ïê
function renderTemplates(){
const grid=document.getElementById('tplGrid');grid.innerHTML='';
if(!templates.length){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--t3);padding:20px;font-style:italic">No templates yet. Save your current routine as a template!</div>';return}
templates.forEach((tpl,i)=>{
const card=document.createElement('div');card.className='tpl-card';
card.innerHTML='<div class="tpl-icon">'+tpl.icon+'</div><div class="tpl-name">'+escHtml(tpl.name)+'</div><div class="tpl-count">'+tpl.tasks.length+' tasks</div><div class="tpl-actions"><button class="tpl-btn" onclick="event.stopPropagation();loadTemplate('+i+')">Load</button><button class="tpl-btn danger" onclick="event.stopPropagation();deleteTemplate('+i+')">Delete</button></div>';
grid.appendChild(card);
});
}
function saveAsTemplate(){
// Render emoji picker in template modal
const g=document.getElementById('tplEGrid');g.innerHTML='';tplEmoji='üì¶';
TPL_ICONS.forEach(e=>{const el=document.createElement('div');el.className='eopt'+(e===tplEmoji?' sel':'');el.textContent=e;el.onclick=()=>{tplEmoji=e;document.querySelectorAll('#tplEGrid .eopt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel')};g.appendChild(el)});
document.getElementById('tplName').value='';
document.getElementById('tplModal').classList.add('show');
}
function confirmSaveTemplate(){
const name=document.getElementById('tplName').value.trim();
if(!name)return alert('Enter a template name');
const currentTasks=tasks.filter(t=>t.repeat!=='once').map(t=>({name:t.name,icon:t.icon,duration:t.duration,time:t.time,period:t.period,repeat:t.repeat,notes:t.notes}));
if(!currentTasks.length)return alert('No recurring tasks to save');
templates.push({name,icon:tplEmoji,tasks:currentTasks});
save('taskTemplates',templates);
document.getElementById('tplModal').classList.remove('show');
renderTemplates();
}
function loadTemplate(idx){
const tpl=templates[idx];if(!tpl)return;
const count=tpl.tasks.length;
if(!confirm('Load "'+tpl.name+'" ('+count+' tasks)? This will ADD to your current tasks.'))return;
tpl.tasks.forEach(t=>{
// Don't add duplicates
const exists=tasks.some(et=>et.name===t.name&&et.time===t.time&&et.period===t.period);
if(!exists)tasks.push({...t,aiSuggested:false});
});
save('routineTasks',tasks);render();scheduleNotifications();
switchView('today');
}
function deleteTemplate(idx){
if(!confirm('Delete template "'+templates[idx].name+'"?'))return;
templates.splice(idx,1);save('taskTemplates',templates);renderTemplates();
}

// ‚ïê‚ïê‚ïê EXPORT/IMPORT ‚ïê‚ïê‚ïê
function exportData(){
const data={tasks,history,templates,settings,streak,done,meals,calHistory,calSettings};
const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');a.href=url;a.download='routine-backup-'+new Date().toISOString().split('T')[0]+'.json';
a.click();URL.revokeObjectURL(url);
}
function importData(event){
const file=event.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=e=>{
try{
const data=JSON.parse(e.target.result);
if(data.tasks)tasks=data.tasks;
if(data.history)history=data.history;
if(data.templates)templates=data.templates;
if(data.settings){settings=data.settings;applySettings()}
if(data.streak!=null)streak=data.streak;
if(data.done)done=data.done;
if(data.meals)meals=data.meals;
if(data.calHistory)calHistory=data.calHistory;
if(data.calSettings){calSettings=data.calSettings;save('calSettings',calSettings)}
save('routineTasks',tasks);save('dayHistory',history);save('taskTemplates',templates);
save('appSettings',settings);save('completedTasks',done);save('todayMeals',meals);save('calHistory',calHistory);localStorage.setItem('streak',streak);
render();renderSettings();
alert('Data imported successfully!');
}catch(err){alert('Invalid file format')}
};
reader.readAsText(file);event.target.value='';
}

// ‚ïê‚ïê‚ïê CALORIE TRACKER ‚ïê‚ïê‚ïê
let meals=JSON.parse(localStorage.getItem('todayMeals'))||[];
let calHistory=JSON.parse(localStorage.getItem('calHistory'))||{};
let calSettings=JSON.parse(localStorage.getItem('calSettings'))||{target:2100,max:2300,presets:[{name:'Coffee',cal:50},{name:'Protein Shake',cal:300},{name:'Chicken & Rice',cal:650},{name:'Snack',cal:200}]};
let calMealResetDate=localStorage.getItem('calMealResetDate');

function initCalTracker(){
const today=new Date().toDateString();
if(calMealResetDate!==today){
// Save yesterday's calories to history
if(calMealResetDate&&meals.length>0){
const yISO=new Date(calMealResetDate).toISOString().split('T')[0];
const total=meals.reduce((s,m)=>s+m.cal,0);
calHistory[yISO]={total,meals:meals.length,items:[...meals]};
save('calHistory',calHistory);
}
meals=[];save('todayMeals',meals);
localStorage.setItem('calMealResetDate',today);
}
renderCalTracker();
}

function renderCalTracker(){
const total=meals.reduce((s,m)=>s+m.cal,0);
const target=calSettings.target,max=calSettings.max;
const pct=max>0?Math.min((total/max)*100,110):0;
const idealPct=max>0?Math.min((target/max)*100,100):0;

document.getElementById('ctCurrent').textContent=total.toLocaleString();
document.getElementById('ctTargetLabel').textContent=target.toLocaleString();
document.getElementById('ctMaxLabel').textContent=max.toLocaleString();

// Bar fill
const fill=document.getElementById('ctBarFill');
fill.style.width=Math.min(pct,100)+'%';
fill.className='ct-bar-fill '+(total<=target?'under':total<=max?'ideal':'over');

// Markers
document.getElementById('ctIdealMark').style.left=idealPct+'%';
document.getElementById('ctMaxMark').style.left='calc(100% - 3px)';

// Macros
const remain=target-total;
document.getElementById('ctRemain').textContent=remain>0?remain.toLocaleString():'0';
document.getElementById('ctRemain').style.color=remain>0?'var(--em)':total>max?'var(--rose)':'var(--amber)';
document.getElementById('ctMealCount').textContent=meals.length;
document.getElementById('ctAvgMeal').textContent=meals.length?Math.round(total/meals.length):'‚Äî';

// Toggle text
document.getElementById('ctMealTogText').textContent=(document.getElementById('ctMealList').classList.contains('open')?'Hide':'Show')+' meals ('+meals.length+')';

// Quick add buttons
renderQuickBtns();

// Meal list
renderMealList();
}

function renderQuickBtns(){
const wrap=document.getElementById('ctQuickBtns');wrap.innerHTML='';
calSettings.presets.forEach(p=>{
const btn=document.createElement('button');btn.className='ct-quick';
btn.textContent=p.name+' ('+p.cal+')';
btn.onclick=()=>{meals.push({name:p.name,cal:p.cal,time:new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})});save('todayMeals',meals);saveCalSnapshot();renderCalTracker()};
wrap.appendChild(btn);
});
}

function renderMealList(){
const list=document.getElementById('ctMealList');list.innerHTML='';
if(!meals.length){list.innerHTML='<div style="padding:12px;text-align:center;color:var(--t3);font-size:.85em;font-style:italic">No meals logged yet today</div>';return}
[...meals].reverse().forEach((m,ri)=>{
const i=meals.length-1-ri;
const el=document.createElement('div');el.className='ct-meal';
el.innerHTML='<div class="ct-meal-name">'+escHtml(m.name)+'</div><div class="ct-meal-time">'+m.time+'</div><div class="ct-meal-cal">'+m.cal+' kcal</div><button class="ct-meal-del" onclick="delMeal('+i+')">‚úï</button>';
list.appendChild(el);
});
}

function addMeal(){
const nameInput=document.getElementById('ctMealName');
const calInput=document.getElementById('ctMealCal');
const name=nameInput.value.trim()||'Meal';
const cal=parseInt(calInput.value);
if(!cal||cal<=0)return alert('Enter calories');
meals.push({name,cal,time:new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})});
save('todayMeals',meals);saveCalSnapshot();
nameInput.value='';calInput.value='';
renderCalTracker();
}

function delMeal(idx){
meals.splice(idx,1);save('todayMeals',meals);saveCalSnapshot();renderCalTracker();
}

function toggleMealList(){
document.getElementById('ctMealList').classList.toggle('open');
renderCalTracker();
}

function toggleCtSettings(){switchView('settings')}

function saveCalSnapshot(){
const todayISO=new Date().toISOString().split('T')[0];
const total=meals.reduce((s,m)=>s+m.cal,0);
calHistory[todayISO]={total,meals:meals.length,items:[...meals]};
save('calHistory',calHistory);
}

function updateCalSettings(){
calSettings.target=parseInt(document.getElementById('settCalTarget').value)||2100;
calSettings.max=parseInt(document.getElementById('settCalMax').value)||2300;
const presetsRaw=document.getElementById('settCalPresets').value;
const presets=[];
presetsRaw.split(',').forEach(p=>{
const parts=p.trim().split(':');
if(parts.length===2){const name=parts[0].trim(),cal=parseInt(parts[1]);if(name&&cal>0)presets.push({name,cal})}
});
if(presets.length)calSettings.presets=presets;
save('calSettings',calSettings);
renderCalTracker();
}

function renderCalSettingsFields(){
document.getElementById('settCalTarget').value=calSettings.target;
document.getElementById('settCalMax').value=calSettings.max;
document.getElementById('settCalPresets').value=calSettings.presets.map(p=>p.name+':'+p.cal).join(', ');
}

function renderCalTrends(){
const area=document.getElementById('calTrendArea');
const days=[];const today=new Date();
for(let i=6;i>=0;i--){
const d=new Date(today);d.setDate(today.getDate()-i);
const ds=d.toISOString().split('T')[0];
const h=calHistory[ds];
const label=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
if(i===0){const total=meals.reduce((s,m)=>s+m.cal,0);days.push({date:ds,label,total,meals:meals.length})}
else if(h)days.push({date:ds,label,total:h.total,meals:h.meals});
else days.push({date:ds,label,total:null,meals:0});
}
const tracked=days.filter(d=>d.total!==null);
if(!tracked.length){area.innerHTML='<div class="no-data">Log calories to see trends!</div>';return}
const maxCal=Math.max(...tracked.map(d=>d.total),calSettings.max);
let html='';
days.forEach(d=>{
const pct=d.total!==null&&maxCal>0?Math.round((d.total/maxCal)*100):0;
let col='var(--em)';
if(d.total!==null){if(d.total>calSettings.max)col='var(--rose)';else if(d.total>calSettings.target)col='var(--amber)'}
const valText=d.total!==null?d.total.toLocaleString()+' kcal':'‚Äî';
html+='<div class="bar-row"><div class="bar-label">'+d.label+'</div><div class="bar-track"><div class="bar-fill" style="width:'+pct+'%;background:'+col+'"></div></div><div class="bar-pct" style="color:'+col+'">'+valText+'</div></div>';
});
// Weekly average
const avg=tracked.length?Math.round(tracked.reduce((s,d)=>s+d.total,0)/tracked.length):0;
const diff=avg-calSettings.target;
html+='<div style="display:flex;gap:12px;margin-top:16px">';
html+='<div class="an-box" style="flex:1"><div class="an-val '+(diff<=0?'green':'amber')+'">'+avg.toLocaleString()+'</div><div class="an-lbl">7-day avg</div></div>';
html+='<div class="an-box" style="flex:1"><div class="an-val '+(diff<=0?'green':'amber')+'">'+(diff>0?'+':'')+diff+'</div><div class="an-lbl">vs target</div></div>';
html+='</div>';
area.innerHTML=html;
}

init();
</script>
</body>
</html>
